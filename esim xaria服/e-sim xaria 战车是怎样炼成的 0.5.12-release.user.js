// ==UserScript==
// @name         e-sim xaria 战车是怎样炼成的
// @namespace    ESX
// @version      0.5.12-release
// @description  xaria服自动双击、自动清空体力，自动清空体力功能需要在战场页才能触发
// @author       Exsper
// @match        http://testura.e-sim.org:8000/*
// @match        https://testura.e-sim.org:8000/*
// @match        http://xaria.e-sim.org/*
// @match        https://xaria.e-sim.org/*
// @require      http://cdn.e-sim.org/js/jquery-1.8.3.min.js
// @grant        GM_addStyle
// @run-at       document-start
// ==/UserScript==

//敬请牢记：如果您安装或使用本插件，就默认您已经承诺：不与任何人在任何场合分享插件的全部或部分内容；不在插件开发群以外的地方讨论插件相关问题或功能；在游戏截图前首先关闭所有插件再截图
//敬请牢记：如果您违背了您的承诺，您将失去所有esim插件未来版本的使用权并可能受到诸多方面的惩罚

//前排提醒：该插件有些特殊功能需要先开启e-sim助手（获取盟友、显示伤害），但如果不需要这些功能也可以脱离e-sim助手独立运行
//前排提醒：在自动寻找战场时，插件不会优先选择盟友场或是重要战场，而是寻找到能打的战场就立即跳转

var ak=true;var V=true;var L=true;var H=false;var K=0;var y=0;var x=50;var C=1;var Q=0;var A=0;var j=true;var T=-1;var e=true;var S;var N=true;var v=["China","Taiwan"];var ai=[];var X=true;var F=true;var al=true;var n=true;var h=true;var s="battles.html?countryId=-1&sorting=BY_TOTAL_DAMAGE";var an=true;var b=true;var G=4;var D=600;var c=3000;var O=false;var ae=20;var w=240;var ad=-1;var u=10;var z=50;var W=20;var r=5;var q=0;var p=false;var l=400;var R=800;var E=0;var Z=-1;var m=5*1000;var ac=10000;$.info=function(){var ap,aq,at,av,au,ar,ao;if(arguments.length==1){au=arguments[0];ar=ac}else{if(arguments.length==2){au=arguments[0];ar=arguments[1]}else{return}}ap=$("#ESXMessageDiv");ap.css({display:"block"}).append('<div class="esxmsg">'+au+"</div>");av=ap.children("div");at=av.eq(-1);if(av.length>10){av.eq(0).mouseenter()}ao=at.width();at.css({left:-ao,opacity:0}).animate({left:0,opacity:1},200,function(){return at.delay(ar).animate({left:-ao,opacity:0},200,function(){at.remove()})});return av.eq(-1)};function ag(ap,aq,ao){ap="ESX-"+ap;if(ao===true){localStorage.setItem(ap,JSON.stringify(aq.split(",")))}else{localStorage.setItem(ap,JSON.stringify(aq))}}function B(ap,ao){ap="ESX-"+ap;if(ao===true){return(ap in localStorage)?JSON.parse(localStorage.getItem(ap)).join(","):null}else{return(ap in localStorage)?JSON.parse(localStorage.getItem(ap)):null}}function P(ao,ap){localStorage["ESX-"+ao]=ap}function U(ao){ao="ESX-"+ao;return(ao in localStorage)?localStorage[ao]:null}function ab(ao){ao="ESX-"+ao;localStorage.removeItem(ao)}function am(ap,ao){var aq=U(ap);if(aq==null){return ao}else{if(typeof ao=="string"){return aq}else{if(typeof ao=="number"){return parseInt(aq)}else{if(typeof ao=="boolean"){return(aq=="true")}else{return aq}}}}}f();setTimeout(function(){location.reload()},30*60*1000);function af(ar,ao){var aq=ao-ar;var ap=Math.random()*aq+ar;ap=parseInt(ap,10);return ap}function aa(at){var aq=at.getHours();var ar=at.getMinutes();var ap=at.getSeconds();var ao="";if(aq<10){ao+="0"}ao+=aq+":";if(ar<10){ao+="0"}ao+=ar+":";if(ap<10){ao+="0"}ao+=ap;return(ao)}function g(at){if($("#Eh2Homeland").length>0){v=[];v.push($("#Eh2Homeland").children("div").attr("title"));if(U("EHAllies")=="true"){var ar=$("#Eh2Allies").children("div");for(var aq=0;aq<ar.length;aq++){v.push(ar[aq].title)}}if(U("EHCoalition")=="true"){var ap=$("#Eh2CoalitionMembers").children("div");for(var ao=0;ao<ap.length;ao++){v.push(ap[ao].title)}}v=$.unique(v.sort());ag("Allies",v);at.val(v.join(","));I("获取到盟友："+v)}else{I("e-sim助手未运行或版本不兼容")}}function t(aq){if($("#Eh2Homeland").length>0){ai=[];if(U("EHEnemies")=="true"){var ap=$("#Eh2Enemies").children("div");for(var ao=0;ao<ap.length;ao++){ai.push(ap[ao].title)}}ag("Enemies",ai);aq.val(ai.join(","));I("获取到敌人："+ai)}else{I("e-sim助手未运行或版本不兼容")}}function Y(){ak=am("IsRunning",ak);V=am("EnableWorkTrain",V);L=am("EnableAutoFight",L);H=am("IsWorkingTraining",H);C=am("FlightTicketQuality",C);K=am("ErrorRefreshedCount",K);j=am("BackToRegion",j);T=am("OriginRegionId",T);e=am("BackToBattle",e);S=am("OriginBattleUrl",S);N=am("FightForAlly",N);v=B("Allies");ai=B("Enemies");X=am("EHAllies",X);F=am("EHEnemies",F);al=am("EHCoalition",al);Q=am("FightWeaponQuality",Q);D=am("FightWaitMin",D);c=am("FightWaitMax",c);ae=am("NextRefreshExtendWaitMin",ae);w=am("NextRefreshExtendWaitMax",w);z=am("AFCTiggerProbability",z);W=am("AFCRefreshInTimeLeftMax",W);r=am("AFCRefreshInTimeLeftMin",r);ad=am("AFCTargetBattleID",ad);q=am("AFCFightWeaponQuality",q);p=am("AFCFightByHitOnly",p);l=am("AFCFightWaitMin",l);R=am("AFCFightWaitMax",R);O=am("FightByHitOnly",O);E=am("HitUsingWeapon",E);Z=am("MaxHitUsingWeapon",Z);A=am("FightDefaultSide",A);n=am("AutoSearchBattle",n);s=am("SearchBattleUrl",s);an=am("AutoFlyToBattle",an);b=am("SearchBattleShuffle",b);m=am("AjaxTimeout",m)}function o(){ab("IsRunning");ab("EnableWorkTrain");ab("EnableAutoFight");ab("IsWorkingTraining");ab("FlightTicketQuality");ab("ErrorRefreshedCount");ab("BackToRegion");ab("OriginRegionId");ab("BackToBattle");ab("OriginBattleUrl");ab("FightForAlly");ab("Allies");ab("Enemies");ab("EHAllies");ab("EHEnemies");ab("EHCoalition");ab("FightWeaponQuality");ab("FightWaitMin");ab("FightWaitMax");ab("NextRefreshExtendWaitMin");ab("NextRefreshExtendWaitMax");ab("AFCTiggerProbability");ab("AFCRefreshInTimeLeftMax");ab("AFCRefreshInTimeLeftMin");ab("AFCTargetBattleID");ab("AFCFightWeaponQuality");ab("AFCFightByHitOnly");ab("AFCFightWaitMin");ab("AFCFightWaitMax");ab("FightByHitOnly");ab("HitUsingWeapon");ab("MaxHitUsingWeapon");ab("FightDefaultSide");ab("AutoSearchBattle");ab("SearchBattleUrl");ab("AutoFlyToBattle");ab("SearchBattleShuffle");ab("AjaxTimeout")}function J(){function au(aQ,aP,aL,aM,aK){var aO=$("<input>",{type:"checkbox",style:"vertical-align:5px;",id:aP});var aN=$("<label>",{"class":"checkboxlabel","for":aP,text:aL});var aJ=U(aM);if(aJ===null){P(aM,aK);aO.attr("checked",aK==true)}else{aO.attr("checked",aJ=="true")}aQ.append(aO,aN);aO.click(function(){if(aO.is(":checked")){P(aM,true)}else{P(aM,false)}})}function ap(aO,aS,aP,aJ,aK,aQ){var aM=$("<span>",{style:"padding:3px; margin:3px",text:aS});var aN=$("<select>",{style:"padding:3px; margin:3px"}).appendTo(aM);for(var aL=0;aL<aP.length;aL++){$("<option>",{value:aP[aL],text:aJ[aL]}).appendTo(aN)}var aR=U(aK);if(aR===null){P(aK,aQ);aN.val(aQ)}else{aN.val(aR)}aO.append(aM);aN.change(function(){P(aK,aN.val())})}function ay(aN,aM,aL,aK){var aO=$("<input>",{type:"text",id:"ESX-"+aL,style:"vertical-align:5px;width:"+aM+"px;height:20px;"}).appendTo(aN);var aJ=U(aL);if(aJ===null){P(aL,aK);aO.val(aK)}else{aO.val(aJ)}aN.append(aO);aO.focus(function(){aO.css("background-color","#FFFFFF")});aO.blur(function(){if(aO.val()===""){aO.val(aK)}aO.css("background-color","#79FF79");P(aL,aO.val())})}function aC(aN,aM,aL,aK){var aO=$("<input>",{type:"text",id:"ESX-"+aL,style:"vertical-align:5px;width:"+aM+"px;height:20px;"}).appendTo(aN);var aJ=B(aL,true);if(aJ===null){ag(aL,aK);aO.val(aK.join(","))}else{aO.val(aJ)}aN.append(aO);aO.focus(function(){aO.css("background-color","#FFFFFF")});aO.blur(function(){if(aO.val()===""){aO.val(aK.join(","))}aO.css("background-color","#79FF79");ag(aL,aO.val(),true)})}var av=$("<li>",{id:"ESXIcon"}).insertBefore($("#userAvatar"));var aG=$("<a>",{"data-dropdown":"ESXContentDrop",style:"padding:0 5px;",href:"#"}).appendTo(av);var aI=$("<img>",{align:"absmiddle","class":"smallAvatar",style:"height:36px; width:36px;",src:"http://cdn.e-sim.org/img/eventIcons/battleLostIcon.png"}).appendTo(aG);var az=$("#contentDrop").clone().attr("id","ESXContentDrop").empty().insertBefore($("#contentDrop"));az.removeClass("medium");az.addClass("large");$("<b>",{text:"xaria 战车是怎样炼成的 "+GM_info.script.version}).appendTo(az);var at=$("<span>",{text:"捐赠",style:"float:right;"}).appendTo(az);at.click(function(){aB()});function aB(){var aK=$("<div>",{"class":"dwindow",style:"overflow:auto; width:300px; height:380px; display:block; position:absolute; top:50%; left:50%; margin-left: -225px; margin-top: -150px; padding-bottom: 20px; text-align:center;background-color:lightgray;"}).appendTo($("body"));$("<p>e-sim插件开发不易，您的无私奉献是我们努力的肯定与支持，让我们做得更好</p>").appendTo(aK);$("<p>QQ钱包</p>").appendTo(aK);var aL=$("<div></div>").appendTo(aK);aL[0].innerHTML='<img src="https://puu.sh/Ad7wr/10f301077b.png"/>';$("<br>").appendTo(aK);var aJ=$("<button>",{text:"关闭"}).appendTo(aK);aJ.click(function(){aK.remove()})}$("<div>",{style:"text-align:center;",text:"自动清空体力、自动双击。珍惜账号，慎用自动。设置更改刷新后生效。"}).appendTo(az);var aD=$("<table>",{id:"ESXConfig",style:"width:100%;line-height:30px"}).appendTo(az);var ao=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aD);var ar=$("<td>").appendTo(ao);au(ar,"IsRunCheckbox","启用该插件","IsRunning",ak);au(ar,"EnableWorkTrainCheckbox","启用双击功能","EnableWorkTrain",V);au(ar,"EnableAutoFightCheckbox","启用打枪功能","EnableAutoFight",L);ao=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aD);ar=$("<td>").appendTo(ao);ap(ar,"输出使用武器：",[0,1,2,3,4,5],["拳头","Q1","Q2","Q3","Q4","Q5"],"FightWeaponQuality",Q);au(ar,"FightByHitOnlyCheckbox","不使用连击","FightByHitOnly",O);ap(ar,"超出次数则使用空手：",[-1,0,1,2,3,4,5,6,7,8,9,10],["不限制","0","1","2","3","4","5","6","7","8","9","10"],"MaxHitUsingWeapon",Z);ao=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aD);ar=$("<td>").appendTo(ao);ap(ar,"可以打两边时选择输出方：",[-1,0,1,2,3,4,5],["随机","防守方","进攻方","尽量拿到top1","尽量拿到top3","尽量拿到top10","随机但尽量打在一边"],"FightDefaultSide",A);au(ar,"FightForAllyCheckbox","起义场优先打盟友方或对抗敌方","FightForAlly",N);ao=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aD);ar=$("<td>").appendTo(ao);$("<span>",{text:"设置盟友（以半角逗号分隔）："}).appendTo(ar);aC(ar,400,"Allies",v);ao=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aD);ar=$("<td>").appendTo(ao);$("<span>",{text:"设置敌国（以半角逗号分隔）："}).appendTo(ar);aC(ar,400,"Enemies",ai);ao=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aD);ar=$("<td>").appendTo(ao);var aH=$("<button>",{text:"从E-sim助手获取盟友和敌国"}).appendTo(ar);aH.click(function(){g($("#ESX-Allies"));t($("#ESX-Enemies"))});au(ar,"EHAlliesCheckbox","获取盟友","EHAllies",X);au(ar,"EHCoalitionCheckbox","获取联盟成员国","EHCoalition",al);au(ar,"EHEnemiesCheckbox","获取敌国","EHEnemies",F);ao=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aD);ar=$("<td>").appendTo(ao);ao=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aD);ar=$("<td>").appendTo(ao);$("<span>每次攻击间隔（毫秒）：</span>").appendTo(ar);ay(ar,60,"FightWaitMin",D);$("<span> 到 </span>").appendTo(ar);ay(ar,60,"FightWaitMax",c);$("<span>打枪请求超时限制：</span>").appendTo(ar);ay(ar,60,"AjaxTimeout",m);$("<span>毫秒</span>").appendTo(ar);var ax=$("<button>",{text:"Ping一下"}).appendTo(ar);ax.click(function(){$.ping=function(aM){var aO,aL,aN;var aK=function(aQ){var aP="^((https|http)?://){1}";var aR=new RegExp(aP);return aR.test(aQ)?aQ:"http://"+aQ};$.ajax({url:aM.url,type:"GET",dataType:"html",timeout:10000,beforeSend:function(){if(aM.beforePing){aM.beforePing()}aL=new Date().getTime()},complete:function(){aN=new Date().getTime();aO=Math.abs(aL-aN);if(aM.afterPing){aM.afterPing(aO)}}});if(aM.interval&&aM.interval>0){var aJ=aM.interval*1000;setTimeout(function(){$.ping(aM)},aJ)}};$.ping({url:"http://xaria.e-sim.org",afterPing:function(aJ){I("延迟： "+aJ+" 毫秒")}})});ao=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aD);ar=$("<td>").appendTo(ao);$("<span>清空体力后下次刷新额外延时（秒）：</span>").appendTo(ar);ay(ar,60,"NextRefreshExtendWaitMin",ae);$("<span> 到 </span>").appendTo(ar);ay(ar,60,"NextRefreshExtendWaitMax",w);ao=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aD);ar=$("<td>").appendTo(ao);$("<span>若下次清体时回合剩余时间小于"+u+"分钟，则有</span>").appendTo(ar);ay(ar,20,"AFCTiggerProbability",z);$("<span>%的概率在回合结束前S</span>").appendTo(ar);ay(ar,20,"AFCRefreshInTimeLeftMax",W);$("<span>到S</span>").appendTo(ar);ay(ar,20,"AFCRefreshInTimeLeftMin",r);$("<span>之间（压秒）</span><br/>").appendTo(ar);$("<span>每次攻击间隔（毫秒）：</span>").appendTo(ar);ay(ar,60,"AFCFightWaitMin",l);$("<span> 到 </span>").appendTo(ar);ay(ar,60,"AFCFightWaitMax",R);ap(ar,"使用武器：",[0,1,2,3,4,5],["拳头","Q1","Q2","Q3","Q4","Q5"],"AFCFightWeaponQuality",q);au(ar,"AFCFightByHitOnlyCheckbox","不使用连击","AFCFightByHitOnly",p);$("<br/>").appendTo(ar);var aw=$("<button>",{text:"设置当前战场为重要战场"}).appendTo(ar);aw.click(function(){ad=parseInt($('a[href^="battleStatistics.html?id="]').attr("href").replace("battleStatistics.html?id=",""));P("AFCTargetBattleID",ad);I("设置战场 "+ad+" 为重要战场")});var aq=$("<button>",{text:"清除重要战场"}).appendTo(ar);aq.click(function(){ad=-1;P("AFCTargetBattleID",ad);I("已清除记录的重要战场")});ao=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aD);ar=$("<td>").appendTo(ao);ap(ar,"工作飞行使用机票：",[1,2,3,4,5],["Q1","Q2","Q3","Q4","Q5"],"FlightTicketQuality",C);au(ar,"BackToRegionCheckbox","双击后飞回原所在地（请确保机票足够）","BackToRegion",j);au(ar,"BackToBattleCheckbox","双击后回到原战场","BackToBattle",e);ao=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aD);ar=$("<td>").appendTo(ao);au(ar,"AutoSearchBattleCheckbox","战场页没有输出按钮时自动寻找第一个可输出战场","AutoSearchBattle",n);au(ar,"AutoFlyToBattleCheckbox","如果找不到战场则飞向第一个起义战地区","AutoFlyToBattle",an);ao=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aD);ar=$("<td>").appendTo(ao);au(ar,"SearchBattleShuffleCheckbox","打乱战场列表，以避免总是选择第一个可输出战场","SearchBattleShuffle",b);ao=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aD);ar=$("<td>").appendTo(ao);$("<span>",{text:"搜寻战场列表地址："}).appendTo(ar);ay(ar,400,"SearchBattleUrl",s);ao=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aD);ar=$("<td>").appendTo(ao);var aF=$("<button>",{text:"测试搜寻战场"}).appendTo(ar);aF.click(function(){s=U("SearchBattleUrl");k()});var aE=$("<button>",{text:"重置双击设置",title:"如果因双击错误导致无法自动输出，请点击此按钮"}).appendTo(ar);aE.click(function(){ab("IsWorkingTraining");ab("OriginRegionId");ab("OriginBattleUrl")});var aA=$("<button>",{text:"重置所有设置",title:"插件运行遇到问题？尝试重置插件吧"}).appendTo(ar);aA.click(function(){o()})}function f(){y=parseInt(U("WaitForLoadCount"));if($(".time").length!==2){y++;if(y<=x){P("WaitForLoadCount",y);console.log(y+":网页未加载完全，xaria插件等待1秒");setTimeout(f,1000);return}else{P("WaitForLoadCount",0);location.reload();return}}var ap=$(".time:first").text().match(/-/g);if(ap==null||ap.length!=2){y++;if(y<=x){P("WaitForLoadCount",y);console.log(y+":官方脚本还未执行，xaria插件等待0.5秒");setTimeout(f,500);return}else{P("WaitForLoadCount",0);location.reload();return}}if($("#minutesLimit").text()==""){y++;if(y<=x){console.log(y+":官方时间还未刷新，xaria插件等待0.5秒");setTimeout(f,500);return}else{P("WaitForLoadCount",0);location.reload();return}}P("WaitForLoadCount",0);M();J();Y();if(ak==false){I("xaria插件未启动");return}if(V==true){if((j==true)&&(aj()=="battle")){var aq=$('a[href^="region.html?id="][href!="region.html?id="]');var ao=parseInt(aq.first().attr("href").split("=")[1]);P("OriginRegionId",ao)}if((e==true)&&(aj()=="battle")){P("OriginBattleUrl",location.href)}i()}if((L==true)&&(aj()=="battle")){setTimeout(function(){ah()},2000);return}}function M(){GM_addStyle(".esxmsg{background-color: #fff;border-left: 4px solid #7ad03a;-webkit-box-shadow: 0 1px 1px 0 rgba(0,0,0,.1);}");var ao=$("<div>",{id:"ESXMessageDiv",style:"position:fixed; bottom:5%;"}).appendTo("body")}function I(ao,ap){console.log(ao);if(ap==undefined){$.info(ao)}else{$.info(ao,ap)}}function aj(){if(document.URL.search("html")!=-1){return document.URL.match("/([a-zA-Z0-9]+).html")[1]}else{return"index"}}function i(){function ap(){var aw=$("#trainButton");if(aw.length<=0){V=false;P("EnableWorkTrain",false);H=false;P("IsWorkingTraining",false);alert("错误：未训练却没有训练按钮，已自动关闭双击功能")}else{ax()}function ax(){$.ajax({type:"POST",url:"train/ajax",data:null,success:function(az){var ay=$("#trainButton",az);if((ay.length<1)&&($("#userMenu",az).length<1)){aq()}else{V=false;P("EnableWorkTrain",false);H=false;P("IsWorkingTraining",false);alert("错误：训练失败，已自动关闭双击功能")}$("#trainReload").html(az)}})}}function at(){var az=$("#workButton");if(az.length<1){V=false;P("EnableWorkTrain",false);H=false;P("IsWorkingTraining",false);alert("错误：未工作却没有工作按钮，已自动关闭双击功能")}else{var aA=$('a[href^="region.html?id="][href!="region.html?id="]');var ax=aA.first().parent().find("div").attr("class");ax=ax.substring(ax.indexOf("-")+1);var aw=aA.last().parent().find("div").attr("class");aw=aw.substring(aw.indexOf("-")+1);if(ax==aw){ay()}else{document.location=aA.last().attr("href")}}function ay(){$.ajax({type:"POST",url:"work/ajax?action=work",data:null,success:function(aB){$("#workReload").html(aB);var aC=$("#workButton",aB);if((aC.length<1)&&($("#userMenu",aB).length<1)){document.location="/train.html"}else{V=false;P("EnableWorkTrain",false);H=false;P("IsWorkingTraining",false);alert("错误：工作失败，已自动关闭双击功能")}}})}}function ao(){$("#ticketQuality").val(C);var aw=$(".travel.button.foundation-style");aw[0].click()}function au(){var aw=$(".testDivred");if(aw.length>0){V=false;P("EnableWorkTrain",false);H=false;P("IsWorkingTraining",false);alert("飞行出错："+$(".testDivred :last")[0].childNodes[1].nodeValue+"，已自动关闭双击功能")}else{document.location="/work.html"}}function av(aw){H=true;P("IsWorkingTraining","true");if(aw==true){setTimeout(function(){document.location="/work.html"},30*1000)}else{document.location="/work.html"}}function aq(){H=false;P("IsWorkingTraining","false");if(j==true){var ay=$('a[href^="region.html?id="][href!="region.html?id="]');var aw=parseInt(ay.first().attr("href").split("=")[1]);if((T!=-1)&&(aw!=T)){I("飞回地区："+T);var ax;$.ajax({url:"region.html?id="+T,async:false,success:function(az){ax=parseInt($("#countryId",az).val())},error:function(az,aA){console.log("地区页抓取错误 (",aA,")，重新抓取");$.ajax(this)}});$.ajax({url:"travel.html",type:"POST",async:false,data:{countryId:ax,regionId:T,ticketQuality:C},success:function(az){var aA=$("div.testDivred",az);if(aA.length===1){I("飞行失败："+aA.text().trim())}else{I("飞行成功！")}},error:function(az,aA){console.log("飞行错误 (",aA,")")}})}}if(e==true){I("返回战场："+S);document.location=S}else{if((L==true)&&(n==true)){k()}else{I("双击结束，等待下次双击")}}}function ar(){if(H==false){if(($("#taskButtonWork").length>0)||($("#taskButtonTrain").length>0)){var ay=parseFloat($("#actualHealth").html());var aw=50-C*10;if(j==true){if((ay-aw*2)>=0){av(false);return}else{I("可能由于人工操作，你当前的体力不足以飞行两次，程序将于30秒后再自动双击，请尽快补充体力");av(true);return}}else{if((ay-aw)>=0){av(false);return}else{I("可能由于人工操作，你当前的体力不足以飞行到工作地，程序将于30秒后再自动双击，请尽快补充体力");av(true);return}}}}else{var ax=aj();if(ax=="work"){at()}else{if(ax=="train"){ap()}else{if(ax=="region"){ao()}else{if(ax=="travel"){au()}else{P("IsWorkingTraining",false);return}}}}}}ar()}function d(){if(L==true){L=false;if(K<=0){K++;P("ErrorRefreshedCount",K);location.reload()}else{K++;P("ErrorRefreshedCount",K);var ao=(K-1)*30;I("自动攻击出错，"+ao+"秒后自动刷新",1000000);setTimeout(function(){location.reload()},ao*1000)}}}function k(){function aq(ay){var ax=false;$.ajax({url:ay,async:false,success:function(az){if($(".time",az).length!==2){console.log(citizenId,"抓取错误，重新抓取");$.ajax(this);return}if($(".testDivred",az).length>0){ax=false}else{if($("#fightButton2",az).length>0){ax=true}else{if($("#fightButton1",az).length>0){ax=true}else{ax=false}}}},error:function(az,aA){console.log("抓取错误 (",aA,")，重新抓取");$.ajax(this)}});return ax}function au(az){var ax=false;var ay=0;var aB=0;var aA=$("form[action='travel.html']",az);if(aA.length>0){ay=parseInt(aA.children("#countryId").val());aB=parseInt(aA.children("#regionId").val());if((ay>0)&&(aB>0)){$.ajax({url:"travel.html",type:"POST",async:false,data:{countryId:ay,regionId:aB,ticketQuality:C},success:function(aC){var aD=$("div.testDivred",aC);if(aD.length===1){I("飞行失败："+aD.text().trim())}else{I("飞行成功！");ax=true}},error:function(aC,aD){console.log("飞行错误 (",aD,")")}})}return ax}else{return false}}function av(ay){var ax=false;$.ajax({url:ay,async:false,success:function(az){if($(".time",az).length!==2){console.log(citizenId,"抓取错误，重新抓取");$.ajax(this);return}ax=au(az)},error:function(az,aA){console.log("抓取错误 (",aA,")，重新抓取");$.ajax(this)}});return ax}function ap(aA){for(var ay,ax,az=aA.length;az;ay=parseInt(Math.random()*az),ax=aA[--az],aA[az]=aA[ay],aA[ay]=ax){}return aA}function at(ax){I("寻找战场："+ax);var ay=[];$.ajax({url:ax,async:false,success:function(az){if($(".time",az).length!==2){console.log(citizenId,"抓取错误，重新抓取");$.ajax(this);return}$("#battlesTable tr:gt(0)",az).each(function(aA,aC){var aB=$("a[href*='battle.html']",aC);if(aB==null){return true}ay.push(aB.attr("href"))})},error:function(az,aA){console.log("抓取错误 (",aA,")，重新抓取");$.ajax(this)}});console.log("获取到的战场列表:"+ay);return ay}function aw(){var az;if(($("#taskButtonFight").length>0)&&(h==true)){az=at($("#taskButtonFight").children().attr("href"))}else{az=at(s)}if(b==true){az=ap(az)}for(var ax=0;ax<az.length;ax++){var ay=aq(az[ax]);console.log(az[ax]+":"+ay);if(ay==true){return az[ax]}}return"-1"}function ao(){var az=at(s);if(b==true){az=ap(az)}for(var ax=0;ax<az.length;ax++){var ay=av(az[ax]);console.log(az[ax]+":"+ay);if(ay==true){return az[ax]}}return"-1"}function ar(){var ax=aw();if(ax!="-1"){document.location=ax}else{if(an==false){I("未找到可以打的战场，10分钟后重新寻找");setTimeout(function(){ar()},600*1000)}else{I("未找到可以打的战场，尝试飞行到"+s+"列表里的第一场起义战");ax=ao();if(ax!="-1"){document.location=ax}else{I("未找到可以飞的起义战，10分钟后重新寻找");setTimeout(function(){ar()},600*1000)}}}}if(n==true){I("30秒后开始寻找可以输出的战场");setTimeout(function(){ar()},30*1000)}else{I("该战场当前无法输出")}}function ah(){var ao=0;function au(aL){function aF(aW){aW+="";var aU=aW.split(".");var aV=/(\d{1,3})(?=(\d{3})+$)/g;return aU[0].replace(aV,"$1,")+(aU.length==2?"."+aU[1]:"")}var aS=$("#showMsg");aS.text("");aS.show();var aH=$("#DamageDone",aL);if(aH.length>0){var aQ=parseInt(aH.text().replace(/,/g,"").replace(/\xA0/g,""));var aT=$(".fightsprite",aH.parent().parent());var aM={bomb:["grey","无暴击(pain dealer)"],tank:["grey","无坦克(tank)"],syringe:["grey","无类固醇(steroid)"],airplane:["grey","无地点加成"],bookmark:["grey","无军令加成"]};var aN={absorbed:["loved",["lightgreen","闪避(avoid)"]],mu:["bookmark",["lightgreen","有军令加成"]],location:["airplane",["lightgreen","有地点加成"]],STEROIDSplus:["syringe",["lightgreen","有类固醇(steroid)"]],STEROIDSminus:["syringe",["pink","类固醇副作用(steroid)"]],TANKplus:["tank",["lightgreen","有坦克(tank)"]],TANKminus:["tank",["pink","坦克副作用(tank)"]],xp1:["xp",1],xp5:["xp",5],PAIN_DEALER_1_Hplus:["bomb",["lightgreen","1小时暴击(pain dealer)"]],PAIN_DEALER_10_Hplus:["bomb",["lightgreen","10小时暴击(pain dealer)"]],PAIN_DEALER_25_Hplus:["bomb",["lightgreen","25小时暴击(pain dealer)"]]};for(var aK=0;aK<aT.length;++aK){var aR=aT.eq(aK).attr("class").split(" ").pop();if(aR in aN){var aG=aN[aR];aM[aG[0]]=aG[1]}}var aI="";var aJ=aM.xp;delete aM.xp;for(aK in aM){aI='<i style="color:'+aM[aK][0]+';" class="icon-'+aK+'" title="'+aM[aK][1]+'"></i>'+aI}aI+='<b title="'+aJ+'次攻击">x'+aJ+"</b>";var aE=$("#fightHistory");var aP=$("div[class^=foundation-style]",aE);if(aP.length===6){$("#ehHistoryExpand").show()}aP.slice(0,2).attr("style","opacity:0.6;");aP.slice(2,4).attr("style","opacity:0.3;");if($("#ehHistoryExpand").is(":hidden")===false){aP.slice(4,6).hide()}var aO=($("#fightResult>div").attr("class").split(" ").pop().indexOf("critical")!==-1);if(aO){aE.prepend($("<div>",{"class":"foundation-style small-6 columns foundation-text-right",html:aI}),$("<div>",{"class":"foundation-style small-4 columns foundation-text-right critical",text:aH.text()}))}else{aE.prepend($("<div>",{"class":"foundation-style small-6 columns foundation-text-right",html:aI}),$("<div>",{"class":"foundation-style small-4 columns foundation-text-right",text:aH.text()}))}$("#ehHitsNumber").text(parseInt($("#ehHitsNumber").text())+aJ);$("#ehTotalDamage").text(aF(parseInt($("#ehTotalDamage").text().replace(/,/g,"").replace(/\xA0/g,""))+aQ))}else{aS.text($("#fightResponse").text().trim());aS.fadeOut(2000)}}function aD(){if(Z<0){E++;P("HitUsingWeapon",E);if(Q<=0){return 0}else{var aF=parseInt($("#Q"+Q+"WeaponStock").text());if(aF<=0){return 0}else{return Q}}}else{if(E>=Z){return 0}else{E++;P("HitUsingWeapon",E);if(Q<=0){return 0}else{var aE=parseInt($("#Q"+Q+"WeaponStock").text());if(aE<=0){return 0}else{return Q}}}}}function at(aF,aI){var aE=aD();if(!(aE>=0&&aE<=5)){aE=0}console.log("使用Q"+aE+"，side="+aF+"，value="+aI);var aG="weaponQuality="+aE+"&battleRoundId="+$("#battleRoundId").val()+"&side="+aF+"&value="+aI;var aH=$.ajax({type:"POST",url:"fight.html",timeout:m,data:aG,success:function(aM){$("#fightResponse > div").replaceWith(aM);if($("#showMsg").length>0){au($(aM))}var aL=$("#healthUpdate",aM).text();if(aL!==""){var aJ=aL.substr(0,aL.length-3);if(aJ<100){$("#healthProgress div.ui-corner-right").removeClass("ui-corner-right")}$("#healthProgress .ui-progressbar-value").animate({width:aJ+"%"},{queue:false});$("#healthProgress").attr("title",aJ+" / 100");$("#actualHealth").html(aJ);var aK=$("#DamageDone",aM);if(aK.length<0){console.log($("#fightResponse").text().trim());ao++;if(ao>G){d()}}else{if(ao>0){ao=0}if(K>0){K=0;P("ErrorRefreshedCount",0)}}}else{ao++;I("攻击出错："+$("#fightResponse").text().trim()+"("+ao+")");if(ao>G){d()}}},error:function(aJ,aL,aK){ao++;if(aL=="timeout"){I("攻击出错：超时("+ao+")")}else{I("攻击出错：错误码"+aJ.status+"("+ao+")")}if(ao>G){d()}return false}})}function ay(){var aF=$("#roundCountdown").children().text();var aE=aF.split(":");if(aE.length==3){return(parseInt(aE[0])*3600+parseInt(aE[1])*60+parseInt(aE[2]))}else{return -1}}function ap(aG){if(L==false){I("打枪功能未启用或已暂停");return}var aE;var aH=parseFloat($("#actualHealth").html());if(aH>=10){aE=af(D,c);if((aH>=50)&&(O==false)){at(aG,"Berserk");I(aE+"ms后连击");setTimeout(function(){ap(aG)},aE)}else{at(aG,"undefined");I(aE+"ms后单击");setTimeout(function(){ap(aG)},aE)}}else{P("HitUsingWeapon",0);var aI=parseInt($("#minutesLimit").text().split(":")[0]);var aF=parseInt($("#secondsLimit").text());if((aI<0)||isNaN(aI)){aI=0}if((aF<0)||isNaN(aF)){aF=0}aE=af((aI*60+aF+ae)*1000,(aI*60+aF+w)*1000);I("将于 "+aa(new Date(Date.now()+aE))+" 刷新",1000000);setTimeout(function(){location.reload()},aE)}}function aq(){function aH(aY,aZ){var aX={};var aV=0;var aW=0;var a0;if(aZ==true){a0=$("#topDefender"+aY)}else{a0=$("#topAttacker"+aY)}if((a0.length>0)&&(a0.children().length>0)){aV=a0.children().children('a[href^="profile.html?id="]').attr("href").split("=")[1];aW=parseInt(a0.children().children(".hitInfl").text().replace(/,/g,""))}aX.IsDefender=aZ;aX.Id=aV;aX.Damage=aW;return aX}function aT(aY,aZ){var aX={};var aV=0;var aW=0;var a0;if(aZ==true){a0=$("#top10Defenders"+aY)}else{a0=$("#top10Attackers"+aY)}if((a0.length>0)&&(a0.children().length>0)){aV=a0.children("div").children('a[href^="profile.html?id="]').attr("href").split("=")[1];aW=parseInt(a0.children("div").children(".hitInfl").text().replace(/,/g,""))}aX.IsDefender=aZ;aX.Id=aV;aX.Damage=aW;return aX}function aE(){var aV=af(0,2);if(aV==0){I("随机输出在 防守方");return"defender"}else{I("随机输出在 进攻方");return"attacker"}}function aR(aV,aW){if(aV[0].Damage>aW[0].Damage){I("防守方第一位伤害较少，选择输出在 防守方");return"defender"}else{if(aV[0].Damage<aW[0].Damage){I("进攻方第一位伤害较少，选择输出在 进攻方");return"attacker"}else{I("双方第一位伤害相同或无人输出");return aE()}}}function aO(aV,aW){if(aV[2].Damage>aW[2].Damage){I("防守方第三位伤害较少，选择输出在 防守方");return"defender"}else{if(aV[2].Damage<aW[2].Damage){I("进攻方第三位伤害较少，选择输出在 进攻方");return"attacker"}else{I("双方第三位伤害相同或无人输出");return aR(aV,aW)}}}function aM(aV,aW){if(aV[9].Damage>aW[9].Damage){I("防守方第十位伤害较少，选择输出在 防守方");return"defender"}else{if(aV[9].Damage<aW[9].Damage){I("进攻方第十位伤害较少，选择输出在 进攻方");return"attacker"}else{I("双方第十位伤害相同或无人输出");return aO(aV,aW)}}}var aP;var aS;if($(".xflagsBig").length>0){aP=$(".xflagsBig:first").attr("class").split(" ").pop();aP=aP.substring(aP.indexOf("-")+1);aS=$(".xflagsBig:last").attr("class").split(" ").pop();aS=aS.substring(aS.indexOf("-")+1)}else{if($(".flags-big").length>0){aP=$(".flags-big:first").attr("class").split(" ").pop();aS=$(".flags-big:last").attr("class").split(" ").pop()}else{if($(".muAvatar").length>0){aP=$(".alliesList.leftList.fightFont").text().trim();aS=$(".alliesList.rightList.fightFont").text().trim()}else{aP="未知";aS="未知"}}}I(aP+" vs "+aS);if((N==true)&&($.inArray(aP,ai)>=0)){I(aP+"是敌人，将为"+aS+"输出");return"attacker"}else{if((N==true)&&($.inArray(aS,ai)>=0)){I(aS+"是敌人，将为"+aP+"输出");return"defender"}else{if((N==true)&&($.inArray(aP,v)>=0)){I(aP+"是盟友，将为"+aP+"输出");return"defender"}else{if((N==true)&&($.inArray(aS,v)>=0)){I(aS+"是盟友，将为"+aS+"输出");return"attacker"}else{if(A<0){return aE()}if(A==0){I("设置输出在 防守方");return"defender"}else{if(A==1){I("设置输出在 进攻方");return"attacker"}else{if(A>=2){var aQ=$("#userName").attr("href").split("=")[1];var aN=[];var aL=[];for(var aK=1;aK<=3;aK++){aN.push(aH(aK,false));aL.push(aH(aK,true))}for(var aJ=4;aJ<=10;aJ++){aN.push(aT(aJ,false));aL.push(aT(aJ,true))}var aU=10;var aI=10;for(var aG=0;aG<10;aG++){if(aQ==aN[aG].Id){aI=aG;break}}for(var aF=0;aF<10;aF++){if(aQ==aL[aF].Id){aU=aF;break}}if(aU<aI){I("你在防守方输出为第"+(aU+1)+"位，选择输出在 防守方");return"defender"}else{if(aU>aI){I("你在进攻方输出为第"+(aI+1)+"位，选择输出在 进攻方");return"attacker"}else{if(aU<10){if(aN[aU].Damage<aL[aU].Damage){I("你在双方输出均为第"+(aU+1)+"位，但在防守方伤害较高，选择输出在 防守方");return"defender"}else{if(aN[aU].Damage>aL[aU].Damage){I("你在双方输出均为第"+(aU+1)+"位，但在进攻方伤害较高，选择输出在 防守方");return"attacker"}else{I("你在双方输出均为第"+(aU+1)+"位，且伤害相同");return aE()}}}else{if(A==2){return aR(aN,aL)}else{if(A==3){return aO(aN,aL)}else{if(A==4){return aM(aN,aL)}else{if(A==5){return aE()}else{return aE()}}}}}}}}else{return aE()}}}}}}}}function av(){if(H==true){I("等待跳转到工作页");return}if(aj()=="battle"){ao=0;if($(".testDivred").length>0){I("该战场被冻结");k()}else{if($("#fightButton2").length>0){ap(aq())}else{if($("#fightButton1").length>0){ap("side")}else{k()}}}}else{k()}}if((aj()=="battle")&&(ad==parseInt($('a[href^="battleStatistics.html?id="]').attr("href").replace("battleStatistics.html?id=","")))){if(z>0){var ax=af(0,100);if(z>ax){var aB=ay();var az=parseInt($("#minutesLimit").text().split(":")[0]);var aw=parseInt($("#secondsLimit").text());if((az<0)||isNaN(az)){az=0}if((aw<0)||isNaN(aw)){aw=0}var aA=aB-(az*60+aw);if((aB>0)&&(aA<0)&&(aB<u*60)){Q=q;O=p;D=l;c=R;var ar=af(r,W);var aC=(aB-ar)*1000;I("该场为重要战场，将于 S"+ar+" 压秒",1000000);setTimeout(function(){av()},aC);return}else{I("该场为重要战场，程序将在回合最后"+u+"分钟进行判断");av();return}}else{I("虽然该场为重要战场，但因为概率设置，本次不进行压秒判断");av();return}}else{I("虽然该场为重要战场，但是压秒概率为0，将忽略压秒设置");av();return}}else{av();return}}