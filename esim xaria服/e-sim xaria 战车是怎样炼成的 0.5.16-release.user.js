// ==UserScript==
// @name         e-sim xaria 战车是怎样炼成的
// @namespace    ESX
// @version      0.5.16-release
// @description  xaria服自动双击、自动清空体力，自动清空体力功能需要在战场页才能触发
// @author       Exsper
// @match        http://testura.e-sim.org:8000/*
// @match        https://testura.e-sim.org:8000/*
// @match        http://xaria.e-sim.org/*
// @match        https://xaria.e-sim.org/*
// @match        http://nebula.e-sim.org/*
// @match        https://nebula.e-sim.org/*
// @require      http://cdn.e-sim.org/js/jquery-1.8.3.min.js
// @grant        GM_addStyle
// @run-at       document-start
// ==/UserScript==

//敬请牢记：如果您安装或使用本插件，就默认您已经承诺：不与任何人在任何场合分享插件的全部或部分内容；不在插件开发群以外的地方讨论插件相关问题或功能；在游戏截图前首先关闭所有插件再截图
//敬请牢记：如果您违背了您的承诺，您将失去所有esim插件未来版本的使用权并可能受到诸多方面的惩罚

//前排提醒：该插件有些特殊功能需要先开启e-sim助手（获取盟友、显示伤害），但如果不需要这些功能也可以脱离e-sim助手独立运行
//前排提醒：在自动寻找战场时，插件不会优先选择盟友场或是重要战场，而是寻找到能打的战场就立即跳转


var ao=true;var X=true;var N=true;var J=false;var M=0;var z=0;var y=50;var E=1;var S=0;var C=0;var k=true;var V=-1;var e=true;var U;var P=true;var w=["China","Taiwan"];var al=[];var Z=true;var H=true;var ap=true;var o=true;var i=true;var t="battles.html?countryId=-1&sorting=BY_TOTAL_DAMAGE";var at=true;var b=true;var an=true;var ae=true;var I=4;var F=600;var c=3000;var Q=false;var ah=20;var x=240;var h=20;var A=-1;var ag=-1;var v=10;var B=50;var Y=20;var s=5;var r=0;var q=false;var m=400;var T=800;var ar=10*60;var G=0;var ab=-1;var n=5*1000;var af=10000;$.info=function(){var av,aw,ay,aA,az,ax,au;if(arguments.length==1){az=arguments[0];ax=af}else{if(arguments.length==2){az=arguments[0];ax=arguments[1]}else{return}}av=$("#ESXMessageDiv");av.css({display:"block"}).append('<div class="esxmsg">'+az+"</div>");aA=av.children("div");ay=aA.eq(-1);if(aA.length>10){aA.eq(0).mouseenter()}au=ay.width();ay.css({left:-au,opacity:0}).animate({left:0,opacity:1},200,function(){return ay.delay(ax).animate({left:-au,opacity:0},200,function(){ay.remove()})});return aA.eq(-1)};function aj(av,aw,au){av="ESX-"+av;if(au===true){localStorage.setItem(av,JSON.stringify(aw.split(",")))}else{localStorage.setItem(av,JSON.stringify(aw))}}function D(av,au){av="ESX-"+av;if(au===true){return(av in localStorage)?JSON.parse(localStorage.getItem(av)).join(","):null}else{return(av in localStorage)?JSON.parse(localStorage.getItem(av)):null}}function R(au,av){localStorage["ESX-"+au]=av}function W(au){au="ESX-"+au;return(au in localStorage)?localStorage[au]:null}function ad(au){au="ESX-"+au;localStorage.removeItem(au)}function aq(av,au){var aw=W(av);if(aw==null){return au}else{if(typeof au=="string"){return aw}else{if(typeof au=="number"){return parseInt(aw)}else{if(typeof au=="boolean"){return(aw=="true")}else{return aw}}}}}f();setTimeout(function(){location.reload()},30*60*1000);function ai(ax,au){var aw=au-ax;var av=Math.random()*aw+ax;av=parseInt(av,10);return av}function ac(ay){var aw=ay.getHours();var ax=ay.getMinutes();var av=ay.getSeconds();var au="";if(aw<10){au+="0"}au+=aw+":";if(ax<10){au+="0"}au+=ax+":";if(av<10){au+="0"}au+=av;return(au)}function g(ay){if($("#Eh2Homeland").length>0){w=[];w.push($("#Eh2Homeland").children("div").attr("title"));if(W("EHAllies")=="true"){var ax=$("#Eh2Allies").children("div");for(var aw=0;aw<ax.length;aw++){w.push(ax[aw].title)}}if(W("EHCoalition")=="true"){var av=$("#Eh2CoalitionMembers").children("div");for(var au=0;au<av.length;au++){w.push(av[au].title)}}w=$.unique(w.sort());aj("Allies",w);ay.val(w.join(","));K("获取到盟友："+w)}else{K("e-sim助手未运行或版本不兼容")}}function u(aw){if($("#Eh2Homeland").length>0){al=[];if(W("EHEnemies")=="true"){var av=$("#Eh2Enemies").children("div");for(var au=0;au<av.length;au++){al.push(av[au].title)}}aj("Enemies",al);aw.val(al.join(","));K("获取到敌人："+al)}else{K("e-sim助手未运行或版本不兼容")}}function aa(){ao=aq("IsRunning",ao);X=aq("EnableWorkTrain",X);N=aq("EnableAutoFight",N);J=aq("IsWorkingTraining",J);E=aq("FlightTicketQuality",E);M=aq("ErrorRefreshedCount",M);k=aq("BackToRegion",k);V=aq("OriginRegionId",V);e=aq("BackToBattle",e);U=aq("OriginBattleUrl",U);P=aq("FightForAlly",P);w=D("Allies");al=D("Enemies");Z=aq("EHAllies",Z);H=aq("EHEnemies",H);ap=aq("EHCoalition",ap);S=aq("FightWeaponQuality",S);F=aq("FightWaitMin",F);c=aq("FightWaitMax",c);ah=aq("NextRefreshExtendWaitMin",ah);x=aq("NextRefreshExtendWaitMax",x);h=aq("SleepProbability",h);A=aq("CancelDateTime",A);B=aq("AFCTiggerProbability",B);Y=aq("AFCRefreshInTimeLeftMax",Y);s=aq("AFCRefreshInTimeLeftMin",s);ag=aq("AFCTargetBattleID",ag);r=aq("AFCFightWeaponQuality",r);q=aq("AFCFightByHitOnly",q);m=aq("AFCFightWaitMin",m);T=aq("AFCFightWaitMax",T);Q=aq("FightByHitOnly",Q);G=aq("HitUsingWeapon",G);ab=aq("MaxHitUsingWeapon",ab);C=aq("FightDefaultSide",C);o=aq("AutoSearchBattle",o);i=aq("SearchBattleFromButton",i);t=aq("SearchBattleUrl",t);at=aq("AutoFlyToBattle",at);b=aq("SearchBattleShuffle",b);n=aq("AjaxTimeout",n)}function p(){ad("IsRunning");ad("EnableWorkTrain");ad("EnableAutoFight");ad("IsWorkingTraining");ad("FlightTicketQuality");ad("ErrorRefreshedCount");ad("BackToRegion");ad("OriginRegionId");ad("BackToBattle");ad("OriginBattleUrl");ad("FightForAlly");ad("Allies");ad("Enemies");ad("EHAllies");ad("EHEnemies");ad("EHCoalition");ad("FightWeaponQuality");ad("FightWaitMin");ad("FightWaitMax");ad("NextRefreshExtendWaitMin");ad("NextRefreshExtendWaitMax");ad("SleepProbability");ad("CancelDateTime");ad("AFCTiggerProbability");ad("AFCRefreshInTimeLeftMax");ad("AFCRefreshInTimeLeftMin");ad("AFCTargetBattleID");ad("AFCFightWeaponQuality");ad("AFCFightByHitOnly");ad("AFCFightWaitMin");ad("AFCFightWaitMax");ad("FightByHitOnly");ad("HitUsingWeapon");ad("MaxHitUsingWeapon");ad("FightDefaultSide");ad("AutoSearchBattle");ad("SearchBattleFromButton");ad("SearchBattleUrl");ad("AutoFlyToBattle");ad("SearchBattleShuffle");ad("AjaxTimeout")}function L(){function aB(aY,aX,aT,aU,aS){var aW=$("<input>",{type:"checkbox",style:"vertical-align:5px;",id:aX});var aV=$("<label>",{"class":"checkboxlabel","for":aX,text:aT});var aR=W(aU);if(aR===null){R(aU,aS);aW.attr("checked",aS==true)}else{aW.attr("checked",aR=="true")}aY.append(aW,aV);aW.click(function(){if(aW.is(":checked")){R(aU,true)}else{R(aU,false)}})}function aw(aW,a0,aX,aR,aS,aY){var aU=$("<span>",{style:"padding:3px; margin:3px",text:a0});var aV=$("<select>",{style:"padding:3px; margin:3px"}).appendTo(aU);for(var aT=0;aT<aX.length;aT++){$("<option>",{value:aX[aT],text:aR[aT]}).appendTo(aV)}var aZ=W(aS);if(aZ===null){R(aS,aY);aV.val(aY)}else{aV.val(aZ)}aW.append(aU);aV.change(function(){R(aS,aV.val())})}function aF(aV,aU,aT,aS){var aW=$("<input>",{type:"text",id:"ESX-"+aT,style:"vertical-align:5px;width:"+aU+"px;height:20px;"}).appendTo(aV);var aR=W(aT);if(aR===null){R(aT,aS);aW.val(aS)}else{aW.val(aR)}aV.append(aW);aW.focus(function(){aW.css("background-color","#FFFFFF")});aW.blur(function(){if(aW.val()===""){aW.val(aS)}aW.css("background-color","#79FF79");R(aT,aW.val())})}function aJ(aV,aU,aT,aS){var aW=$("<input>",{type:"text",id:"ESX-"+aT,style:"vertical-align:5px;width:"+aU+"px;height:20px;"}).appendTo(aV);var aR=D(aT,true);if(aR===null){aj(aT,aS);aW.val(aS.join(","))}else{aW.val(aR)}aV.append(aW);aW.focus(function(){aW.css("background-color","#FFFFFF")});aW.blur(function(){if(aW.val()===""){aW.val(aS.join(","))}aW.css("background-color","#79FF79");aj(aT,aW.val(),true)})}var aC=$("<li>",{id:"ESXIcon"}).insertBefore($("#userAvatar"));var aO=$("<a>",{"data-dropdown":"ESXContentDrop",style:"padding:0 5px;",href:"#"}).appendTo(aC);var aQ=$("<img>",{align:"absmiddle","class":"smallAvatar",style:"height:36px; width:36px;",src:"http://cdn.e-sim.org/img/eventIcons/battleLostIcon.png"}).appendTo(aO);var aG=$("#contentDrop").clone().attr("id","ESXContentDrop").empty().insertBefore($("#contentDrop"));aG.removeClass("medium");aG.addClass("large");$("<b>",{text:"xaria 战车是怎样炼成的 "+GM_info.script.version}).appendTo(aG);var aA=$("<span>",{text:"捐赠",style:"float:right;"}).appendTo(aG);aA.click(function(){aI()});function aI(){var aS=$("<div>",{"class":"dwindow",style:"overflow:auto; width:300px; height:380px; display:block; position:fixed; top:50%; left:50%; margin-left: -225px; margin-top: -150px; padding-bottom: 20px; text-align:center;background-color:lightgray;"}).appendTo($("body"));$("<p>e-sim插件开发不易，您的无私奉献是我们努力的肯定与支持，让我们做得更好</p>").appendTo(aS);$("<p>QQ钱包</p>").appendTo(aS);var aT=$("<div></div>").appendTo(aS);aT[0].innerHTML='<img src="https://puu.sh/Ad7wr/10f301077b.png"/>';$("<br>").appendTo(aS);var aR=$("<button>",{text:"关闭"}).appendTo(aS);aR.click(function(){aS.remove()})}$("<div>",{style:"text-align:center;",text:"自动清空体力、自动双击。珍惜账号，慎用自动。设置更改刷新后生效。"}).appendTo(aG);var aL=$("<div>",{style:"height:500px; overflow:auto;"}).appendTo(aG);var aK=$("<table>",{id:"ESXConfig",style:"width:100%;line-height:30px"}).appendTo(aL);var av=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aK);var az=$("<td>").appendTo(av);aB(az,"IsRunCheckbox","启用该插件","IsRunning",ao);aB(az,"EnableWorkTrainCheckbox","启用双击功能","EnableWorkTrain",X);aB(az,"EnableAutoFightCheckbox","启用打枪功能","EnableAutoFight",N);av=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aK);az=$("<td>").appendTo(av);aw(az,"输出使用武器：",[0,1,2,3,4,5],["拳头","Q1","Q2","Q3","Q4","Q5"],"FightWeaponQuality",S);aB(az,"FightByHitOnlyCheckbox","不使用连击","FightByHitOnly",Q);aw(az,"超出次数则使用空手：",[-1,0,1,2,3,4,5,6,7,8,9,10],["不限制","0","1","2","3","4","5","6","7","8","9","10"],"MaxHitUsingWeapon",ab);av=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aK);az=$("<td>").appendTo(av);aw(az,"可以打两边时选择输出方：",[-1,0,1,2,3,4,5,6],["随机","防守方","进攻方","尽量拿到top1","尽量拿到top3","尽量拿到top10","随机但尽量打在一边","打在胜场较少的那一边"],"FightDefaultSide",C);aB(az,"FightForAllyCheckbox","起义场优先打盟友方或对抗敌方","FightForAlly",P);av=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aK);az=$("<td>").appendTo(av);$("<span>",{text:"设置盟友（以半角逗号分隔）："}).appendTo(az);aJ(az,400,"Allies",w);av=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aK);az=$("<td>").appendTo(av);$("<span>",{text:"设置敌国（以半角逗号分隔）："}).appendTo(az);aJ(az,400,"Enemies",al);av=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aK);az=$("<td>").appendTo(av);var aP=$("<button>",{text:"从E-sim助手获取盟友和敌国"}).appendTo(az);aP.click(function(){g($("#ESX-Allies"));u($("#ESX-Enemies"))});aB(az,"EHAlliesCheckbox","获取盟友","EHAllies",Z);aB(az,"EHCoalitionCheckbox","获取联盟成员国","EHCoalition",ap);aB(az,"EHEnemiesCheckbox","获取敌国","EHEnemies",H);av=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aK);az=$("<td>").appendTo(av);$("<span>每次攻击间隔（毫秒）：</span>").appendTo(az);aF(az,60,"FightWaitMin",F);$("<span> 到 </span>").appendTo(az);aF(az,60,"FightWaitMax",c);$("<span>打枪请求超时限制：</span>").appendTo(az);aF(az,60,"AjaxTimeout",n);$("<span>毫秒</span>").appendTo(az);var aE=$("<button>",{text:"Ping一下"}).appendTo(az);aE.click(function(){$.ping=function(aT){var aV,aS,aU;$.ajax({url:aT.url,type:"GET",dataType:"html",timeout:20000,beforeSend:function(){if(aT.beforePing){aT.beforePing()}aS=new Date().getTime()},complete:function(){aU=new Date().getTime();aV=Math.abs(aS-aU);if(aT.afterPing){aT.afterPing(aV)}},error:function(aW,aY,aX){if(aY=="timeout"){K("Ping超时")}aU=new Date().getTime();aV=Math.abs(aS-aU);if(aT.afterPing){aT.afterPing(aV)}}});if(aT.interval&&aT.interval>0){var aR=aT.interval*1000;setTimeout(function(){$.ping(aT)},aR)}};$.ping({url:location.origin,afterPing:function(aR){K("延迟： "+aR+" 毫秒")}})});av=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aK);az=$("<td>").appendTo(av);$("<span>清空体力后下次刷新额外延时（秒）：</span>").appendTo(az);aF(az,60,"NextRefreshExtendWaitMin",ah);$("<span> 到 </span>").appendTo(az);aF(az,60,"NextRefreshExtendWaitMax",x);av=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aK);az=$("<td>").appendTo(av);$("<span>每次刷新后均有</span>").appendTo(az);aF(az,60,"SleepProbability",h);$("<span>%的概率不进行自动清体</span>").appendTo(az);av=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aK);az=$("<td>").appendTo(av);$("<span>于</span>").appendTo(az);aF(az,60,"CancelDateTimeTextbox",60);$("<span>分钟后停止自动清体功能</span>").appendTo(az);var au=$("<button>",{text:"设置"}).appendTo(az);au.click(function(){A=Date.now()+parseInt($("#ESX-CancelDateTimeTextbox").val())*60*1000;R("CancelDateTime",A);K("设置在"+ac(new Date(A))+"停止自动清体功能")});var ax=$("<button>",{text:"清除"}).appendTo(az);ax.click(function(){A=-1;R("CancelDateTime",A);K("已清除设定的停止清体时间")});av=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aK);az=$("<td>").appendTo(av);$("<span>重要战场回合剩余时间小于"+v+"分钟，则有</span>").appendTo(az);aF(az,20,"AFCTiggerProbability",B);$("<span>%的概率在回合结束前S</span>").appendTo(az);aF(az,20,"AFCRefreshInTimeLeftMax",Y);$("<span>到S</span>").appendTo(az);aF(az,20,"AFCRefreshInTimeLeftMin",s);$("<span>之间（压秒）</span><br/>").appendTo(az);$("<span>每次攻击间隔（毫秒）：</span>").appendTo(az);aF(az,60,"AFCFightWaitMin",m);$("<span> 到 </span>").appendTo(az);aF(az,60,"AFCFightWaitMax",T);aw(az,"使用武器：",[0,1,2,3,4,5],["拳头","Q1","Q2","Q3","Q4","Q5"],"AFCFightWeaponQuality",r);aB(az,"AFCFightByHitOnlyCheckbox","不使用连击","AFCFightByHitOnly",q);$("<br/>").appendTo(az);var aD=$("<button>",{text:"设置当前战场为重要战场"}).appendTo(az);aD.click(function(){ag=parseInt($('a[href^="battleStatistics.html?id="]').attr("href").replace("battleStatistics.html?id=",""));R("AFCTargetBattleID",ag);K("设置战场 "+ag+" 为重要战场")});var ay=$("<button>",{text:"清除重要战场"}).appendTo(az);ay.click(function(){ag=-1;R("AFCTargetBattleID",ag);K("已清除记录的重要战场")});av=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aK);az=$("<td>").appendTo(av);aw(az,"工作飞行使用机票：",[1,2,3,4,5],["Q1","Q2","Q3","Q4","Q5"],"FlightTicketQuality",E);aB(az,"BackToRegionCheckbox","双击后飞回原所在地（请确保机票足够）","BackToRegion",k);aB(az,"BackToBattleCheckbox","双击后回到原战场","BackToBattle",e);av=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aK);az=$("<td>").appendTo(av);aB(az,"AutoSearchBattleCheckbox","战场页没有输出按钮时自动寻找第一个可输出战场","AutoSearchBattle",o);aB(az,"AutoFlyToBattleCheckbox","如果找不到战场则飞向第一个起义战地区","AutoFlyToBattle",at);av=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aK);az=$("<td>").appendTo(av);aB(az,"SearchBattleShuffleCheckbox","打乱战场列表，以避免总是选择第一个可输出战场","SearchBattleShuffle",b);av=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aK);az=$("<td>").appendTo(av);$("<span>",{text:"搜寻战场列表地址："}).appendTo(az);aF(az,400,"SearchBattleUrl",t);av=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aK);az=$("<td>").appendTo(av);aB(az,"SearchBattleFromButtonCheckbox","优先从左侧按钮获取战场列表网址","SearchBattleFromButton",i);var aN=$("<button>",{text:"测试搜寻战场"}).appendTo(az);aN.click(function(){t=W("SearchBattleUrl");l(1)});var aM=$("<button>",{text:"重置双击设置",title:"如果因双击错误导致无法自动输出，请点击此按钮"}).appendTo(az);aM.click(function(){ad("IsWorkingTraining");ad("OriginRegionId");ad("OriginBattleUrl")});var aH=$("<button>",{text:"重置所有设置",title:"插件运行遇到问题？尝试重置插件吧"}).appendTo(az);aH.click(function(){p()})}function f(){z=parseInt(W("WaitForLoadCount"));if($(".time").length!==2){z++;if(z<=y){R("WaitForLoadCount",z);console.log(z+":网页未加载完全，xaria插件等待1秒");setTimeout(f,1000);return}else{R("WaitForLoadCount",0);location.reload();return}}var av=$(".time:first").text().match(/-/g);if(av==null||av.length!=2){z++;if(z<=y){R("WaitForLoadCount",z);console.log(z+":官方脚本还未执行，xaria插件等待0.5秒");setTimeout(f,500);return}else{R("WaitForLoadCount",0);location.reload();return}}if($("#minutesLimit").text()==""){z++;if(z<=y){console.log(z+":官方时间还未刷新，xaria插件等待0.5秒");setTimeout(f,500);return}else{R("WaitForLoadCount",0);location.reload();return}}R("WaitForLoadCount",0);O();L();aa();if(ao==false){K("xaria插件未启动");return}if(X==true){if((k==true)&&(am()=="battle")){var aw=$('a[href^="region.html?id="][href!="region.html?id="]');var au=parseInt(aw.first().attr("href").split("=")[1]);R("OriginRegionId",au)}if((e==true)&&(am()=="battle")){R("OriginBattleUrl",location.href)}j()}if((N==true)&&(am()=="battle")){setTimeout(function(){ak()},2000);return}}function O(){GM_addStyle(".esxmsg{background-color: #fff;border-left: 4px solid #7ad03a;-webkit-box-shadow: 0 1px 1px 0 rgba(0,0,0,.1);}");var au=$("<div>",{id:"ESXMessageDiv",style:"position:fixed; bottom:5%;"}).appendTo("body")}function K(au,av){console.log(au);if(av==undefined){$.info(au)}else{$.info(au,av)}}function am(){if(document.URL.search("html")!=-1){return document.URL.match("/([a-zA-Z0-9]+).html")[1]}else{return"index"}}function j(){function av(){var aB=$("#trainButton");if(aB.length<=0){X=false;R("EnableWorkTrain",false);J=false;R("IsWorkingTraining",false);alert("错误：未训练却没有训练按钮，已自动关闭双击功能")}else{aC()}function aC(){$.ajax({type:"POST",url:"train/ajax",data:null,success:function(aE){var aD=$("#trainButton",aE);if((aD.length<1)&&($("#userMenu",aE).length<1)){aw()}else{X=false;R("EnableWorkTrain",false);J=false;R("IsWorkingTraining",false);alert("错误：训练失败，已自动关闭双击功能")}$("#trainReload").html(aE)}})}}function ay(){var aE=$("#workButton");if(aE.length<1){X=false;R("EnableWorkTrain",false);J=false;R("IsWorkingTraining",false);alert("错误：未工作却没有工作按钮，已自动关闭双击功能")}else{var aF=$('a[href^="region.html?id="][href!="region.html?id="]');var aC=aF.first().parent().find("div").attr("class");aC=aC.substring(aC.indexOf("-")+1);var aB=aF.last().parent().find("div").attr("class");aB=aB.substring(aB.indexOf("-")+1);if(aC==aB){aD()}else{document.location=aF.last().attr("href")}}function aD(){$.ajax({type:"POST",url:"work/ajax?action=work",data:null,success:function(aG){$("#workReload").html(aG);var aH=$("#workButton",aG);if((aH.length<1)&&($("#userMenu",aG).length<1)){document.location="/train.html"}else{X=false;R("EnableWorkTrain",false);J=false;R("IsWorkingTraining",false);alert("错误：工作失败，已自动关闭双击功能")}}})}}function au(){$("#ticketQuality").val(E);var aB=$(".travel.button.foundation-style");aB[0].click()}function az(){var aB=$(".testDivred");if(aB.length>0){X=false;R("EnableWorkTrain",false);J=false;R("IsWorkingTraining",false);alert("飞行出错："+$(".testDivred :last")[0].childNodes[1].nodeValue+"，已自动关闭双击功能")}else{document.location="/work.html"}}function aA(aB){J=true;R("IsWorkingTraining","true");if(aB==true){setTimeout(function(){document.location="/work.html"},30*1000)}else{document.location="/work.html"}}function aw(){J=false;R("IsWorkingTraining","false");if(k==true){var aD=$('a[href^="region.html?id="][href!="region.html?id="]');var aB=parseInt(aD.first().attr("href").split("=")[1]);if((V!=-1)&&(aB!=V)){K("飞回地区："+V);var aC;$.ajax({url:"region.html?id="+V,async:false,success:function(aE){aC=parseInt($("#countryId",aE).val())},error:function(aE,aF){console.log("地区页抓取错误 (",aF,")，重新抓取");$.ajax(this)}});$.ajax({url:"travel.html",type:"POST",async:false,data:{countryId:aC,regionId:V,ticketQuality:E},success:function(aE){var aF=$("div.testDivred",aE);if(aF.length===1){K("飞行失败："+aF.text().trim())}else{K("飞行成功！")}},error:function(aE,aF){console.log("飞行错误 (",aF,")")}})}}if(e==true){K("返回战场："+U);document.location=U}else{if((N==true)&&(o==true)){l()}else{K("双击结束，等待下次双击")}}}function ax(){if(J==false){if(($("#taskButtonWork").length>0)||($("#taskButtonTrain").length>0)){var aD=parseFloat($("#actualHealth").html());var aB=50-E*10;if(k==true){if((aD-aB*2)>=0){aA(false);return}else{K("可能由于人工操作，你当前的体力不足以飞行两次，程序将于30秒后再自动双击，请尽快补充体力");aA(true);return}}else{if((aD-aB)>=0){aA(false);return}else{K("可能由于人工操作，你当前的体力不足以飞行到工作地，程序将于30秒后再自动双击，请尽快补充体力");aA(true);return}}}}else{var aC=am();if(aC=="work"){ay()}else{if(aC=="train"){av()}else{if(aC=="region"){au()}else{if(aC=="travel"){az()}else{R("IsWorkingTraining",false);return}}}}}}ax()}function d(){if(N==true){N=false;if(M<=0){M++;R("ErrorRefreshedCount",M);location.reload()}else{M++;R("ErrorRefreshedCount",M);var au=(M-1)*30;K("自动攻击出错，"+au+"秒后自动刷新",1000000);setTimeout(function(){location.reload()},au*1000)}}}function l(){function ay(aE){var aD=false;$.ajax({url:aE,async:false,success:function(aF){if($(".time",aF).length!==2){console.log(citizenId,"抓取错误，重新抓取");$.ajax(this);return}if($(".testDivred",aF).length>0){aD=false}else{if($("#fightButton2",aF).length>0){if(ae==true){aD=true}else{aD=false}}else{if($("#fightButton1",aF).length>0){if(an==true){aD=true}else{aD=false}}else{aD=false}}}},error:function(aF,aG){console.log("抓取错误 (",aG,")，重新抓取");$.ajax(this)}});return aD}function aC(aF){var aD=false;var aE=0;var aH=0;var aG=$("form[action='travel.html']",aF);if(aG.length>0){aE=parseInt(aG.children("#countryId").val());aH=parseInt(aG.children("#regionId").val());if((aE>0)&&(aH>0)){$.ajax({url:"travel.html",type:"POST",async:false,data:{countryId:aE,regionId:aH,ticketQuality:E},success:function(aI){var aJ=$("div.testDivred",aI);if(aJ.length===1){K("飞行失败："+aJ.text().trim())}else{K("飞行成功！");aD=true}},error:function(aI,aJ){console.log("飞行错误 (",aJ,")")}})}return aD}else{return false}}function aB(aE){var aD=false;$.ajax({url:aE,async:false,success:function(aF){if($(".time",aF).length!==2){console.log(citizenId,"抓取错误，重新抓取");$.ajax(this);return}aD=aC(aF)},error:function(aF,aG){console.log("抓取错误 (",aG,")，重新抓取");$.ajax(this)}});return aD}function aw(aG){for(var aE,aD,aF=aG.length;aF;aE=parseInt(Math.random()*aF),aD=aG[--aF],aG[aF]=aG[aE],aG[aE]=aD){}return aG}function av(aD){K("寻找战场："+aD);var aE=[];$.ajax({url:aD,async:false,success:function(aF){if($(".time",aF).length!==2){console.log(citizenId,"抓取错误，重新抓取");$.ajax(this);return}$("#battlesTable tr:gt(0)",aF).each(function(aG,aI){var aH=$("a[href*='battle.html']",aI);if(aH==null){return true}aE.push(aH.attr("href"))})},error:function(aF,aG){console.log("抓取错误 (",aG,")，重新抓取");$.ajax(this)}});console.log("获取到的战场列表:"+aE);return aE}function au(){var aF;if(($("#taskButtonFight").length>0)&&(i==true)){console.log("从左侧按钮获取战场列表");aF=av($("#taskButtonFight").children().attr("href"))}else{console.log("从自定义网址获取战场列表");aF=av(t)}if(b==true){aF=aw(aF)}for(var aD=0;aD<aF.length;aD++){var aE=ay(aF[aD]);console.log(aF[aD]+":"+aE);if(aE==true){return aF[aD]}}return"-1"}function ax(){var aF=av(t);if(b==true){aF=aw(aF)}for(var aD=0;aD<aF.length;aD++){var aE=aB(aF[aD]);console.log(aF[aD]+":"+aE);if(aE==true){return aF[aD]}}return"-1"}function aA(){var aD=au();if(aD!="-1"){document.location=aD}else{if(at==false){K("未找到可以打的战场，"+(ar/60)+"分钟后重新寻找");setTimeout(function(){aA()},ar*1000)}else{K("未找到可以打的战场，尝试飞行到"+t+"列表里的第一场起义战");aD=ax();if(aD!="-1"){document.location=aD}else{K("未找到可以飞的起义战，"+(ar/60)+"分钟后重新寻找");setTimeout(function(){aA()},ar*1000)}}}}if(o==true){if(arguments.length>=1){var az=arguments[0];K(az+"秒后开始寻找可以输出的战场");setTimeout(function(){aA()},az*1000)}else{K("30秒后开始寻找可以输出的战场");setTimeout(function(){aA()},30*1000)}}else{K("寻找战场功能已关闭")}}function ak(){var au=0;function aA(aS){function aM(a3){a3+="";var a1=a3.split(".");var a2=/(\d{1,3})(?=(\d{3})+$)/g;return a1[0].replace(a2,"$1,")+(a1.length==2?"."+a1[1]:"")}var aZ=$("#showMsg");aZ.text("");aZ.show();var aO=$("#DamageDone",aS);if(aO.length>0){var aX=parseInt(aO.text().replace(/,/g,"").replace(/\xA0/g,""));var a0=$(".fightsprite",aO.parent().parent());var aT={bomb:["grey","无暴击(pain dealer)"],tank:["grey","无坦克(tank)"],syringe:["grey","无类固醇(steroid)"],airplane:["grey","无地点加成"],bookmark:["grey","无军令加成"]};var aU={absorbed:["loved",["lightgreen","闪避(avoid)"]],mu:["bookmark",["lightgreen","有军令加成"]],location:["airplane",["lightgreen","有地点加成"]],STEROIDSplus:["syringe",["lightgreen","有类固醇(steroid)"]],STEROIDSminus:["syringe",["pink","类固醇副作用(steroid)"]],TANKplus:["tank",["lightgreen","有坦克(tank)"]],TANKminus:["tank",["pink","坦克副作用(tank)"]],xp1:["xp",1],xp5:["xp",5],PAIN_DEALER_1_Hplus:["bomb",["lightgreen","1小时暴击(pain dealer)"]],PAIN_DEALER_10_Hplus:["bomb",["lightgreen","10小时暴击(pain dealer)"]],PAIN_DEALER_25_Hplus:["bomb",["lightgreen","25小时暴击(pain dealer)"]]};for(var aR=0;aR<a0.length;++aR){var aY=a0.eq(aR).attr("class").split(" ").pop();if(aY in aU){var aN=aU[aY];aT[aN[0]]=aN[1]}}var aP="";var aQ=aT.xp;delete aT.xp;for(aR in aT){aP='<i style="color:'+aT[aR][0]+';" class="icon-'+aR+'" title="'+aT[aR][1]+'"></i>'+aP}aP+='<b title="'+aQ+'次攻击">x'+aQ+"</b>";var aL=$("#fightHistory");var aW=$("div[class^=foundation-style]",aL);if(aW.length===6){$("#ehHistoryExpand").show()}aW.slice(0,2).attr("style","opacity:0.6;");aW.slice(2,4).attr("style","opacity:0.3;");if($("#ehHistoryExpand").is(":hidden")===false){aW.slice(4,6).hide()}var aV=($("#fightResult>div").attr("class").split(" ").pop().indexOf("critical")!==-1);if(aV){aL.prepend($("<div>",{"class":"foundation-style small-6 columns foundation-text-right",html:aP}),$("<div>",{"class":"foundation-style small-4 columns foundation-text-right critical",text:aO.text()}))}else{aL.prepend($("<div>",{"class":"foundation-style small-6 columns foundation-text-right",html:aP}),$("<div>",{"class":"foundation-style small-4 columns foundation-text-right",text:aO.text()}))}$("#ehHitsNumber").text(parseInt($("#ehHitsNumber").text())+aQ);$("#ehTotalDamage").text(aM(parseInt($("#ehTotalDamage").text().replace(/,/g,"").replace(/\xA0/g,""))+aX))}else{aZ.text($("#fightResponse").text().trim());aZ.fadeOut(2000)}}function aK(){if(ab<0){G++;R("HitUsingWeapon",G);if(S<=0){return 0}else{var aM=parseInt($("#Q"+S+"WeaponStock").text());if(aM<=0){return 0}else{return S}}}else{if(G>=ab){return 0}else{G++;R("HitUsingWeapon",G);if(S<=0){return 0}else{var aL=parseInt($("#Q"+S+"WeaponStock").text());if(aL<=0){return 0}else{return S}}}}}function az(aM,aP){var aL=aK();if(!(aL>=0&&aL<=5)){aL=0}console.log("使用Q"+aL+"，side="+aM+"，value="+aP);var aN="weaponQuality="+aL+"&battleRoundId="+$("#battleRoundId").val()+"&side="+aM+"&value="+aP;var aO=$.ajax({type:"POST",url:"fight.html",timeout:n,data:aN,success:function(aT){$("#fightResponse > div").replaceWith(aT);if($("#showMsg").length>0){aA($(aT))}var aS=$("#healthUpdate",aT).text();if(aS!==""){var aQ=aS.substr(0,aS.length-3);if(aQ<100){$("#healthProgress div.ui-corner-right").removeClass("ui-corner-right")}$("#healthProgress .ui-progressbar-value").animate({width:aQ+"%"},{queue:false});$("#healthProgress").attr("title",aQ+" / 100");$("#actualHealth").html(aQ);var aR=$("#DamageDone",aT);if(aR.length<0){console.log($("#fightResponse").text().trim());au++;if(au>I){d()}}else{if(au>0){au=0}if(M>0){M=0;R("ErrorRefreshedCount",0)}}}else{au++;K("攻击出错："+$("#fightResponse").text().trim()+"("+au+")");if(au>I){d()}}},error:function(aQ,aS,aR){au++;if(aS=="timeout"){K("攻击出错：超时("+au+")")}else{K("攻击出错：错误码"+aQ.status+"("+au+")")}if(au>I){d()}return false}})}function aF(){var aM=$("#roundCountdown").children().text();var aL=aM.split(":");if(aL.length==3){return(parseInt(aL[0])*3600+parseInt(aL[1])*60+parseInt(aL[2]))}else{return -1}}function aE(){var aN=parseInt($("#minutesLimit").text().split(":")[0]);var aM=parseInt($("#secondsLimit").text());if((aN<0)||isNaN(aN)){aN=0}if((aM<0)||isNaN(aM)){aM=0}var aL=ai((aN*60+aM+ah)*1000,(aN*60+aM+x)*1000);K("将于 "+ac(new Date(Date.now()+aL))+" 刷新",1000000);setTimeout(function(){location.reload()},aL)}function av(aM){if(N==false){K("打枪功能未启用或已暂停");return}var aL;var aN=parseFloat($("#actualHealth").html());if(aN>=10){aL=ai(F,c);if((aN>=50)&&(Q==false)){az(aM,"Berserk");K(aL+"ms后连击");setTimeout(function(){av(aM)},aL)}else{az(aM,"undefined");K(aL+"ms后单击");setTimeout(function(){av(aM)},aL)}}else{R("HitUsingWeapon",0);aE()}}function aw(){function aL(a7,a8){var a6={};var a4=0;var a5=0;var a9;if(a8==true){a9=$("#topDefender"+a7)}else{a9=$("#topAttacker"+a7)}if((a9.length>0)&&(a9.children().length>0)){a4=a9.children().children('a[href^="profile.html?id="]').attr("href").split("=")[1];a5=parseInt(a9.children().children(".hitInfl").text().replace(/,/g,""))}a6.IsDefender=a8;a6.Id=a4;a6.Damage=a5;return a6}function aN(a7,a8){var a6={};var a4=0;var a5=0;var a9;if(a8==true){a9=$("#top10Defenders"+a7)}else{a9=$("#top10Attackers"+a7)}if((a9.length>0)&&(a9.children().length>0)){a4=a9.children("div").children('a[href^="profile.html?id="]').attr("href").split("=")[1];a5=parseInt(a9.children("div").children(".hitInfl").text().replace(/,/g,""))}a6.IsDefender=a8;a6.Id=a4;a6.Damage=a5;return a6}function a1(){var a4=ai(0,2);if(a4==0){K("随机输出在 防守方");return"defender"}else{K("随机输出在 进攻方");return"attacker"}}function aQ(a4,a5){if(a4[0].Damage>a5[0].Damage){K("防守方第一位伤害较少，选择输出在 防守方");return"defender"}else{if(a4[0].Damage<a5[0].Damage){K("进攻方第一位伤害较少，选择输出在 进攻方");return"attacker"}else{K("双方第一位伤害相同或无人输出");return a1()}}}function aP(a4,a5){if(a4[2].Damage>a5[2].Damage){K("防守方第三位伤害较少，选择输出在 防守方");return"defender"}else{if(a4[2].Damage<a5[2].Damage){K("进攻方第三位伤害较少，选择输出在 进攻方");return"attacker"}else{K("双方第三位伤害相同或无人输出");return aQ(a4,a5)}}}function aW(a4,a5){if(a4[9].Damage>a5[9].Damage){K("防守方第十位伤害较少，选择输出在 防守方");return"defender"}else{if(a4[9].Damage<a5[9].Damage){K("进攻方第十位伤害较少，选择输出在 进攻方");return"attacker"}else{K("双方第十位伤害相同或无人输出");return aP(a4,a5)}}}var a2;var aU;if($(".xflagsBig").length>0){a2=$(".xflagsBig:first").attr("class").split(" ").pop();a2=a2.substring(a2.indexOf("-")+1);aU=$(".xflagsBig:last").attr("class").split(" ").pop();aU=aU.substring(aU.indexOf("-")+1)}else{if($(".flags-big").length>0){a2=$(".flags-big:first").attr("class").split(" ").pop();aU=$(".flags-big:last").attr("class").split(" ").pop()}else{if($(".muAvatar").length>0){a2=$(".alliesList.leftList.fightFont").text().trim();aU=$(".alliesList.rightList.fightFont").text().trim()}else{a2="未知";aU="未知"}}}K(a2+" vs "+aU);if((P==true)&&($.inArray(a2,al)>=0)){K(a2+"是敌人，将为"+aU+"输出");return"attacker"}else{if((P==true)&&($.inArray(aU,al)>=0)){K(aU+"是敌人，将为"+a2+"输出");return"defender"}else{if((P==true)&&($.inArray(a2,w)>=0)){K(a2+"是盟友，将为"+a2+"输出");return"defender"}else{if((P==true)&&($.inArray(aU,w)>=0)){K(aU+"是盟友，将为"+aU+"输出");return"attacker"}else{if(C<0){return a1()}if(C==0){K("设置输出在 防守方");return"defender"}else{if(C==1){K("设置输出在 进攻方");return"attacker"}else{if(C>=2){var aM=$("#userName").attr("href").split("=")[1];var aS=[];var aY=[];for(var a0=1;a0<=3;a0++){aS.push(aL(a0,false));aY.push(aL(a0,true))}for(var aZ=4;aZ<=10;aZ++){aS.push(aN(aZ,false));aY.push(aN(aZ,true))}var aR=10;var aT=10;for(var aX=0;aX<10;aX++){if(aM==aS[aX].Id){aT=aX;break}}for(var aV=0;aV<10;aV++){if(aM==aY[aV].Id){aR=aV;break}}if(aR<aT){K("你在防守方输出为第"+(aR+1)+"位，选择输出在 防守方");return"defender"}else{if(aR>aT){K("你在进攻方输出为第"+(aT+1)+"位，选择输出在 进攻方");return"attacker"}else{if(aR<10){if(aS[aR].Damage<aY[aR].Damage){K("你在双方输出均为第"+(aR+1)+"位，但在防守方伤害较高，选择输出在 防守方");return"defender"}else{if(aS[aR].Damage>aY[aR].Damage){K("你在双方输出均为第"+(aR+1)+"位，但在进攻方伤害较高，选择输出在 进攻方");return"attacker"}else{K("你在双方输出均为第"+(aR+1)+"位，且伤害相同");return a1()}}}else{if(C==2){return aQ(aS,aY)}else{if(C==3){return aP(aS,aY)}else{if(C==4){return aW(aS,aY)}else{if(C==5){return a1()}else{if(C==6){var aO=$('img[src$="red_ball.png"]').length;var a3=$('img[src$="blue_ball.png"]').length;if(aO>a3){K("防守方获胜回合数较少，选择输出在 防守方");return"defender"}else{if(aO<a3){K("进攻方获胜回合数较少，选择输出在 进攻方");return"attacker"}else{K("双方获胜回合数相同");return a1()}}}else{return a1()}}}}}}}}}else{return a1()}}}}}}}}function aB(){if(J==true){K("等待跳转到工作页");return}if(am()=="battle"){au=0;if($(".testDivred").length>0){K("该战场被冻结");l();return}else{if($("#fightButton2").length>0){av(aw())}else{if($("#fightButton1").length>0){av("side")}else{l();return}}}}else{l();return}}if(am()=="battle"){if(A>0){if(Date.now()>A){K("超过设定时间，关闭自动清体",1000000);return}else{K("即将在"+ac(new Date(A))+"停止自动清体功能")}}if(h>0){var ay=ai(0,100);if(h>ay){K("因为概率设置，本次不会清体("+ay+"<"+h+")");aE();return}}if(ag==parseInt($('a[href^="battleStatistics.html?id="]').attr("href").replace("battleStatistics.html?id=",""))){if(B>0){var aD=ai(0,100);if(B>aD){var aI=aF();var aG=parseInt($("#minutesLimit").text().split(":")[0]);var aC=parseInt($("#secondsLimit").text());if((aG<0)||isNaN(aG)){aG=0}if((aC<0)||isNaN(aC)){aC=0}var aH=aI-(aG*60+aC);if((aI>0)&&(aH<0)&&(aI<v*60)){S=r;Q=q;F=m;c=T;var ax=ai(s,Y);var aJ=(aI-ax)*1000;K("该场为重要战场，将于 S"+ax+" 压秒",1000000);setTimeout(function(){aB()},aJ);return}else{K("该场为重要战场，程序将在回合最后"+v+"分钟进行判断");aB();return}}else{K("虽然该场为重要战场，但因为概率设置("+aD+"<"+B+")，本次不进行压秒判断");aB();return}}else{K("虽然该场为重要战场，但是压秒概率为0，将忽略压秒设置");aB();return}}else{aB();return}}else{K("非战场页面");aB();return}}
