// ==UserScript==
// @name         e-sim xaria 战车是怎样炼成的
// @namespace    ESX
// @version      0.5.14-release
// @description  xaria服自动双击、自动清空体力，自动清空体力功能需要在战场页才能触发
// @author       Exsper
// @match        http://testura.e-sim.org:8000/*
// @match        https://testura.e-sim.org:8000/*
// @match        http://xaria.e-sim.org/*
// @match        https://xaria.e-sim.org/*
// @match        http://nebula.e-sim.org/*
// @match        https://nebula.e-sim.org/*
// @require      http://cdn.e-sim.org/js/jquery-1.8.3.min.js
// @grant        GM_addStyle
// @run-at       document-start
// ==/UserScript==

//敬请牢记：如果您安装或使用本插件，就默认您已经承诺：不与任何人在任何场合分享插件的全部或部分内容；不在插件开发群以外的地方讨论插件相关问题或功能；在游戏截图前首先关闭所有插件再截图
//敬请牢记：如果您违背了您的承诺，您将失去所有esim插件未来版本的使用权并可能受到诸多方面的惩罚

//前排提醒：该插件有些特殊功能需要先开启e-sim助手（获取盟友、显示伤害），但如果不需要这些功能也可以脱离e-sim助手独立运行
//前排提醒：在自动寻找战场时，插件不会优先选择盟友场或是重要战场，而是寻找到能打的战场就立即跳转

// ==UserScript==
// @name         e-sim xaria 战车是怎样炼成的
// @namespace    ESX
// @version      0.5.13-release
// @description  xaria服自动双击、自动清空体力，自动清空体力功能需要在战场页才能触发
// @author       Exsper
// @match        http://testura.e-sim.org:8000/*
// @match        https://testura.e-sim.org:8000/*
// @match        http://xaria.e-sim.org/*
// @match        https://xaria.e-sim.org/*
// @require      http://cdn.e-sim.org/js/jquery-1.8.3.min.js
// @grant        GM_addStyle
// @run-at       document-start
// ==/UserScript==

//敬请牢记：如果您安装或使用本插件，就默认您已经承诺：不与任何人在任何场合分享插件的全部或部分内容；不在插件开发群以外的地方讨论插件相关问题或功能；在游戏截图前首先关闭所有插件再截图
//敬请牢记：如果您违背了您的承诺，您将失去所有esim插件未来版本的使用权并可能受到诸多方面的惩罚

//前排提醒：该插件有些特殊功能需要先开启e-sim助手（获取盟友、显示伤害），但如果不需要这些功能也可以脱离e-sim助手独立运行
//前排提醒：在自动寻找战场时，插件不会优先选择盟友场或是重要战场，而是寻找到能打的战场就立即跳转

var am=true;var X=true;var N=true;var J=false;var M=0;var z=0;var y=50;var E=1;var S=0;var C=0;var k=true;var V=-1;var e=true;var U;var P=true;var w=["China","Taiwan"];var ak=[];var Z=true;var H=true;var an=true;var o=true;var i=true;var t="battles.html?countryId=-1&sorting=BY_TOTAL_DAMAGE";var ap=true;var b=true;var I=4;var F=600;var c=3000;var Q=false;var ag=20;var x=240;var h=20;var A=-1;var af=-1;var v=10;var B=50;var Y=20;var s=5;var r=0;var q=false;var m=400;var T=800;var G=0;var ab=-1;var n=5*1000;var ae=10000;$.info=function(){var ar,at,av,ax,aw,au,aq;if(arguments.length==1){aw=arguments[0];au=ae}else{if(arguments.length==2){aw=arguments[0];au=arguments[1]}else{return}}ar=$("#ESXMessageDiv");ar.css({display:"block"}).append('<div class="esxmsg">'+aw+"</div>");ax=ar.children("div");av=ax.eq(-1);if(ax.length>10){ax.eq(0).mouseenter()}aq=av.width();av.css({left:-aq,opacity:0}).animate({left:0,opacity:1},200,function(){return av.delay(au).animate({left:-aq,opacity:0},200,function(){av.remove()})});return ax.eq(-1)};function ai(ar,at,aq){ar="ESX-"+ar;if(aq===true){localStorage.setItem(ar,JSON.stringify(at.split(",")))}else{localStorage.setItem(ar,JSON.stringify(at))}}function D(ar,aq){ar="ESX-"+ar;if(aq===true){return(ar in localStorage)?JSON.parse(localStorage.getItem(ar)).join(","):null}else{return(ar in localStorage)?JSON.parse(localStorage.getItem(ar)):null}}function R(aq,ar){localStorage["ESX-"+aq]=ar}function W(aq){aq="ESX-"+aq;return(aq in localStorage)?localStorage[aq]:null}function ad(aq){aq="ESX-"+aq;localStorage.removeItem(aq)}function ao(ar,aq){var at=W(ar);if(at==null){return aq}else{if(typeof aq=="string"){return at}else{if(typeof aq=="number"){return parseInt(at)}else{if(typeof aq=="boolean"){return(at=="true")}else{return at}}}}}f();setTimeout(function(){location.reload()},30*60*1000);function ah(au,aq){var at=aq-au;var ar=Math.random()*at+au;ar=parseInt(ar,10);return ar}function ac(av){var at=av.getHours();var au=av.getMinutes();var ar=av.getSeconds();var aq="";if(at<10){aq+="0"}aq+=at+":";if(au<10){aq+="0"}aq+=au+":";if(ar<10){aq+="0"}aq+=ar;return(aq)}function g(av){if($("#Eh2Homeland").length>0){w=[];w.push($("#Eh2Homeland").children("div").attr("title"));if(W("EHAllies")=="true"){var au=$("#Eh2Allies").children("div");for(var at=0;at<au.length;at++){w.push(au[at].title)}}if(W("EHCoalition")=="true"){var ar=$("#Eh2CoalitionMembers").children("div");for(var aq=0;aq<ar.length;aq++){w.push(ar[aq].title)}}w=$.unique(w.sort());ai("Allies",w);av.val(w.join(","));K("获取到盟友："+w)}else{K("e-sim助手未运行或版本不兼容")}}function u(at){if($("#Eh2Homeland").length>0){ak=[];if(W("EHEnemies")=="true"){var ar=$("#Eh2Enemies").children("div");for(var aq=0;aq<ar.length;aq++){ak.push(ar[aq].title)}}ai("Enemies",ak);at.val(ak.join(","));K("获取到敌人："+ak)}else{K("e-sim助手未运行或版本不兼容")}}function aa(){am=ao("IsRunning",am);X=ao("EnableWorkTrain",X);N=ao("EnableAutoFight",N);J=ao("IsWorkingTraining",J);E=ao("FlightTicketQuality",E);M=ao("ErrorRefreshedCount",M);k=ao("BackToRegion",k);V=ao("OriginRegionId",V);e=ao("BackToBattle",e);U=ao("OriginBattleUrl",U);P=ao("FightForAlly",P);w=D("Allies");ak=D("Enemies");Z=ao("EHAllies",Z);H=ao("EHEnemies",H);an=ao("EHCoalition",an);S=ao("FightWeaponQuality",S);F=ao("FightWaitMin",F);c=ao("FightWaitMax",c);ag=ao("NextRefreshExtendWaitMin",ag);x=ao("NextRefreshExtendWaitMax",x);h=ao("SleepProbability",h);A=ao("CancelDateTime",A);B=ao("AFCTiggerProbability",B);Y=ao("AFCRefreshInTimeLeftMax",Y);s=ao("AFCRefreshInTimeLeftMin",s);af=ao("AFCTargetBattleID",af);r=ao("AFCFightWeaponQuality",r);q=ao("AFCFightByHitOnly",q);m=ao("AFCFightWaitMin",m);T=ao("AFCFightWaitMax",T);Q=ao("FightByHitOnly",Q);G=ao("HitUsingWeapon",G);ab=ao("MaxHitUsingWeapon",ab);C=ao("FightDefaultSide",C);o=ao("AutoSearchBattle",o);t=ao("SearchBattleUrl",t);ap=ao("AutoFlyToBattle",ap);b=ao("SearchBattleShuffle",b);n=ao("AjaxTimeout",n)}function p(){ad("IsRunning");ad("EnableWorkTrain");ad("EnableAutoFight");ad("IsWorkingTraining");ad("FlightTicketQuality");ad("ErrorRefreshedCount");ad("BackToRegion");ad("OriginRegionId");ad("BackToBattle");ad("OriginBattleUrl");ad("FightForAlly");ad("Allies");ad("Enemies");ad("EHAllies");ad("EHEnemies");ad("EHCoalition");ad("FightWeaponQuality");ad("FightWaitMin");ad("FightWaitMax");ad("NextRefreshExtendWaitMin");ad("NextRefreshExtendWaitMax");ad("SleepProbability");ad("CancelDateTime");ad("AFCTiggerProbability");ad("AFCRefreshInTimeLeftMax");ad("AFCRefreshInTimeLeftMin");ad("AFCTargetBattleID");ad("AFCFightWeaponQuality");ad("AFCFightByHitOnly");ad("AFCFightWaitMin");ad("AFCFightWaitMax");ad("FightByHitOnly");ad("HitUsingWeapon");ad("MaxHitUsingWeapon");ad("FightDefaultSide");ad("AutoSearchBattle");ad("SearchBattleUrl");ad("AutoFlyToBattle");ad("SearchBattleShuffle");ad("AjaxTimeout")}function L(){function ay(aU,aT,aP,aQ,aO){var aS=$("<input>",{type:"checkbox",style:"vertical-align:5px;",id:aT});var aR=$("<label>",{"class":"checkboxlabel","for":aT,text:aP});var aN=W(aQ);if(aN===null){R(aQ,aO);aS.attr("checked",aO==true)}else{aS.attr("checked",aN=="true")}aU.append(aS,aR);aS.click(function(){if(aS.is(":checked")){R(aQ,true)}else{R(aQ,false)}})}function at(aS,aW,aT,aN,aO,aU){var aQ=$("<span>",{style:"padding:3px; margin:3px",text:aW});var aR=$("<select>",{style:"padding:3px; margin:3px"}).appendTo(aQ);for(var aP=0;aP<aT.length;aP++){$("<option>",{value:aT[aP],text:aN[aP]}).appendTo(aR)}var aV=W(aO);if(aV===null){R(aO,aU);aR.val(aU)}else{aR.val(aV)}aS.append(aQ);aR.change(function(){R(aO,aR.val())})}function aC(aR,aQ,aP,aO){var aS=$("<input>",{type:"text",id:"ESX-"+aP,style:"vertical-align:5px;width:"+aQ+"px;height:20px;"}).appendTo(aR);var aN=W(aP);if(aN===null){R(aP,aO);aS.val(aO)}else{aS.val(aN)}aR.append(aS);aS.focus(function(){aS.css("background-color","#FFFFFF")});aS.blur(function(){if(aS.val()===""){aS.val(aO)}aS.css("background-color","#79FF79");R(aP,aS.val())})}function aG(aR,aQ,aP,aO){var aS=$("<input>",{type:"text",id:"ESX-"+aP,style:"vertical-align:5px;width:"+aQ+"px;height:20px;"}).appendTo(aR);var aN=D(aP,true);if(aN===null){ai(aP,aO);aS.val(aO.join(","))}else{aS.val(aN)}aR.append(aS);aS.focus(function(){aS.css("background-color","#FFFFFF")});aS.blur(function(){if(aS.val()===""){aS.val(aO.join(","))}aS.css("background-color","#79FF79");ai(aP,aS.val(),true)})}var az=$("<li>",{id:"ESXIcon"}).insertBefore($("#userAvatar"));var aK=$("<a>",{"data-dropdown":"ESXContentDrop",style:"padding:0 5px;",href:"#"}).appendTo(az);var aM=$("<img>",{align:"absmiddle","class":"smallAvatar",style:"height:36px; width:36px;",src:"http://cdn.e-sim.org/img/eventIcons/battleLostIcon.png"}).appendTo(aK);var aD=$("#contentDrop").clone().attr("id","ESXContentDrop").empty().insertBefore($("#contentDrop"));aD.removeClass("medium");aD.addClass("large");$("<b>",{text:"xaria 战车是怎样炼成的 "+GM_info.script.version}).appendTo(aD);var ax=$("<span>",{text:"捐赠",style:"float:right;"}).appendTo(aD);ax.click(function(){aF()});function aF(){var aO=$("<div>",{"class":"dwindow",style:"overflow:auto; width:300px; height:380px; display:block; position:fixed; top:50%; left:50%; margin-left: -225px; margin-top: -150px; padding-bottom: 20px; text-align:center;background-color:lightgray;"}).appendTo($("body"));$("<p>e-sim插件开发不易，您的无私奉献是我们努力的肯定与支持，让我们做得更好</p>").appendTo(aO);$("<p>QQ钱包</p>").appendTo(aO);var aP=$("<div></div>").appendTo(aO);aP[0].innerHTML='<img src="https://puu.sh/Ad7wr/10f301077b.png"/>';$("<br>").appendTo(aO);var aN=$("<button>",{text:"关闭"}).appendTo(aO);aN.click(function(){aO.remove()})}$("<div>",{style:"text-align:center;",text:"自动清空体力、自动双击。珍惜账号，慎用自动。设置更改刷新后生效。"}).appendTo(aD);var aH=$("<table>",{id:"ESXConfig",style:"width:100%;line-height:30px"}).appendTo(aD);var ar=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aH);var aw=$("<td>").appendTo(ar);ay(aw,"IsRunCheckbox","启用该插件","IsRunning",am);ay(aw,"EnableWorkTrainCheckbox","启用双击功能","EnableWorkTrain",X);ay(aw,"EnableAutoFightCheckbox","启用打枪功能","EnableAutoFight",N);ar=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aH);aw=$("<td>").appendTo(ar);at(aw,"输出使用武器：",[0,1,2,3,4,5],["拳头","Q1","Q2","Q3","Q4","Q5"],"FightWeaponQuality",S);ay(aw,"FightByHitOnlyCheckbox","不使用连击","FightByHitOnly",Q);at(aw,"超出次数则使用空手：",[-1,0,1,2,3,4,5,6,7,8,9,10],["不限制","0","1","2","3","4","5","6","7","8","9","10"],"MaxHitUsingWeapon",ab);ar=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aH);aw=$("<td>").appendTo(ar);at(aw,"可以打两边时选择输出方：",[-1,0,1,2,3,4,5],["随机","防守方","进攻方","尽量拿到top1","尽量拿到top3","尽量拿到top10","随机但尽量打在一边"],"FightDefaultSide",C);ay(aw,"FightForAllyCheckbox","起义场优先打盟友方或对抗敌方","FightForAlly",P);ar=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aH);aw=$("<td>").appendTo(ar);$("<span>",{text:"设置盟友（以半角逗号分隔）："}).appendTo(aw);aG(aw,400,"Allies",w);ar=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aH);aw=$("<td>").appendTo(ar);$("<span>",{text:"设置敌国（以半角逗号分隔）："}).appendTo(aw);aG(aw,400,"Enemies",ak);ar=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aH);aw=$("<td>").appendTo(ar);var aL=$("<button>",{text:"从E-sim助手获取盟友和敌国"}).appendTo(aw);aL.click(function(){g($("#ESX-Allies"));u($("#ESX-Enemies"))});ay(aw,"EHAlliesCheckbox","获取盟友","EHAllies",Z);ay(aw,"EHCoalitionCheckbox","获取联盟成员国","EHCoalition",an);ay(aw,"EHEnemiesCheckbox","获取敌国","EHEnemies",H);ar=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aH);aw=$("<td>").appendTo(ar);$("<span>每次攻击间隔（毫秒）：</span>").appendTo(aw);aC(aw,60,"FightWaitMin",F);$("<span> 到 </span>").appendTo(aw);aC(aw,60,"FightWaitMax",c);$("<span>打枪请求超时限制：</span>").appendTo(aw);aC(aw,60,"AjaxTimeout",n);$("<span>毫秒</span>").appendTo(aw);var aB=$("<button>",{text:"Ping一下"}).appendTo(aw);aB.click(function(){$.ping=function(aQ){var aS,aP,aR;var aO=function(aU){var aT="^((https|http)?://){1}";var aV=new RegExp(aT);return aV.test(aU)?aU:"http://"+aU};$.ajax({url:aQ.url,type:"GET",dataType:"html",timeout:20000,beforeSend:function(){if(aQ.beforePing){aQ.beforePing()}aP=new Date().getTime()},complete:function(){aR=new Date().getTime();aS=Math.abs(aP-aR);if(aQ.afterPing){aQ.afterPing(aS)}},error:function(aT,aV,aU){if(aV=="timeout"){K("Ping超时")}aR=new Date().getTime();aS=Math.abs(aP-aR);if(aQ.afterPing){aQ.afterPing(aS)}}});if(aQ.interval&&aQ.interval>0){var aN=aQ.interval*1000;setTimeout(function(){$.ping(aQ)},aN)}};$.ping({url:"http://xaria.e-sim.org",afterPing:function(aN){K("延迟： "+aN+" 毫秒")}})});ar=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aH);aw=$("<td>").appendTo(ar);$("<span>清空体力后下次刷新额外延时（秒）：</span>").appendTo(aw);aC(aw,60,"NextRefreshExtendWaitMin",ag);$("<span> 到 </span>").appendTo(aw);aC(aw,60,"NextRefreshExtendWaitMax",x);ar=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aH);aw=$("<td>").appendTo(ar);$("<span>每次刷新后均有</span>").appendTo(aw);aC(aw,60,"SleepProbability",h);$("<span>%的概率不进行自动清体</span>").appendTo(aw);ar=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aH);aw=$("<td>").appendTo(ar);$("<span>于</span>").appendTo(aw);aC(aw,60,"CancelDateTimeTextbox",60);$("<span>分钟后停止自动清体功能</span>").appendTo(aw);var aq=$("<button>",{text:"设置"}).appendTo(aw);aq.click(function(){A=Date.now()+parseInt($("#ESX-CancelDateTimeTextbox").val())*60*1000;R("CancelDateTime",A);K("设置在"+ac(new Date(A))+"停止自动清体功能")});var au=$("<button>",{text:"清除"}).appendTo(aw);au.click(function(){A=-1;R("CancelDateTime",A);K("已清除设定的停止清体时间")});ar=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aH);aw=$("<td>").appendTo(ar);$("<span>重要战场回合剩余时间小于"+v+"分钟，则有</span>").appendTo(aw);aC(aw,20,"AFCTiggerProbability",B);$("<span>%的概率在回合结束前S</span>").appendTo(aw);aC(aw,20,"AFCRefreshInTimeLeftMax",Y);$("<span>到S</span>").appendTo(aw);aC(aw,20,"AFCRefreshInTimeLeftMin",s);$("<span>之间（压秒）</span><br/>").appendTo(aw);$("<span>每次攻击间隔（毫秒）：</span>").appendTo(aw);aC(aw,60,"AFCFightWaitMin",m);$("<span> 到 </span>").appendTo(aw);aC(aw,60,"AFCFightWaitMax",T);at(aw,"使用武器：",[0,1,2,3,4,5],["拳头","Q1","Q2","Q3","Q4","Q5"],"AFCFightWeaponQuality",r);ay(aw,"AFCFightByHitOnlyCheckbox","不使用连击","AFCFightByHitOnly",q);$("<br/>").appendTo(aw);var aA=$("<button>",{text:"设置当前战场为重要战场"}).appendTo(aw);aA.click(function(){af=parseInt($('a[href^="battleStatistics.html?id="]').attr("href").replace("battleStatistics.html?id=",""));R("AFCTargetBattleID",af);K("设置战场 "+af+" 为重要战场")});var av=$("<button>",{text:"清除重要战场"}).appendTo(aw);av.click(function(){af=-1;R("AFCTargetBattleID",af);K("已清除记录的重要战场")});ar=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aH);aw=$("<td>").appendTo(ar);at(aw,"工作飞行使用机票：",[1,2,3,4,5],["Q1","Q2","Q3","Q4","Q5"],"FlightTicketQuality",E);ay(aw,"BackToRegionCheckbox","双击后飞回原所在地（请确保机票足够）","BackToRegion",k);ay(aw,"BackToBattleCheckbox","双击后回到原战场","BackToBattle",e);ar=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aH);aw=$("<td>").appendTo(ar);ay(aw,"AutoSearchBattleCheckbox","战场页没有输出按钮时自动寻找第一个可输出战场","AutoSearchBattle",o);ay(aw,"AutoFlyToBattleCheckbox","如果找不到战场则飞向第一个起义战地区","AutoFlyToBattle",ap);ar=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aH);aw=$("<td>").appendTo(ar);ay(aw,"SearchBattleShuffleCheckbox","打乱战场列表，以避免总是选择第一个可输出战场","SearchBattleShuffle",b);ar=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aH);aw=$("<td>").appendTo(ar);$("<span>",{text:"搜寻战场列表地址："}).appendTo(aw);aC(aw,400,"SearchBattleUrl",t);ar=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aH);aw=$("<td>").appendTo(ar);var aJ=$("<button>",{text:"测试搜寻战场"}).appendTo(aw);aJ.click(function(){t=W("SearchBattleUrl");l()});var aI=$("<button>",{text:"重置双击设置",title:"如果因双击错误导致无法自动输出，请点击此按钮"}).appendTo(aw);aI.click(function(){ad("IsWorkingTraining");ad("OriginRegionId");ad("OriginBattleUrl")});var aE=$("<button>",{text:"重置所有设置",title:"插件运行遇到问题？尝试重置插件吧"}).appendTo(aw);aE.click(function(){p()})}function f(){z=parseInt(W("WaitForLoadCount"));if($(".time").length!==2){z++;if(z<=y){R("WaitForLoadCount",z);console.log(z+":网页未加载完全，xaria插件等待1秒");setTimeout(f,1000);return}else{R("WaitForLoadCount",0);location.reload();return}}var ar=$(".time:first").text().match(/-/g);if(ar==null||ar.length!=2){z++;if(z<=y){R("WaitForLoadCount",z);console.log(z+":官方脚本还未执行，xaria插件等待0.5秒");setTimeout(f,500);return}else{R("WaitForLoadCount",0);location.reload();return}}if($("#minutesLimit").text()==""){z++;if(z<=y){console.log(z+":官方时间还未刷新，xaria插件等待0.5秒");setTimeout(f,500);return}else{R("WaitForLoadCount",0);location.reload();return}}R("WaitForLoadCount",0);O();L();aa();if(am==false){K("xaria插件未启动");return}if(X==true){if((k==true)&&(al()=="battle")){var at=$('a[href^="region.html?id="][href!="region.html?id="]');var aq=parseInt(at.first().attr("href").split("=")[1]);R("OriginRegionId",aq)}if((e==true)&&(al()=="battle")){R("OriginBattleUrl",location.href)}j()}if((N==true)&&(al()=="battle")){setTimeout(function(){aj()},2000);return}}function O(){GM_addStyle(".esxmsg{background-color: #fff;border-left: 4px solid #7ad03a;-webkit-box-shadow: 0 1px 1px 0 rgba(0,0,0,.1);}");var aq=$("<div>",{id:"ESXMessageDiv",style:"position:fixed; bottom:5%;"}).appendTo("body")}function K(aq,ar){console.log(aq);if(ar==undefined){$.info(aq)}else{$.info(aq,ar)}}function al(){if(document.URL.search("html")!=-1){return document.URL.match("/([a-zA-Z0-9]+).html")[1]}else{return"index"}}function j(){function ar(){var ay=$("#trainButton");if(ay.length<=0){X=false;R("EnableWorkTrain",false);J=false;R("IsWorkingTraining",false);alert("错误：未训练却没有训练按钮，已自动关闭双击功能")}else{az()}function az(){$.ajax({type:"POST",url:"train/ajax",data:null,success:function(aB){var aA=$("#trainButton",aB);if((aA.length<1)&&($("#userMenu",aB).length<1)){at()}else{X=false;R("EnableWorkTrain",false);J=false;R("IsWorkingTraining",false);alert("错误：训练失败，已自动关闭双击功能")}$("#trainReload").html(aB)}})}}function av(){var aB=$("#workButton");if(aB.length<1){X=false;R("EnableWorkTrain",false);J=false;R("IsWorkingTraining",false);alert("错误：未工作却没有工作按钮，已自动关闭双击功能")}else{var aC=$('a[href^="region.html?id="][href!="region.html?id="]');var az=aC.first().parent().find("div").attr("class");az=az.substring(az.indexOf("-")+1);var ay=aC.last().parent().find("div").attr("class");ay=ay.substring(ay.indexOf("-")+1);if(az==ay){aA()}else{document.location=aC.last().attr("href")}}function aA(){$.ajax({type:"POST",url:"work/ajax?action=work",data:null,success:function(aD){$("#workReload").html(aD);var aE=$("#workButton",aD);if((aE.length<1)&&($("#userMenu",aD).length<1)){document.location="/train.html"}else{X=false;R("EnableWorkTrain",false);J=false;R("IsWorkingTraining",false);alert("错误：工作失败，已自动关闭双击功能")}}})}}function aq(){$("#ticketQuality").val(E);var ay=$(".travel.button.foundation-style");ay[0].click()}function aw(){var ay=$(".testDivred");if(ay.length>0){X=false;R("EnableWorkTrain",false);J=false;R("IsWorkingTraining",false);alert("飞行出错："+$(".testDivred :last")[0].childNodes[1].nodeValue+"，已自动关闭双击功能")}else{document.location="/work.html"}}function ax(ay){J=true;R("IsWorkingTraining","true");if(ay==true){setTimeout(function(){document.location="/work.html"},30*1000)}else{document.location="/work.html"}}function at(){J=false;R("IsWorkingTraining","false");if(k==true){var aA=$('a[href^="region.html?id="][href!="region.html?id="]');var ay=parseInt(aA.first().attr("href").split("=")[1]);if((V!=-1)&&(ay!=V)){K("飞回地区："+V);var az;$.ajax({url:"region.html?id="+V,async:false,success:function(aB){az=parseInt($("#countryId",aB).val())},error:function(aB,aC){console.log("地区页抓取错误 (",aC,")，重新抓取");$.ajax(this)}});$.ajax({url:"travel.html",type:"POST",async:false,data:{countryId:az,regionId:V,ticketQuality:E},success:function(aB){var aC=$("div.testDivred",aB);if(aC.length===1){K("飞行失败："+aC.text().trim())}else{K("飞行成功！")}},error:function(aB,aC){console.log("飞行错误 (",aC,")")}})}}if(e==true){K("返回战场："+U);document.location=U}else{if((N==true)&&(o==true)){l()}else{K("双击结束，等待下次双击")}}}function au(){if(J==false){if(($("#taskButtonWork").length>0)||($("#taskButtonTrain").length>0)){var aA=parseFloat($("#actualHealth").html());var ay=50-E*10;if(k==true){if((aA-ay*2)>=0){ax(false);return}else{K("可能由于人工操作，你当前的体力不足以飞行两次，程序将于30秒后再自动双击，请尽快补充体力");ax(true);return}}else{if((aA-ay)>=0){ax(false);return}else{K("可能由于人工操作，你当前的体力不足以飞行到工作地，程序将于30秒后再自动双击，请尽快补充体力");ax(true);return}}}}else{var az=al();if(az=="work"){av()}else{if(az=="train"){ar()}else{if(az=="region"){aq()}else{if(az=="travel"){aw()}else{R("IsWorkingTraining",false);return}}}}}}au()}function d(){if(N==true){N=false;if(M<=0){M++;R("ErrorRefreshedCount",M);location.reload()}else{M++;R("ErrorRefreshedCount",M);var aq=(M-1)*30;K("自动攻击出错，"+aq+"秒后自动刷新",1000000);setTimeout(function(){location.reload()},aq*1000)}}}function l(){function at(aA){var az=false;$.ajax({url:aA,async:false,success:function(aB){if($(".time",aB).length!==2){console.log(citizenId,"抓取错误，重新抓取");$.ajax(this);return}if($(".testDivred",aB).length>0){az=false}else{if($("#fightButton2",aB).length>0){az=true}else{if($("#fightButton1",aB).length>0){az=true}else{az=false}}}},error:function(aB,aC){console.log("抓取错误 (",aC,")，重新抓取");$.ajax(this)}});return az}function aw(aB){var az=false;var aA=0;var aD=0;var aC=$("form[action='travel.html']",aB);if(aC.length>0){aA=parseInt(aC.children("#countryId").val());aD=parseInt(aC.children("#regionId").val());if((aA>0)&&(aD>0)){$.ajax({url:"travel.html",type:"POST",async:false,data:{countryId:aA,regionId:aD,ticketQuality:E},success:function(aE){var aF=$("div.testDivred",aE);if(aF.length===1){K("飞行失败："+aF.text().trim())}else{K("飞行成功！");az=true}},error:function(aE,aF){console.log("飞行错误 (",aF,")")}})}return az}else{return false}}function ax(aA){var az=false;$.ajax({url:aA,async:false,success:function(aB){if($(".time",aB).length!==2){console.log(citizenId,"抓取错误，重新抓取");$.ajax(this);return}az=aw(aB)},error:function(aB,aC){console.log("抓取错误 (",aC,")，重新抓取");$.ajax(this)}});return az}function ar(aC){for(var aA,az,aB=aC.length;aB;aA=parseInt(Math.random()*aB),az=aC[--aB],aC[aB]=aC[aA],aC[aA]=az){}return aC}function av(az){K("寻找战场："+az);var aA=[];$.ajax({url:az,async:false,success:function(aB){if($(".time",aB).length!==2){console.log(citizenId,"抓取错误，重新抓取");$.ajax(this);return}$("#battlesTable tr:gt(0)",aB).each(function(aC,aE){var aD=$("a[href*='battle.html']",aE);if(aD==null){return true}aA.push(aD.attr("href"))})},error:function(aB,aC){console.log("抓取错误 (",aC,")，重新抓取");$.ajax(this)}});console.log("获取到的战场列表:"+aA);return aA}function ay(){var aB;if(($("#taskButtonFight").length>0)&&(i==true)){aB=av($("#taskButtonFight").children().attr("href"))}else{aB=av(t)}if(b==true){aB=ar(aB)}for(var az=0;az<aB.length;az++){var aA=at(aB[az]);console.log(aB[az]+":"+aA);if(aA==true){return aB[az]}}return"-1"}function aq(){var aB=av(t);if(b==true){aB=ar(aB)}for(var az=0;az<aB.length;az++){var aA=ax(aB[az]);console.log(aB[az]+":"+aA);if(aA==true){return aB[az]}}return"-1"}function au(){var az=ay();if(az!="-1"){document.location=az}else{if(ap==false){K("未找到可以打的战场，10分钟后重新寻找");setTimeout(function(){au()},600*1000)}else{K("未找到可以打的战场，尝试飞行到"+t+"列表里的第一场起义战");az=aq();if(az!="-1"){document.location=az}else{K("未找到可以飞的起义战，10分钟后重新寻找");setTimeout(function(){au()},600*1000)}}}}if(o==true){K("30秒后开始寻找可以输出的战场");setTimeout(function(){au()},30*1000)}else{K("该战场当前无法输出")}}function aj(){var aq=0;function ax(aP){function aJ(a0){a0+="";var aY=a0.split(".");var aZ=/(\d{1,3})(?=(\d{3})+$)/g;return aY[0].replace(aZ,"$1,")+(aY.length==2?"."+aY[1]:"")}var aW=$("#showMsg");aW.text("");aW.show();var aL=$("#DamageDone",aP);if(aL.length>0){var aU=parseInt(aL.text().replace(/,/g,"").replace(/\xA0/g,""));var aX=$(".fightsprite",aL.parent().parent());var aQ={bomb:["grey","无暴击(pain dealer)"],tank:["grey","无坦克(tank)"],syringe:["grey","无类固醇(steroid)"],airplane:["grey","无地点加成"],bookmark:["grey","无军令加成"]};var aR={absorbed:["loved",["lightgreen","闪避(avoid)"]],mu:["bookmark",["lightgreen","有军令加成"]],location:["airplane",["lightgreen","有地点加成"]],STEROIDSplus:["syringe",["lightgreen","有类固醇(steroid)"]],STEROIDSminus:["syringe",["pink","类固醇副作用(steroid)"]],TANKplus:["tank",["lightgreen","有坦克(tank)"]],TANKminus:["tank",["pink","坦克副作用(tank)"]],xp1:["xp",1],xp5:["xp",5],PAIN_DEALER_1_Hplus:["bomb",["lightgreen","1小时暴击(pain dealer)"]],PAIN_DEALER_10_Hplus:["bomb",["lightgreen","10小时暴击(pain dealer)"]],PAIN_DEALER_25_Hplus:["bomb",["lightgreen","25小时暴击(pain dealer)"]]};for(var aO=0;aO<aX.length;++aO){var aV=aX.eq(aO).attr("class").split(" ").pop();if(aV in aR){var aK=aR[aV];aQ[aK[0]]=aK[1]}}var aM="";var aN=aQ.xp;delete aQ.xp;for(aO in aQ){aM='<i style="color:'+aQ[aO][0]+';" class="icon-'+aO+'" title="'+aQ[aO][1]+'"></i>'+aM}aM+='<b title="'+aN+'次攻击">x'+aN+"</b>";var aI=$("#fightHistory");var aT=$("div[class^=foundation-style]",aI);if(aT.length===6){$("#ehHistoryExpand").show()}aT.slice(0,2).attr("style","opacity:0.6;");aT.slice(2,4).attr("style","opacity:0.3;");if($("#ehHistoryExpand").is(":hidden")===false){aT.slice(4,6).hide()}var aS=($("#fightResult>div").attr("class").split(" ").pop().indexOf("critical")!==-1);if(aS){aI.prepend($("<div>",{"class":"foundation-style small-6 columns foundation-text-right",html:aM}),$("<div>",{"class":"foundation-style small-4 columns foundation-text-right critical",text:aL.text()}))}else{aI.prepend($("<div>",{"class":"foundation-style small-6 columns foundation-text-right",html:aM}),$("<div>",{"class":"foundation-style small-4 columns foundation-text-right",text:aL.text()}))}$("#ehHitsNumber").text(parseInt($("#ehHitsNumber").text())+aN);$("#ehTotalDamage").text(aJ(parseInt($("#ehTotalDamage").text().replace(/,/g,"").replace(/\xA0/g,""))+aU))}else{aW.text($("#fightResponse").text().trim());aW.fadeOut(2000)}}function aH(){if(ab<0){G++;R("HitUsingWeapon",G);if(S<=0){return 0}else{var aJ=parseInt($("#Q"+S+"WeaponStock").text());if(aJ<=0){return 0}else{return S}}}else{if(G>=ab){return 0}else{G++;R("HitUsingWeapon",G);if(S<=0){return 0}else{var aI=parseInt($("#Q"+S+"WeaponStock").text());if(aI<=0){return 0}else{return S}}}}}function aw(aJ,aM){var aI=aH();if(!(aI>=0&&aI<=5)){aI=0}console.log("使用Q"+aI+"，side="+aJ+"，value="+aM);var aK="weaponQuality="+aI+"&battleRoundId="+$("#battleRoundId").val()+"&side="+aJ+"&value="+aM;var aL=$.ajax({type:"POST",url:"fight.html",timeout:n,data:aK,success:function(aQ){$("#fightResponse > div").replaceWith(aQ);if($("#showMsg").length>0){ax($(aQ))}var aP=$("#healthUpdate",aQ).text();if(aP!==""){var aN=aP.substr(0,aP.length-3);if(aN<100){$("#healthProgress div.ui-corner-right").removeClass("ui-corner-right")}$("#healthProgress .ui-progressbar-value").animate({width:aN+"%"},{queue:false});$("#healthProgress").attr("title",aN+" / 100");$("#actualHealth").html(aN);var aO=$("#DamageDone",aQ);if(aO.length<0){console.log($("#fightResponse").text().trim());aq++;if(aq>I){d()}}else{if(aq>0){aq=0}if(M>0){M=0;R("ErrorRefreshedCount",0)}}}else{aq++;K("攻击出错："+$("#fightResponse").text().trim()+"("+aq+")");if(aq>I){d()}}},error:function(aN,aP,aO){aq++;if(aP=="timeout"){K("攻击出错：超时("+aq+")")}else{K("攻击出错：错误码"+aN.status+"("+aq+")")}if(aq>I){d()}return false}})}function aC(){var aJ=$("#roundCountdown").children().text();var aI=aJ.split(":");if(aI.length==3){return(parseInt(aI[0])*3600+parseInt(aI[1])*60+parseInt(aI[2]))}else{return -1}}function aB(){var aK=parseInt($("#minutesLimit").text().split(":")[0]);var aJ=parseInt($("#secondsLimit").text());if((aK<0)||isNaN(aK)){aK=0}if((aJ<0)||isNaN(aJ)){aJ=0}var aI=ah((aK*60+aJ+ag)*1000,(aK*60+aJ+x)*1000);K("将于 "+ac(new Date(Date.now()+aI))+" 刷新",1000000);setTimeout(function(){location.reload()},aI)}function ar(aJ){if(N==false){K("打枪功能未启用或已暂停");return}var aI;var aK=parseFloat($("#actualHealth").html());if(aK>=10){aI=ah(F,c);if((aK>=50)&&(Q==false)){aw(aJ,"Berserk");K(aI+"ms后连击");setTimeout(function(){ar(aJ)},aI)}else{aw(aJ,"undefined");K(aI+"ms后单击");setTimeout(function(){ar(aJ)},aI)}}else{R("HitUsingWeapon",0);aB()}}function at(){function aL(a2,a3){var a1={};var aZ=0;var a0=0;var a4;if(a3==true){a4=$("#topDefender"+a2)}else{a4=$("#topAttacker"+a2)}if((a4.length>0)&&(a4.children().length>0)){aZ=a4.children().children('a[href^="profile.html?id="]').attr("href").split("=")[1];a0=parseInt(a4.children().children(".hitInfl").text().replace(/,/g,""))}a1.IsDefender=a3;a1.Id=aZ;a1.Damage=a0;return a1}function aX(a2,a3){var a1={};var aZ=0;var a0=0;var a4;if(a3==true){a4=$("#top10Defenders"+a2)}else{a4=$("#top10Attackers"+a2)}if((a4.length>0)&&(a4.children().length>0)){aZ=a4.children("div").children('a[href^="profile.html?id="]').attr("href").split("=")[1];a0=parseInt(a4.children("div").children(".hitInfl").text().replace(/,/g,""))}a1.IsDefender=a3;a1.Id=aZ;a1.Damage=a0;return a1}function aI(){var aZ=ah(0,2);if(aZ==0){K("随机输出在 防守方");return"defender"}else{K("随机输出在 进攻方");return"attacker"}}function aV(aZ,a0){if(aZ[0].Damage>a0[0].Damage){K("防守方第一位伤害较少，选择输出在 防守方");return"defender"}else{if(aZ[0].Damage<a0[0].Damage){K("进攻方第一位伤害较少，选择输出在 进攻方");return"attacker"}else{K("双方第一位伤害相同或无人输出");return aI()}}}function aS(aZ,a0){if(aZ[2].Damage>a0[2].Damage){K("防守方第三位伤害较少，选择输出在 防守方");return"defender"}else{if(aZ[2].Damage<a0[2].Damage){K("进攻方第三位伤害较少，选择输出在 进攻方");return"attacker"}else{K("双方第三位伤害相同或无人输出");return aV(aZ,a0)}}}function aQ(aZ,a0){if(aZ[9].Damage>a0[9].Damage){K("防守方第十位伤害较少，选择输出在 防守方");return"defender"}else{if(aZ[9].Damage<a0[9].Damage){K("进攻方第十位伤害较少，选择输出在 进攻方");return"attacker"}else{K("双方第十位伤害相同或无人输出");return aS(aZ,a0)}}}var aT;var aW;if($(".xflagsBig").length>0){aT=$(".xflagsBig:first").attr("class").split(" ").pop();aT=aT.substring(aT.indexOf("-")+1);aW=$(".xflagsBig:last").attr("class").split(" ").pop();aW=aW.substring(aW.indexOf("-")+1)}else{if($(".flags-big").length>0){aT=$(".flags-big:first").attr("class").split(" ").pop();aW=$(".flags-big:last").attr("class").split(" ").pop()}else{if($(".muAvatar").length>0){aT=$(".alliesList.leftList.fightFont").text().trim();aW=$(".alliesList.rightList.fightFont").text().trim()}else{aT="未知";aW="未知"}}}K(aT+" vs "+aW);if((P==true)&&($.inArray(aT,ak)>=0)){K(aT+"是敌人，将为"+aW+"输出");return"attacker"}else{if((P==true)&&($.inArray(aW,ak)>=0)){K(aW+"是敌人，将为"+aT+"输出");return"defender"}else{if((P==true)&&($.inArray(aT,w)>=0)){K(aT+"是盟友，将为"+aT+"输出");return"defender"}else{if((P==true)&&($.inArray(aW,w)>=0)){K(aW+"是盟友，将为"+aW+"输出");return"attacker"}else{if(C<0){return aI()}if(C==0){K("设置输出在 防守方");return"defender"}else{if(C==1){K("设置输出在 进攻方");return"attacker"}else{if(C>=2){var aU=$("#userName").attr("href").split("=")[1];var aR=[];var aP=[];for(var aO=1;aO<=3;aO++){aR.push(aL(aO,false));aP.push(aL(aO,true))}for(var aN=4;aN<=10;aN++){aR.push(aX(aN,false));aP.push(aX(aN,true))}var aY=10;var aM=10;for(var aK=0;aK<10;aK++){if(aU==aR[aK].Id){aM=aK;break}}for(var aJ=0;aJ<10;aJ++){if(aU==aP[aJ].Id){aY=aJ;break}}if(aY<aM){K("你在防守方输出为第"+(aY+1)+"位，选择输出在 防守方");return"defender"}else{if(aY>aM){K("你在进攻方输出为第"+(aM+1)+"位，选择输出在 进攻方");return"attacker"}else{if(aY<10){if(aR[aY].Damage<aP[aY].Damage){K("你在双方输出均为第"+(aY+1)+"位，但在防守方伤害较高，选择输出在 防守方");return"defender"}else{if(aR[aY].Damage>aP[aY].Damage){K("你在双方输出均为第"+(aY+1)+"位，但在进攻方伤害较高，选择输出在 防守方");return"attacker"}else{K("你在双方输出均为第"+(aY+1)+"位，且伤害相同");return aI()}}}else{if(C==2){return aV(aR,aP)}else{if(C==3){return aS(aR,aP)}else{if(C==4){return aQ(aR,aP)}else{if(C==5){return aI()}else{return aI()}}}}}}}}else{return aI()}}}}}}}}function ay(){if(J==true){K("等待跳转到工作页");return}if(al()=="battle"){aq=0;if($(".testDivred").length>0){K("该战场被冻结");l();return}else{if($("#fightButton2").length>0){ar(at())}else{if($("#fightButton1").length>0){ar("side")}else{l();return}}}}else{l();return}}if(al()=="battle"){if(A>0){if(Date.now()>A){K("超过设定时间，关闭自动清体",1000000);return}else{K("即将在"+ac(new Date(A))+"停止自动清体功能")}}if(h>0){var av=ah(0,100);if(h>av){K("因为概率设置，本次不会清体");aB();return}}if(af==parseInt($('a[href^="battleStatistics.html?id="]').attr("href").replace("battleStatistics.html?id=",""))){if(B>0){var aA=ah(0,100);if(B>aA){var aF=aC();var aD=parseInt($("#minutesLimit").text().split(":")[0]);var az=parseInt($("#secondsLimit").text());if((aD<0)||isNaN(aD)){aD=0}if((az<0)||isNaN(az)){az=0}var aE=aF-(aD*60+az);if((aF>0)&&(aE<0)&&(aF<v*60)){S=r;Q=q;F=m;c=T;var au=ah(s,Y);var aG=(aF-au)*1000;K("该场为重要战场，将于 S"+au+" 压秒",1000000);setTimeout(function(){ay()},aG);return}else{K("该场为重要战场，程序将在回合最后"+v+"分钟进行判断");ay();return}}else{K("虽然该场为重要战场，但因为概率设置，本次不进行压秒判断");ay();return}}else{K("虽然该场为重要战场，但是压秒概率为0，将忽略压秒设置");ay();return}}else{ay();return}}else{K("非战场页面");ay();return}}
