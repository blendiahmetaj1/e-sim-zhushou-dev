// ==UserScript==
// @name         e-sim xaria 战车是怎样炼成的
// @namespace    ESX
// @version      0.5.13-release
// @description  xaria服自动双击、自动清空体力，自动清空体力功能需要在战场页才能触发
// @author       Exsper
// @match        http://testura.e-sim.org:8000/*
// @match        https://testura.e-sim.org:8000/*
// @match        http://xaria.e-sim.org/*
// @match        https://xaria.e-sim.org/*
// @require      http://cdn.e-sim.org/js/jquery-1.8.3.min.js
// @grant        GM_addStyle
// @run-at       document-start
// ==/UserScript==

//敬请牢记：如果您安装或使用本插件，就默认您已经承诺：不与任何人在任何场合分享插件的全部或部分内容；不在插件开发群以外的地方讨论插件相关问题或功能；在游戏截图前首先关闭所有插件再截图
//敬请牢记：如果您违背了您的承诺，您将失去所有esim插件未来版本的使用权并可能受到诸多方面的惩罚

//前排提醒：该插件有些特殊功能需要先开启e-sim助手（获取盟友、显示伤害），但如果不需要这些功能也可以脱离e-sim助手独立运行
//前排提醒：在自动寻找战场时，插件不会优先选择盟友场或是重要战场，而是寻找到能打的战场就立即跳转

// ==UserScript==
// @name         e-sim xaria 战车是怎样炼成的
// @namespace    ESX
// @version      0.5.13-release
// @description  xaria服自动双击、自动清空体力，自动清空体力功能需要在战场页才能触发
// @author       Exsper
// @match        http://testura.e-sim.org:8000/*
// @match        https://testura.e-sim.org:8000/*
// @match        http://xaria.e-sim.org/*
// @match        https://xaria.e-sim.org/*
// @require      http://cdn.e-sim.org/js/jquery-1.8.3.min.js
// @grant        GM_addStyle
// @run-at       document-start
// ==/UserScript==

//敬请牢记：如果您安装或使用本插件，就默认您已经承诺：不与任何人在任何场合分享插件的全部或部分内容；不在插件开发群以外的地方讨论插件相关问题或功能；在游戏截图前首先关闭所有插件再截图
//敬请牢记：如果您违背了您的承诺，您将失去所有esim插件未来版本的使用权并可能受到诸多方面的惩罚

//前排提醒：该插件有些特殊功能需要先开启e-sim助手（获取盟友、显示伤害），但如果不需要这些功能也可以脱离e-sim助手独立运行
//前排提醒：在自动寻找战场时，插件不会优先选择盟友场或是重要战场，而是寻找到能打的战场就立即跳转

var al=true;var W=true;var M=true;var I=false;var L=0;var z=0;var y=50;var D=1;var R=0;var B=0;var k=true;var U=-1;var e=true;var T;var O=true;var w=["China","Taiwan"];var aj=[];var Y=true;var G=true;var am=true;var o=true;var i=true;var t="battles.html?countryId=-1&sorting=BY_TOTAL_DAMAGE";var ao=true;var b=true;var H=4;var E=600;var c=3000;var P=false;var af=20;var x=240;var h=20;var ae=-1;var v=10;var A=50;var X=20;var s=5;var r=0;var q=false;var m=400;var S=800;var F=0;var aa=-1;var n=5*1000;var ad=10000;$.info=function(){var aq,ar,au,aw,av,at,ap;if(arguments.length==1){av=arguments[0];at=ad}else{if(arguments.length==2){av=arguments[0];at=arguments[1]}else{return}}aq=$("#ESXMessageDiv");aq.css({display:"block"}).append('<div class="esxmsg">'+av+"</div>");aw=aq.children("div");au=aw.eq(-1);if(aw.length>10){aw.eq(0).mouseenter()}ap=au.width();au.css({left:-ap,opacity:0}).animate({left:0,opacity:1},200,function(){return au.delay(at).animate({left:-ap,opacity:0},200,function(){au.remove()})});return aw.eq(-1)};function ah(aq,ar,ap){aq="ESX-"+aq;if(ap===true){localStorage.setItem(aq,JSON.stringify(ar.split(",")))}else{localStorage.setItem(aq,JSON.stringify(ar))}}function C(aq,ap){aq="ESX-"+aq;if(ap===true){return(aq in localStorage)?JSON.parse(localStorage.getItem(aq)).join(","):null}else{return(aq in localStorage)?JSON.parse(localStorage.getItem(aq)):null}}function Q(ap,aq){localStorage["ESX-"+ap]=aq}function V(ap){ap="ESX-"+ap;return(ap in localStorage)?localStorage[ap]:null}function ac(ap){ap="ESX-"+ap;localStorage.removeItem(ap)}function an(aq,ap){var ar=V(aq);if(ar==null){return ap}else{if(typeof ap=="string"){return ar}else{if(typeof ap=="number"){return parseInt(ar)}else{if(typeof ap=="boolean"){return(ar=="true")}else{return ar}}}}}f();setTimeout(function(){location.reload()},30*60*1000);function ag(at,ap){var ar=ap-at;var aq=Math.random()*ar+at;aq=parseInt(aq,10);return aq}function ab(au){var ar=au.getHours();var at=au.getMinutes();var aq=au.getSeconds();var ap="";if(ar<10){ap+="0"}ap+=ar+":";if(at<10){ap+="0"}ap+=at+":";if(aq<10){ap+="0"}ap+=aq;return(ap)}function g(au){if($("#Eh2Homeland").length>0){w=[];w.push($("#Eh2Homeland").children("div").attr("title"));if(V("EHAllies")=="true"){var at=$("#Eh2Allies").children("div");for(var ar=0;ar<at.length;ar++){w.push(at[ar].title)}}if(V("EHCoalition")=="true"){var aq=$("#Eh2CoalitionMembers").children("div");for(var ap=0;ap<aq.length;ap++){w.push(aq[ap].title)}}w=$.unique(w.sort());ah("Allies",w);au.val(w.join(","));J("获取到盟友："+w)}else{J("e-sim助手未运行或版本不兼容")}}function u(ar){if($("#Eh2Homeland").length>0){aj=[];if(V("EHEnemies")=="true"){var aq=$("#Eh2Enemies").children("div");for(var ap=0;ap<aq.length;ap++){aj.push(aq[ap].title)}}ah("Enemies",aj);ar.val(aj.join(","));J("获取到敌人："+aj)}else{J("e-sim助手未运行或版本不兼容")}}function Z(){al=an("IsRunning",al);W=an("EnableWorkTrain",W);M=an("EnableAutoFight",M);I=an("IsWorkingTraining",I);D=an("FlightTicketQuality",D);L=an("ErrorRefreshedCount",L);k=an("BackToRegion",k);U=an("OriginRegionId",U);e=an("BackToBattle",e);T=an("OriginBattleUrl",T);O=an("FightForAlly",O);w=C("Allies");aj=C("Enemies");Y=an("EHAllies",Y);G=an("EHEnemies",G);am=an("EHCoalition",am);R=an("FightWeaponQuality",R);E=an("FightWaitMin",E);c=an("FightWaitMax",c);af=an("NextRefreshExtendWaitMin",af);x=an("NextRefreshExtendWaitMax",x);h=an("SleepProbability",h);A=an("AFCTiggerProbability",A);X=an("AFCRefreshInTimeLeftMax",X);s=an("AFCRefreshInTimeLeftMin",s);ae=an("AFCTargetBattleID",ae);r=an("AFCFightWeaponQuality",r);q=an("AFCFightByHitOnly",q);m=an("AFCFightWaitMin",m);S=an("AFCFightWaitMax",S);P=an("FightByHitOnly",P);F=an("HitUsingWeapon",F);aa=an("MaxHitUsingWeapon",aa);B=an("FightDefaultSide",B);o=an("AutoSearchBattle",o);t=an("SearchBattleUrl",t);ao=an("AutoFlyToBattle",ao);b=an("SearchBattleShuffle",b);n=an("AjaxTimeout",n)}function p(){ac("IsRunning");ac("EnableWorkTrain");ac("EnableAutoFight");ac("IsWorkingTraining");ac("FlightTicketQuality");ac("ErrorRefreshedCount");ac("BackToRegion");ac("OriginRegionId");ac("BackToBattle");ac("OriginBattleUrl");ac("FightForAlly");ac("Allies");ac("Enemies");ac("EHAllies");ac("EHEnemies");ac("EHCoalition");ac("FightWeaponQuality");ac("FightWaitMin");ac("FightWaitMax");ac("NextRefreshExtendWaitMin");ac("NextRefreshExtendWaitMax");ac("SleepProbability");ac("AFCTiggerProbability");ac("AFCRefreshInTimeLeftMax");ac("AFCRefreshInTimeLeftMin");ac("AFCTargetBattleID");ac("AFCFightWeaponQuality");ac("AFCFightByHitOnly");ac("AFCFightWaitMin");ac("AFCFightWaitMax");ac("FightByHitOnly");ac("HitUsingWeapon");ac("MaxHitUsingWeapon");ac("FightDefaultSide");ac("AutoSearchBattle");ac("SearchBattleUrl");ac("AutoFlyToBattle");ac("SearchBattleShuffle");ac("AjaxTimeout")}function K(){function av(aR,aQ,aM,aN,aL){var aP=$("<input>",{type:"checkbox",style:"vertical-align:5px;",id:aQ});var aO=$("<label>",{"class":"checkboxlabel","for":aQ,text:aM});var aK=V(aN);if(aK===null){Q(aN,aL);aP.attr("checked",aL==true)}else{aP.attr("checked",aK=="true")}aR.append(aP,aO);aP.click(function(){if(aP.is(":checked")){Q(aN,true)}else{Q(aN,false)}})}function aq(aP,aT,aQ,aK,aL,aR){var aN=$("<span>",{style:"padding:3px; margin:3px",text:aT});var aO=$("<select>",{style:"padding:3px; margin:3px"}).appendTo(aN);for(var aM=0;aM<aQ.length;aM++){$("<option>",{value:aQ[aM],text:aK[aM]}).appendTo(aO)}var aS=V(aL);if(aS===null){Q(aL,aR);aO.val(aR)}else{aO.val(aS)}aP.append(aN);aO.change(function(){Q(aL,aO.val())})}function az(aO,aN,aM,aL){var aP=$("<input>",{type:"text",id:"ESX-"+aM,style:"vertical-align:5px;width:"+aN+"px;height:20px;"}).appendTo(aO);var aK=V(aM);if(aK===null){Q(aM,aL);aP.val(aL)}else{aP.val(aK)}aO.append(aP);aP.focus(function(){aP.css("background-color","#FFFFFF")});aP.blur(function(){if(aP.val()===""){aP.val(aL)}aP.css("background-color","#79FF79");Q(aM,aP.val())})}function aD(aO,aN,aM,aL){var aP=$("<input>",{type:"text",id:"ESX-"+aM,style:"vertical-align:5px;width:"+aN+"px;height:20px;"}).appendTo(aO);var aK=C(aM,true);if(aK===null){ah(aM,aL);aP.val(aL.join(","))}else{aP.val(aK)}aO.append(aP);aP.focus(function(){aP.css("background-color","#FFFFFF")});aP.blur(function(){if(aP.val()===""){aP.val(aL.join(","))}aP.css("background-color","#79FF79");ah(aM,aP.val(),true)})}var aw=$("<li>",{id:"ESXIcon"}).insertBefore($("#userAvatar"));var aH=$("<a>",{"data-dropdown":"ESXContentDrop",style:"padding:0 5px;",href:"#"}).appendTo(aw);var aJ=$("<img>",{align:"absmiddle","class":"smallAvatar",style:"height:36px; width:36px;",src:"http://cdn.e-sim.org/img/eventIcons/battleLostIcon.png"}).appendTo(aH);var aA=$("#contentDrop").clone().attr("id","ESXContentDrop").empty().insertBefore($("#contentDrop"));aA.removeClass("medium");aA.addClass("large");$("<b>",{text:"xaria 战车是怎样炼成的 "+GM_info.script.version}).appendTo(aA);var au=$("<span>",{text:"捐赠",style:"float:right;"}).appendTo(aA);au.click(function(){aC()});function aC(){var aL=$("<div>",{"class":"dwindow",style:"overflow:auto; width:300px; height:380px; display:block; position:fixed; top:50%; left:50%; margin-left: -225px; margin-top: -150px; padding-bottom: 20px; text-align:center;background-color:lightgray;"}).appendTo($("body"));$("<p>e-sim插件开发不易，您的无私奉献是我们努力的肯定与支持，让我们做得更好</p>").appendTo(aL);$("<p>QQ钱包</p>").appendTo(aL);var aM=$("<div></div>").appendTo(aL);aM[0].innerHTML='<img src="https://puu.sh/Ad7wr/10f301077b.png"/>';$("<br>").appendTo(aL);var aK=$("<button>",{text:"关闭"}).appendTo(aL);aK.click(function(){aL.remove()})}$("<div>",{style:"text-align:center;",text:"自动清空体力、自动双击。珍惜账号，慎用自动。设置更改刷新后生效。"}).appendTo(aA);var aE=$("<table>",{id:"ESXConfig",style:"width:100%;line-height:30px"}).appendTo(aA);var ap=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aE);var at=$("<td>").appendTo(ap);av(at,"IsRunCheckbox","启用该插件","IsRunning",al);av(at,"EnableWorkTrainCheckbox","启用双击功能","EnableWorkTrain",W);av(at,"EnableAutoFightCheckbox","启用打枪功能","EnableAutoFight",M);ap=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aE);at=$("<td>").appendTo(ap);aq(at,"输出使用武器：",[0,1,2,3,4,5],["拳头","Q1","Q2","Q3","Q4","Q5"],"FightWeaponQuality",R);av(at,"FightByHitOnlyCheckbox","不使用连击","FightByHitOnly",P);aq(at,"超出次数则使用空手：",[-1,0,1,2,3,4,5,6,7,8,9,10],["不限制","0","1","2","3","4","5","6","7","8","9","10"],"MaxHitUsingWeapon",aa);ap=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aE);at=$("<td>").appendTo(ap);aq(at,"可以打两边时选择输出方：",[-1,0,1,2,3,4,5],["随机","防守方","进攻方","尽量拿到top1","尽量拿到top3","尽量拿到top10","随机但尽量打在一边"],"FightDefaultSide",B);av(at,"FightForAllyCheckbox","起义场优先打盟友方或对抗敌方","FightForAlly",O);ap=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aE);at=$("<td>").appendTo(ap);$("<span>",{text:"设置盟友（以半角逗号分隔）："}).appendTo(at);aD(at,400,"Allies",w);ap=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aE);at=$("<td>").appendTo(ap);$("<span>",{text:"设置敌国（以半角逗号分隔）："}).appendTo(at);aD(at,400,"Enemies",aj);ap=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aE);at=$("<td>").appendTo(ap);var aI=$("<button>",{text:"从E-sim助手获取盟友和敌国"}).appendTo(at);aI.click(function(){g($("#ESX-Allies"));u($("#ESX-Enemies"))});av(at,"EHAlliesCheckbox","获取盟友","EHAllies",Y);av(at,"EHCoalitionCheckbox","获取联盟成员国","EHCoalition",am);av(at,"EHEnemiesCheckbox","获取敌国","EHEnemies",G);ap=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aE);at=$("<td>").appendTo(ap);ap=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aE);at=$("<td>").appendTo(ap);$("<span>每次攻击间隔（毫秒）：</span>").appendTo(at);az(at,60,"FightWaitMin",E);$("<span> 到 </span>").appendTo(at);az(at,60,"FightWaitMax",c);$("<span>打枪请求超时限制：</span>").appendTo(at);az(at,60,"AjaxTimeout",n);$("<span>毫秒</span>").appendTo(at);var ay=$("<button>",{text:"Ping一下"}).appendTo(at);ay.click(function(){$.ping=function(aN){var aP,aM,aO;var aL=function(aR){var aQ="^((https|http)?://){1}";var aS=new RegExp(aQ);return aS.test(aR)?aR:"http://"+aR};$.ajax({url:aN.url,type:"GET",dataType:"html",timeout:20000,beforeSend:function(){if(aN.beforePing){aN.beforePing()}aM=new Date().getTime()},complete:function(){aO=new Date().getTime();aP=Math.abs(aM-aO);if(aN.afterPing){aN.afterPing(aP)}},error:function(aQ,aS,aR){if(aS=="timeout"){J("Ping超时")}aO=new Date().getTime();aP=Math.abs(aM-aO);if(aN.afterPing){aN.afterPing(aP)}}});if(aN.interval&&aN.interval>0){var aK=aN.interval*1000;setTimeout(function(){$.ping(aN)},aK)}};$.ping({url:"http://xaria.e-sim.org",afterPing:function(aK){J("延迟： "+aK+" 毫秒")}})});ap=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aE);at=$("<td>").appendTo(ap);$("<span>清空体力后下次刷新额外延时（秒）：</span>").appendTo(at);az(at,60,"NextRefreshExtendWaitMin",af);$("<span> 到 </span>").appendTo(at);az(at,60,"NextRefreshExtendWaitMax",x);ap=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aE);at=$("<td>").appendTo(ap);$("<span>每次刷新后均有</span>").appendTo(at);az(at,60,"SleepProbability",h);$("<span>%的概率不进行自动清体</span>").appendTo(at);ap=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aE);at=$("<td>").appendTo(ap);$("<span>重要战场回合剩余时间小于"+v+"分钟，则有</span>").appendTo(at);az(at,20,"AFCTiggerProbability",A);$("<span>%的概率在回合结束前S</span>").appendTo(at);az(at,20,"AFCRefreshInTimeLeftMax",X);$("<span>到S</span>").appendTo(at);az(at,20,"AFCRefreshInTimeLeftMin",s);$("<span>之间（压秒）</span><br/>").appendTo(at);$("<span>每次攻击间隔（毫秒）：</span>").appendTo(at);az(at,60,"AFCFightWaitMin",m);$("<span> 到 </span>").appendTo(at);az(at,60,"AFCFightWaitMax",S);aq(at,"使用武器：",[0,1,2,3,4,5],["拳头","Q1","Q2","Q3","Q4","Q5"],"AFCFightWeaponQuality",r);av(at,"AFCFightByHitOnlyCheckbox","不使用连击","AFCFightByHitOnly",q);$("<br/>").appendTo(at);var ax=$("<button>",{text:"设置当前战场为重要战场"}).appendTo(at);ax.click(function(){ae=parseInt($('a[href^="battleStatistics.html?id="]').attr("href").replace("battleStatistics.html?id=",""));Q("AFCTargetBattleID",ae);J("设置战场 "+ae+" 为重要战场")});var ar=$("<button>",{text:"清除重要战场"}).appendTo(at);ar.click(function(){ae=-1;Q("AFCTargetBattleID",ae);J("已清除记录的重要战场")});ap=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aE);at=$("<td>").appendTo(ap);aq(at,"工作飞行使用机票：",[1,2,3,4,5],["Q1","Q2","Q3","Q4","Q5"],"FlightTicketQuality",D);av(at,"BackToRegionCheckbox","双击后飞回原所在地（请确保机票足够）","BackToRegion",k);av(at,"BackToBattleCheckbox","双击后回到原战场","BackToBattle",e);ap=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aE);at=$("<td>").appendTo(ap);av(at,"AutoSearchBattleCheckbox","战场页没有输出按钮时自动寻找第一个可输出战场","AutoSearchBattle",o);av(at,"AutoFlyToBattleCheckbox","如果找不到战场则飞向第一个起义战地区","AutoFlyToBattle",ao);ap=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aE);at=$("<td>").appendTo(ap);av(at,"SearchBattleShuffleCheckbox","打乱战场列表，以避免总是选择第一个可输出战场","SearchBattleShuffle",b);ap=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aE);at=$("<td>").appendTo(ap);$("<span>",{text:"搜寻战场列表地址："}).appendTo(at);az(at,400,"SearchBattleUrl",t);ap=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(aE);at=$("<td>").appendTo(ap);var aG=$("<button>",{text:"测试搜寻战场"}).appendTo(at);aG.click(function(){t=V("SearchBattleUrl");l()});var aF=$("<button>",{text:"重置双击设置",title:"如果因双击错误导致无法自动输出，请点击此按钮"}).appendTo(at);aF.click(function(){ac("IsWorkingTraining");ac("OriginRegionId");ac("OriginBattleUrl")});var aB=$("<button>",{text:"重置所有设置",title:"插件运行遇到问题？尝试重置插件吧"}).appendTo(at);aB.click(function(){p()})}function f(){z=parseInt(V("WaitForLoadCount"));if($(".time").length!==2){z++;if(z<=y){Q("WaitForLoadCount",z);console.log(z+":网页未加载完全，xaria插件等待1秒");setTimeout(f,1000);return}else{Q("WaitForLoadCount",0);location.reload();return}}var aq=$(".time:first").text().match(/-/g);if(aq==null||aq.length!=2){z++;if(z<=y){Q("WaitForLoadCount",z);console.log(z+":官方脚本还未执行，xaria插件等待0.5秒");setTimeout(f,500);return}else{Q("WaitForLoadCount",0);location.reload();return}}if($("#minutesLimit").text()==""){z++;if(z<=y){console.log(z+":官方时间还未刷新，xaria插件等待0.5秒");setTimeout(f,500);return}else{Q("WaitForLoadCount",0);location.reload();return}}Q("WaitForLoadCount",0);N();K();Z();if(al==false){J("xaria插件未启动");return}if(W==true){if((k==true)&&(ak()=="battle")){var ar=$('a[href^="region.html?id="][href!="region.html?id="]');var ap=parseInt(ar.first().attr("href").split("=")[1]);Q("OriginRegionId",ap)}if((e==true)&&(ak()=="battle")){Q("OriginBattleUrl",location.href)}j()}if((M==true)&&(ak()=="battle")){setTimeout(function(){ai()},2000);return}}function N(){GM_addStyle(".esxmsg{background-color: #fff;border-left: 4px solid #7ad03a;-webkit-box-shadow: 0 1px 1px 0 rgba(0,0,0,.1);}");var ap=$("<div>",{id:"ESXMessageDiv",style:"position:fixed; bottom:5%;"}).appendTo("body")}function J(ap,aq){console.log(ap);if(aq==undefined){$.info(ap)}else{$.info(ap,aq)}}function ak(){if(document.URL.search("html")!=-1){return document.URL.match("/([a-zA-Z0-9]+).html")[1]}else{return"index"}}function j(){function aq(){var ax=$("#trainButton");if(ax.length<=0){W=false;Q("EnableWorkTrain",false);I=false;Q("IsWorkingTraining",false);alert("错误：未训练却没有训练按钮，已自动关闭双击功能")}else{ay()}function ay(){$.ajax({type:"POST",url:"train/ajax",data:null,success:function(aA){var az=$("#trainButton",aA);if((az.length<1)&&($("#userMenu",aA).length<1)){ar()}else{W=false;Q("EnableWorkTrain",false);I=false;Q("IsWorkingTraining",false);alert("错误：训练失败，已自动关闭双击功能")}$("#trainReload").html(aA)}})}}function au(){var aA=$("#workButton");if(aA.length<1){W=false;Q("EnableWorkTrain",false);I=false;Q("IsWorkingTraining",false);alert("错误：未工作却没有工作按钮，已自动关闭双击功能")}else{var aB=$('a[href^="region.html?id="][href!="region.html?id="]');var ay=aB.first().parent().find("div").attr("class");ay=ay.substring(ay.indexOf("-")+1);var ax=aB.last().parent().find("div").attr("class");ax=ax.substring(ax.indexOf("-")+1);if(ay==ax){az()}else{document.location=aB.last().attr("href")}}function az(){$.ajax({type:"POST",url:"work/ajax?action=work",data:null,success:function(aC){$("#workReload").html(aC);var aD=$("#workButton",aC);if((aD.length<1)&&($("#userMenu",aC).length<1)){document.location="/train.html"}else{W=false;Q("EnableWorkTrain",false);I=false;Q("IsWorkingTraining",false);alert("错误：工作失败，已自动关闭双击功能")}}})}}function ap(){$("#ticketQuality").val(D);var ax=$(".travel.button.foundation-style");ax[0].click()}function av(){var ax=$(".testDivred");if(ax.length>0){W=false;Q("EnableWorkTrain",false);I=false;Q("IsWorkingTraining",false);alert("飞行出错："+$(".testDivred :last")[0].childNodes[1].nodeValue+"，已自动关闭双击功能")}else{document.location="/work.html"}}function aw(ax){I=true;Q("IsWorkingTraining","true");if(ax==true){setTimeout(function(){document.location="/work.html"},30*1000)}else{document.location="/work.html"}}function ar(){I=false;Q("IsWorkingTraining","false");if(k==true){var az=$('a[href^="region.html?id="][href!="region.html?id="]');var ax=parseInt(az.first().attr("href").split("=")[1]);if((U!=-1)&&(ax!=U)){J("飞回地区："+U);var ay;$.ajax({url:"region.html?id="+U,async:false,success:function(aA){ay=parseInt($("#countryId",aA).val())},error:function(aA,aB){console.log("地区页抓取错误 (",aB,")，重新抓取");$.ajax(this)}});$.ajax({url:"travel.html",type:"POST",async:false,data:{countryId:ay,regionId:U,ticketQuality:D},success:function(aA){var aB=$("div.testDivred",aA);if(aB.length===1){J("飞行失败："+aB.text().trim())}else{J("飞行成功！")}},error:function(aA,aB){console.log("飞行错误 (",aB,")")}})}}if(e==true){J("返回战场："+T);document.location=T}else{if((M==true)&&(o==true)){l()}else{J("双击结束，等待下次双击")}}}function at(){if(I==false){if(($("#taskButtonWork").length>0)||($("#taskButtonTrain").length>0)){var az=parseFloat($("#actualHealth").html());var ax=50-D*10;if(k==true){if((az-ax*2)>=0){aw(false);return}else{J("可能由于人工操作，你当前的体力不足以飞行两次，程序将于30秒后再自动双击，请尽快补充体力");aw(true);return}}else{if((az-ax)>=0){aw(false);return}else{J("可能由于人工操作，你当前的体力不足以飞行到工作地，程序将于30秒后再自动双击，请尽快补充体力");aw(true);return}}}}else{var ay=ak();if(ay=="work"){au()}else{if(ay=="train"){aq()}else{if(ay=="region"){ap()}else{if(ay=="travel"){av()}else{Q("IsWorkingTraining",false);return}}}}}}at()}function d(){if(M==true){M=false;if(L<=0){L++;Q("ErrorRefreshedCount",L);location.reload()}else{L++;Q("ErrorRefreshedCount",L);var ap=(L-1)*30;J("自动攻击出错，"+ap+"秒后自动刷新",1000000);setTimeout(function(){location.reload()},ap*1000)}}}function l(){function ar(az){var ay=false;$.ajax({url:az,async:false,success:function(aA){if($(".time",aA).length!==2){console.log(citizenId,"抓取错误，重新抓取");$.ajax(this);return}if($(".testDivred",aA).length>0){ay=false}else{if($("#fightButton2",aA).length>0){ay=true}else{if($("#fightButton1",aA).length>0){ay=true}else{ay=false}}}},error:function(aA,aB){console.log("抓取错误 (",aB,")，重新抓取");$.ajax(this)}});return ay}function av(aA){var ay=false;var az=0;var aC=0;var aB=$("form[action='travel.html']",aA);if(aB.length>0){az=parseInt(aB.children("#countryId").val());aC=parseInt(aB.children("#regionId").val());if((az>0)&&(aC>0)){$.ajax({url:"travel.html",type:"POST",async:false,data:{countryId:az,regionId:aC,ticketQuality:D},success:function(aD){var aE=$("div.testDivred",aD);if(aE.length===1){J("飞行失败："+aE.text().trim())}else{J("飞行成功！");ay=true}},error:function(aD,aE){console.log("飞行错误 (",aE,")")}})}return ay}else{return false}}function aw(az){var ay=false;$.ajax({url:az,async:false,success:function(aA){if($(".time",aA).length!==2){console.log(citizenId,"抓取错误，重新抓取");$.ajax(this);return}ay=av(aA)},error:function(aA,aB){console.log("抓取错误 (",aB,")，重新抓取");$.ajax(this)}});return ay}function aq(aB){for(var az,ay,aA=aB.length;aA;az=parseInt(Math.random()*aA),ay=aB[--aA],aB[aA]=aB[az],aB[az]=ay){}return aB}function au(ay){J("寻找战场："+ay);var az=[];$.ajax({url:ay,async:false,success:function(aA){if($(".time",aA).length!==2){console.log(citizenId,"抓取错误，重新抓取");$.ajax(this);return}$("#battlesTable tr:gt(0)",aA).each(function(aB,aD){var aC=$("a[href*='battle.html']",aD);if(aC==null){return true}az.push(aC.attr("href"))})},error:function(aA,aB){console.log("抓取错误 (",aB,")，重新抓取");$.ajax(this)}});console.log("获取到的战场列表:"+az);return az}function ax(){var aA;if(($("#taskButtonFight").length>0)&&(i==true)){aA=au($("#taskButtonFight").children().attr("href"))}else{aA=au(t)}if(b==true){aA=aq(aA)}for(var ay=0;ay<aA.length;ay++){var az=ar(aA[ay]);console.log(aA[ay]+":"+az);if(az==true){return aA[ay]}}return"-1"}function ap(){var aA=au(t);if(b==true){aA=aq(aA)}for(var ay=0;ay<aA.length;ay++){var az=aw(aA[ay]);console.log(aA[ay]+":"+az);if(az==true){return aA[ay]}}return"-1"}function at(){var ay=ax();if(ay!="-1"){document.location=ay}else{if(ao==false){J("未找到可以打的战场，10分钟后重新寻找");setTimeout(function(){at()},600*1000)}else{J("未找到可以打的战场，尝试飞行到"+t+"列表里的第一场起义战");ay=ap();if(ay!="-1"){document.location=ay}else{J("未找到可以飞的起义战，10分钟后重新寻找");setTimeout(function(){at()},600*1000)}}}}if(o==true){J("30秒后开始寻找可以输出的战场");setTimeout(function(){at()},30*1000)}else{J("该战场当前无法输出")}}function ai(){var ap=0;function aw(aO){function aI(aZ){aZ+="";var aX=aZ.split(".");var aY=/(\d{1,3})(?=(\d{3})+$)/g;return aX[0].replace(aY,"$1,")+(aX.length==2?"."+aX[1]:"")}var aV=$("#showMsg");aV.text("");aV.show();var aK=$("#DamageDone",aO);if(aK.length>0){var aT=parseInt(aK.text().replace(/,/g,"").replace(/\xA0/g,""));var aW=$(".fightsprite",aK.parent().parent());var aP={bomb:["grey","无暴击(pain dealer)"],tank:["grey","无坦克(tank)"],syringe:["grey","无类固醇(steroid)"],airplane:["grey","无地点加成"],bookmark:["grey","无军令加成"]};var aQ={absorbed:["loved",["lightgreen","闪避(avoid)"]],mu:["bookmark",["lightgreen","有军令加成"]],location:["airplane",["lightgreen","有地点加成"]],STEROIDSplus:["syringe",["lightgreen","有类固醇(steroid)"]],STEROIDSminus:["syringe",["pink","类固醇副作用(steroid)"]],TANKplus:["tank",["lightgreen","有坦克(tank)"]],TANKminus:["tank",["pink","坦克副作用(tank)"]],xp1:["xp",1],xp5:["xp",5],PAIN_DEALER_1_Hplus:["bomb",["lightgreen","1小时暴击(pain dealer)"]],PAIN_DEALER_10_Hplus:["bomb",["lightgreen","10小时暴击(pain dealer)"]],PAIN_DEALER_25_Hplus:["bomb",["lightgreen","25小时暴击(pain dealer)"]]};for(var aN=0;aN<aW.length;++aN){var aU=aW.eq(aN).attr("class").split(" ").pop();if(aU in aQ){var aJ=aQ[aU];aP[aJ[0]]=aJ[1]}}var aL="";var aM=aP.xp;delete aP.xp;for(aN in aP){aL='<i style="color:'+aP[aN][0]+';" class="icon-'+aN+'" title="'+aP[aN][1]+'"></i>'+aL}aL+='<b title="'+aM+'次攻击">x'+aM+"</b>";var aH=$("#fightHistory");var aS=$("div[class^=foundation-style]",aH);if(aS.length===6){$("#ehHistoryExpand").show()}aS.slice(0,2).attr("style","opacity:0.6;");aS.slice(2,4).attr("style","opacity:0.3;");if($("#ehHistoryExpand").is(":hidden")===false){aS.slice(4,6).hide()}var aR=($("#fightResult>div").attr("class").split(" ").pop().indexOf("critical")!==-1);if(aR){aH.prepend($("<div>",{"class":"foundation-style small-6 columns foundation-text-right",html:aL}),$("<div>",{"class":"foundation-style small-4 columns foundation-text-right critical",text:aK.text()}))}else{aH.prepend($("<div>",{"class":"foundation-style small-6 columns foundation-text-right",html:aL}),$("<div>",{"class":"foundation-style small-4 columns foundation-text-right",text:aK.text()}))}$("#ehHitsNumber").text(parseInt($("#ehHitsNumber").text())+aM);$("#ehTotalDamage").text(aI(parseInt($("#ehTotalDamage").text().replace(/,/g,"").replace(/\xA0/g,""))+aT))}else{aV.text($("#fightResponse").text().trim());aV.fadeOut(2000)}}function aG(){if(aa<0){F++;Q("HitUsingWeapon",F);if(R<=0){return 0}else{var aI=parseInt($("#Q"+R+"WeaponStock").text());if(aI<=0){return 0}else{return R}}}else{if(F>=aa){return 0}else{F++;Q("HitUsingWeapon",F);if(R<=0){return 0}else{var aH=parseInt($("#Q"+R+"WeaponStock").text());if(aH<=0){return 0}else{return R}}}}}function av(aI,aL){var aH=aG();if(!(aH>=0&&aH<=5)){aH=0}console.log("使用Q"+aH+"，side="+aI+"，value="+aL);var aJ="weaponQuality="+aH+"&battleRoundId="+$("#battleRoundId").val()+"&side="+aI+"&value="+aL;var aK=$.ajax({type:"POST",url:"fight.html",timeout:n,data:aJ,success:function(aP){$("#fightResponse > div").replaceWith(aP);if($("#showMsg").length>0){aw($(aP))}var aO=$("#healthUpdate",aP).text();if(aO!==""){var aM=aO.substr(0,aO.length-3);if(aM<100){$("#healthProgress div.ui-corner-right").removeClass("ui-corner-right")}$("#healthProgress .ui-progressbar-value").animate({width:aM+"%"},{queue:false});$("#healthProgress").attr("title",aM+" / 100");$("#actualHealth").html(aM);var aN=$("#DamageDone",aP);if(aN.length<0){console.log($("#fightResponse").text().trim());ap++;if(ap>H){d()}}else{if(ap>0){ap=0}if(L>0){L=0;Q("ErrorRefreshedCount",0)}}}else{ap++;J("攻击出错："+$("#fightResponse").text().trim()+"("+ap+")");if(ap>H){d()}}},error:function(aM,aO,aN){ap++;if(aO=="timeout"){J("攻击出错：超时("+ap+")")}else{J("攻击出错：错误码"+aM.status+"("+ap+")")}if(ap>H){d()}return false}})}function aB(){var aI=$("#roundCountdown").children().text();var aH=aI.split(":");if(aH.length==3){return(parseInt(aH[0])*3600+parseInt(aH[1])*60+parseInt(aH[2]))}else{return -1}}function aA(){var aJ=parseInt($("#minutesLimit").text().split(":")[0]);var aI=parseInt($("#secondsLimit").text());if((aJ<0)||isNaN(aJ)){aJ=0}if((aI<0)||isNaN(aI)){aI=0}var aH=ag((aJ*60+aI+af)*1000,(aJ*60+aI+x)*1000);J("将于 "+ab(new Date(Date.now()+aH))+" 刷新",1000000);setTimeout(function(){location.reload()},aH)}function aq(aI){if(M==false){J("打枪功能未启用或已暂停");return}var aH;var aJ=parseFloat($("#actualHealth").html());if(aJ>=10){aH=ag(E,c);if((aJ>=50)&&(P==false)){av(aI,"Berserk");J(aH+"ms后连击");setTimeout(function(){aq(aI)},aH)}else{av(aI,"undefined");J(aH+"ms后单击");setTimeout(function(){aq(aI)},aH)}}else{Q("HitUsingWeapon",0);aA()}}function ar(){function aK(a1,a2){var a0={};var aY=0;var aZ=0;var a3;if(a2==true){a3=$("#topDefender"+a1)}else{a3=$("#topAttacker"+a1)}if((a3.length>0)&&(a3.children().length>0)){aY=a3.children().children('a[href^="profile.html?id="]').attr("href").split("=")[1];aZ=parseInt(a3.children().children(".hitInfl").text().replace(/,/g,""))}a0.IsDefender=a2;a0.Id=aY;a0.Damage=aZ;return a0}function aW(a1,a2){var a0={};var aY=0;var aZ=0;var a3;if(a2==true){a3=$("#top10Defenders"+a1)}else{a3=$("#top10Attackers"+a1)}if((a3.length>0)&&(a3.children().length>0)){aY=a3.children("div").children('a[href^="profile.html?id="]').attr("href").split("=")[1];aZ=parseInt(a3.children("div").children(".hitInfl").text().replace(/,/g,""))}a0.IsDefender=a2;a0.Id=aY;a0.Damage=aZ;return a0}function aH(){var aY=ag(0,2);if(aY==0){J("随机输出在 防守方");return"defender"}else{J("随机输出在 进攻方");return"attacker"}}function aU(aY,aZ){if(aY[0].Damage>aZ[0].Damage){J("防守方第一位伤害较少，选择输出在 防守方");return"defender"}else{if(aY[0].Damage<aZ[0].Damage){J("进攻方第一位伤害较少，选择输出在 进攻方");return"attacker"}else{J("双方第一位伤害相同或无人输出");return aH()}}}function aR(aY,aZ){if(aY[2].Damage>aZ[2].Damage){J("防守方第三位伤害较少，选择输出在 防守方");return"defender"}else{if(aY[2].Damage<aZ[2].Damage){J("进攻方第三位伤害较少，选择输出在 进攻方");return"attacker"}else{J("双方第三位伤害相同或无人输出");return aU(aY,aZ)}}}function aP(aY,aZ){if(aY[9].Damage>aZ[9].Damage){J("防守方第十位伤害较少，选择输出在 防守方");return"defender"}else{if(aY[9].Damage<aZ[9].Damage){J("进攻方第十位伤害较少，选择输出在 进攻方");return"attacker"}else{J("双方第十位伤害相同或无人输出");return aR(aY,aZ)}}}var aS;var aV;if($(".xflagsBig").length>0){aS=$(".xflagsBig:first").attr("class").split(" ").pop();aS=aS.substring(aS.indexOf("-")+1);aV=$(".xflagsBig:last").attr("class").split(" ").pop();aV=aV.substring(aV.indexOf("-")+1)}else{if($(".flags-big").length>0){aS=$(".flags-big:first").attr("class").split(" ").pop();aV=$(".flags-big:last").attr("class").split(" ").pop()}else{if($(".muAvatar").length>0){aS=$(".alliesList.leftList.fightFont").text().trim();aV=$(".alliesList.rightList.fightFont").text().trim()}else{aS="未知";aV="未知"}}}J(aS+" vs "+aV);if((O==true)&&($.inArray(aS,aj)>=0)){J(aS+"是敌人，将为"+aV+"输出");return"attacker"}else{if((O==true)&&($.inArray(aV,aj)>=0)){J(aV+"是敌人，将为"+aS+"输出");return"defender"}else{if((O==true)&&($.inArray(aS,w)>=0)){J(aS+"是盟友，将为"+aS+"输出");return"defender"}else{if((O==true)&&($.inArray(aV,w)>=0)){J(aV+"是盟友，将为"+aV+"输出");return"attacker"}else{if(B<0){return aH()}if(B==0){J("设置输出在 防守方");return"defender"}else{if(B==1){J("设置输出在 进攻方");return"attacker"}else{if(B>=2){var aT=$("#userName").attr("href").split("=")[1];var aQ=[];var aO=[];for(var aN=1;aN<=3;aN++){aQ.push(aK(aN,false));aO.push(aK(aN,true))}for(var aM=4;aM<=10;aM++){aQ.push(aW(aM,false));aO.push(aW(aM,true))}var aX=10;var aL=10;for(var aJ=0;aJ<10;aJ++){if(aT==aQ[aJ].Id){aL=aJ;break}}for(var aI=0;aI<10;aI++){if(aT==aO[aI].Id){aX=aI;break}}if(aX<aL){J("你在防守方输出为第"+(aX+1)+"位，选择输出在 防守方");return"defender"}else{if(aX>aL){J("你在进攻方输出为第"+(aL+1)+"位，选择输出在 进攻方");return"attacker"}else{if(aX<10){if(aQ[aX].Damage<aO[aX].Damage){J("你在双方输出均为第"+(aX+1)+"位，但在防守方伤害较高，选择输出在 防守方");return"defender"}else{if(aQ[aX].Damage>aO[aX].Damage){J("你在双方输出均为第"+(aX+1)+"位，但在进攻方伤害较高，选择输出在 防守方");return"attacker"}else{J("你在双方输出均为第"+(aX+1)+"位，且伤害相同");return aH()}}}else{if(B==2){return aU(aQ,aO)}else{if(B==3){return aR(aQ,aO)}else{if(B==4){return aP(aQ,aO)}else{if(B==5){return aH()}else{return aH()}}}}}}}}else{return aH()}}}}}}}}function ax(){if(I==true){J("等待跳转到工作页");return}if(ak()=="battle"){ap=0;if($(".testDivred").length>0){J("该战场被冻结");l();return}else{if($("#fightButton2").length>0){aq(ar())}else{if($("#fightButton1").length>0){aq("side")}else{l();return}}}}else{l();return}}if(ak()=="battle"){if(h>0){var au=ag(0,100);if(h>au){J("因为概率设置，本次不会清体");aA();return}}if(ae==parseInt($('a[href^="battleStatistics.html?id="]').attr("href").replace("battleStatistics.html?id=",""))){if(A>0){var az=ag(0,100);if(A>az){var aE=aB();var aC=parseInt($("#minutesLimit").text().split(":")[0]);var ay=parseInt($("#secondsLimit").text());if((aC<0)||isNaN(aC)){aC=0}if((ay<0)||isNaN(ay)){ay=0}var aD=aE-(aC*60+ay);if((aE>0)&&(aD<0)&&(aE<v*60)){R=r;P=q;E=m;c=S;var at=ag(s,X);var aF=(aE-at)*1000;J("该场为重要战场，将于 S"+at+" 压秒",1000000);setTimeout(function(){ax()},aF);return}else{J("该场为重要战场，程序将在回合最后"+v+"分钟进行判断");ax();return}}else{J("虽然该场为重要战场，但因为概率设置，本次不进行压秒判断");ax();return}}else{J("虽然该场为重要战场，但是压秒概率为0，将忽略压秒设置");ax();return}}else{ax();return}}else{J("非战场页面");ax();return}}