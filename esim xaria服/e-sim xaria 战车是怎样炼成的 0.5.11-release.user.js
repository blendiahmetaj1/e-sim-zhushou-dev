// ==UserScript==
// @name         e-sim xaria 战车是怎样炼成的
// @namespace    ESX
// @version      0.5.11-release
// @description  xaria服自动双击、自动清空体力，自动清空体力功能需要在战场页才能触发
// @author       Exsper
// @match        http://testura.e-sim.org:8000/*
// @match        https://testura.e-sim.org:8000/*
// @match        http://xaria.e-sim.org/*
// @match        https://xaria.e-sim.org/*
// @require      http://cdn.e-sim.org/js/jquery-1.8.3.min.js
// @grant        GM_addStyle
// @run-at       document-start
// ==/UserScript==

//敬请牢记：如果您安装或使用本插件，就默认您已经承诺：不与任何人在任何场合分享插件的全部或部分内容；不在插件开发群以外的地方讨论插件相关问题或功能；在游戏截图前首先关闭所有插件再截图
//敬请牢记：如果您违背了您的承诺，您将失去所有esim插件未来版本的使用权并可能受到诸多方面的惩罚

//前排提醒：该插件有些特殊功能需要先开启e-sim助手（获取盟友、显示伤害），但如果不需要这些功能也可以脱离e-sim助手独立运行
//前排提醒：在自动寻找战场时，插件不会优先选择盟友场或是重要战场，而是寻找到能打的战场就立即跳转

var t,e=!0,n=!0,a=!0,i=!1,r=0,o=0,l=50,s=1,c=0,u=0,d=!0,p=-1,g=!0,h=!0,f=["China","Taiwan"],m=[],v=!0,x=!0,T=!0,k=!0,y=!0,b="battles.html?countryId=-1&sorting=BY_TOTAL_DAMAGE",F=!0,I=!0,S=4,E=600,A=3e3,D=!1,C=20,B=240,W=-1,H=10,R=50,M=30,w=10,O=0,Q=!1,L=400,j=800,N=0,P=-1,G=5e3;function U(t,e,n){t="ESX-"+t,!0===n?localStorage.setItem(t,JSON.stringify(e.split(","))):localStorage.setItem(t,JSON.stringify(e))}function X(t,e){return t="ESX-"+t,!0===e?t in localStorage?JSON.parse(localStorage.getItem(t)).join(","):null:t in localStorage?JSON.parse(localStorage.getItem(t)):null}function _(t,e){localStorage["ESX-"+t]=e}function q(t){return(t="ESX-"+t)in localStorage?localStorage[t]:null}function z(t){t="ESX-"+t,localStorage.removeItem(t)}function J(t,e){var n=q(t);return null==n?e:"string"==typeof e?n:"number"==typeof e?parseInt(n):"boolean"==typeof e?"true"==n:n}function K(t,e){var n=e-t,a=Math.random()*n+t;return a=parseInt(a,10)}function V(t,e){console.log(t),void 0==e?$.info(t):$.info(t,e)}function Y(){return-1!=document.URL.search("html")?document.URL.match("/([a-zA-Z0-9]+).html")[1]:"index"}function Z(){if(1==a)if(a=!1,r<=0)_("ErrorRefreshedCount",++r),location.reload();else{_("ErrorRefreshedCount",++r);var t=30*(r-1);V("自动攻击出错，"+t+"秒后自动刷新",1e6),setTimeout(function(){location.reload()},1e3*t)}}function tt(){function t(t){var e=!1;return $.ajax({url:t,async:!1,success:function(t){if(2!==$(".time",t).length)return console.log(citizenId,"抓取错误，重新抓取"),void $.ajax(this);e=!($(".testDivred",t).length>0)&&($("#fightButton2",t).length>0||$("#fightButton1",t).length>0)},error:function(t,e){console.log("抓取错误 (",e,")，重新抓取"),$.ajax(this)}}),e}function e(t){var e=!1;return $.ajax({url:t,async:!1,success:function(t){if(2!==$(".time",t).length)return console.log(citizenId,"抓取错误，重新抓取"),void $.ajax(this);var n,a,i,r;n=!1,a=0,i=0,r=$("form[action='travel.html']",t),e=r.length>0&&(a=parseInt(r.children("#countryId").val()),i=parseInt(r.children("#regionId").val()),a>0&&i>0&&$.ajax({url:"travel.html",type:"POST",async:!1,data:{countryId:a,regionId:i,ticketQuality:s},success:function(t){var e=$("div.testDivred",t);1===e.length?V("飞行失败："+e.text().trim()):(V("飞行成功！"),n=!0)},error:function(t,e){console.log("飞行错误 (",e,")")}}),n)},error:function(t,e){console.log("抓取错误 (",e,")，重新抓取"),$.ajax(this)}}),e}function n(t){V("寻找战场："+t);var e=[];return $.ajax({url:t,async:!1,success:function(t){if(2!==$(".time",t).length)return console.log(citizenId,"抓取错误，重新抓取"),void $.ajax(this);$("#battlesTable tr:gt(0)",t).each(function(t,n){var a=$("a[href*='battle.html']",n);if(null==a)return!0;e.push(a.attr("href"))})},error:function(t,e){console.log("抓取错误 (",e,")，重新抓取"),$.ajax(this)}}),console.log("获取到的战场列表:"+e),e}function a(){var e;e=$("#taskButtonFight").length>0&&1==y?n($("#taskButtonFight").children().attr("href")):n(b),1==I&&(e=function(t){for(var e,n,a=t.length;a;e=parseInt(Math.random()*a),n=t[--a],t[a]=t[e],t[e]=n);return t}(e));for(var a=0;a<e.length;a++){var i=t(e[a]);if(console.log(e[a]+":"+i),1==i)return e[a]}return"-1"}function i(){var t=a();"-1"!=t?document.location=t:0==F?(V("未找到可以打的战场，10分钟后重新寻找"),setTimeout(function(){i()},6e5)):(V("未找到可以打的战场，尝试飞行到"+b+"列表里的第一场起义战"),"-1"!=(t=function(){for(var t=n(b),a=0;a<t.length;a++){var i=e(t[a]);if(console.log(t[a]+":"+i),1==i)return t[a]}return"-1"}())?document.location=t:(V("未找到可以飞的起义战，10分钟后重新寻找"),setTimeout(function(){i()},6e5)))}1==k?(V("30秒后开始寻找可以输出的战场"),setTimeout(function(){i()},3e4)):V("该战场当前无法输出")}$.info=function(){var t,e,n,a,i,r;if(1==arguments.length)a=arguments[0],i=1e4;else{if(2!=arguments.length)return;a=arguments[0],i=arguments[1]}return(t=$("#ESXMessageDiv")).css({display:"block"}).append('<div class="esxmsg">'+a+"</div>"),n=t.children("div"),e=n.eq(-1),n.length>10&&n.eq(0).mouseenter(),r=e.width(),e.css({left:-r,opacity:0}).animate({left:0,opacity:1},200,function(){return e.delay(i).animate({left:-r,opacity:0},200,function(){e.remove()})}),n.eq(-1)},function y(){o=parseInt(q("WaitForLoadCount"));if(2!==$(".time").length)return++o<=l?(_("WaitForLoadCount",o),console.log(o+":网页未加载完全，xaria插件等待1秒"),void setTimeout(y,1e3)):(_("WaitForLoadCount",0),void location.reload());var et=$(".time:first").text().match(/-/g);if(null==et||2!=et.length)return++o<=l?(_("WaitForLoadCount",o),console.log(o+":官方脚本还未执行，xaria插件等待0.5秒"),void setTimeout(y,500)):(_("WaitForLoadCount",0),void location.reload());if(""==$("#minutesLimit").text())return++o<=l?(console.log(o+":官方时间还未刷新，xaria插件等待0.5秒"),void setTimeout(y,500)):(_("WaitForLoadCount",0),void location.reload());_("WaitForLoadCount",0);!function(){GM_addStyle(".esxmsg{background-color: #fff;border-left: 4px solid #7ad03a;-webkit-box-shadow: 0 1px 1px 0 rgba(0,0,0,.1);}");$("<div>",{id:"ESXMessageDiv",style:"position:fixed; bottom:5%;"}).appendTo("body")}();!function(){function t(t,e,n,a,i){var r=$("<input>",{type:"checkbox",style:"vertical-align:5px;",id:e}),o=$("<label>",{class:"checkboxlabel",for:e,text:n}),l=q(a);null===l?(_(a,i),r.attr("checked",1==i)):r.attr("checked","true"==l),t.append(r,o),r.click(function(){r.is(":checked")?_(a,!0):_(a,!1)})}function i(t,e,n,a,i,r){for(var o=$("<span>",{style:"padding:3px; margin:3px",text:e}),l=$("<select>",{style:"padding:3px; margin:3px"}).appendTo(o),s=0;s<n.length;s++)$("<option>",{value:n[s],text:a[s]}).appendTo(l);var c=q(i);null===c?(_(i,r),l.val(r)):l.val(c),t.append(o),l.change(function(){_(i,l.val())})}function r(t,e,n,a){var i=$("<input>",{type:"text",id:"ESX-"+n,style:"vertical-align:5px;width:"+e+"px;height:20px;"}).appendTo(t),r=q(n);null===r?(_(n,a),i.val(a)):i.val(r),t.append(i),i.focus(function(){i.css("background-color","#FFFFFF")}),i.blur(function(){""===i.val()&&i.val(a),i.css("background-color","#79FF79"),_(n,i.val())})}function o(t,e,n,a){var i=$("<input>",{type:"text",id:"ESX-"+n,style:"vertical-align:5px;width:"+e+"px;height:20px;"}).appendTo(t),r=X(n,!0);null===r?(U(n,a),i.val(a.join(","))):i.val(r),t.append(i),i.focus(function(){i.css("background-color","#FFFFFF")}),i.blur(function(){""===i.val()&&i.val(a.join(",")),i.css("background-color","#79FF79"),U(n,i.val(),!0)})}var l=$("<li>",{id:"ESXIcon"}).insertBefore($("#userAvatar")),p=$("<a>",{"data-dropdown":"ESXContentDrop",style:"padding:0 5px;",href:"#"}).appendTo(l),y=($("<img>",{align:"absmiddle",class:"smallAvatar",style:"height:36px; width:36px;",src:"http://cdn.e-sim.org/img/eventIcons/battleLostIcon.png"}).appendTo(p),$("#contentDrop").clone().attr("id","ESXContentDrop").empty().insertBefore($("#contentDrop")));y.removeClass("medium"),y.addClass("large"),$("<b>",{text:"xaria 战车是怎样炼成的 "+GM_info.script.version}).appendTo(y),$("<span>",{text:"捐赠",style:"float:right;"}).appendTo(y).click(function(){var t;t=$("<div>",{class:"dwindow",style:"overflow:auto; width:300px; height:380px; display:block; position:absolute; top:50%; left:50%; margin-left: -225px; margin-top: -150px; padding-bottom: 20px; text-align:center;background-color:lightgray;"}).appendTo($("body")),$("<p>e-sim插件开发不易，您的无私奉献是我们努力的肯定与支持，让我们做得更好</p>").appendTo(t),$("<p>QQ钱包</p>").appendTo(t),$("<div></div>").appendTo(t)[0].innerHTML='<img src="https://puu.sh/Ad7wr/10f301077b.png"/>',$("<br>").appendTo(t),$("<button>",{text:"关闭"}).appendTo(t).click(function(){t.remove()})}),$("<div>",{style:"text-align:center;",text:"自动清空体力、自动双击。珍惜账号，慎用自动。设置更改刷新后生效。"}).appendTo(y);var S=$("<table>",{id:"ESXConfig",style:"width:100%;line-height:30px"}).appendTo(y),N=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(S),J=$("<td>").appendTo(N);t(J,"IsRunCheckbox","启用该插件","IsRunning",e),t(J,"EnableWorkTrainCheckbox","启用双击功能","EnableWorkTrain",n),t(J,"EnableAutoFightCheckbox","启用打枪功能","EnableAutoFight",a),N=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(S),i(J=$("<td>").appendTo(N),"输出使用武器：",[0,1,2,3,4,5],["拳头","Q1","Q2","Q3","Q4","Q5"],"FightWeaponQuality",c),t(J,"FightByHitOnlyCheckbox","不使用连击","FightByHitOnly",D),i(J,"超出次数则使用空手：",[-1,0,1,2,3,4,5,6,7,8,9,10],["不限制","0","1","2","3","4","5","6","7","8","9","10"],"MaxHitUsingWeapon",P),N=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(S),i(J=$("<td>").appendTo(N),"可以打两边时选择输出方：",[-1,0,1,2,3,4],["随机","防守方","进攻方","尽量拿到top1","尽量拿到top3","尽量拿到top10"],"FightDefaultSide",u),t(J,"FightForAllyCheckbox","起义场优先打盟友方或对抗敌方","FightForAlly",h),N=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(S),J=$("<td>").appendTo(N),$("<span>",{text:"设置盟友（以半角逗号分隔）："}).appendTo(J),o(J,400,"Allies",f),N=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(S),J=$("<td>").appendTo(N),$("<span>",{text:"设置敌国（以半角逗号分隔）："}).appendTo(J),o(J,400,"Enemies",m),N=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(S),J=$("<td>").appendTo(N),$("<button>",{text:"从E-sim助手获取盟友和敌国"}).appendTo(J).click(function(){!function(t){if($("#Eh2Homeland").length>0){if((f=[]).push($("#Eh2Homeland").children("div").attr("title")),"true"==q("EHAllies"))for(var e=$("#Eh2Allies").children("div"),n=0;n<e.length;n++)f.push(e[n].title);if("true"==q("EHCoalition"))for(var a=$("#Eh2CoalitionMembers").children("div"),i=0;i<a.length;i++)f.push(a[i].title);U("Allies",f=$.unique(f.sort())),t.val(f.join(",")),V("获取到盟友："+f)}else V("e-sim助手未运行或版本不兼容")}($("#ESX-Allies")),function(t){if($("#Eh2Homeland").length>0){if(m=[],"true"==q("EHEnemies"))for(var e=$("#Eh2Enemies").children("div"),n=0;n<e.length;n++)m.push(e[n].title);U("Enemies",m),t.val(m.join(",")),V("获取到敌人："+m)}else V("e-sim助手未运行或版本不兼容")}($("#ESX-Enemies"))}),t(J,"EHAlliesCheckbox","获取盟友","EHAllies",v),t(J,"EHCoalitionCheckbox","获取联盟成员国","EHCoalition",T),t(J,"EHEnemiesCheckbox","获取敌国","EHEnemies",x),N=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(S),J=$("<td>").appendTo(N),N=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(S),J=$("<td>").appendTo(N),$("<span>每次攻击间隔（毫秒）：</span>").appendTo(J),r(J,60,"FightWaitMin",E),$("<span> 到 </span>").appendTo(J),r(J,60,"FightWaitMax",A),$("<span>打枪请求超时限制：</span>").appendTo(J),r(J,60,"AjaxTimeout",G),$("<span>毫秒</span>").appendTo(J),$("<button>",{text:"Ping一下"}).appendTo(J).click(function(){$.ping=function(t){var e,n,a;if($.ajax({url:t.url,type:"GET",dataType:"html",timeout:1e4,beforeSend:function(){t.beforePing&&t.beforePing(),n=(new Date).getTime()},complete:function(){a=(new Date).getTime(),e=Math.abs(n-a),t.afterPing&&t.afterPing(e)}}),t.interval&&t.interval>0){var i=1e3*t.interval;setTimeout(function(){$.ping(t)},i)}},$.ping({url:"http://xaria.e-sim.org",afterPing:function(t){V("延迟： "+t+" 毫秒")}})}),N=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(S),J=$("<td>").appendTo(N),$("<span>清空体力后下次刷新额外延时（秒）：</span>").appendTo(J),r(J,60,"NextRefreshExtendWaitMin",C),$("<span> 到 </span>").appendTo(J),r(J,60,"NextRefreshExtendWaitMax",B),N=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(S),J=$("<td>").appendTo(N),$("<span>若下次清体时回合剩余时间小于"+H+"分钟，则有</span>").appendTo(J),r(J,20,"AFCTiggerProbability",R),$("<span>%的概率在回合结束前S</span>").appendTo(J),r(J,20,"AFCRefreshInTimeLeftMax",M),$("<span>到S</span>").appendTo(J),r(J,20,"AFCRefreshInTimeLeftMin",w),$("<span>之间（压秒）</span><br/>").appendTo(J),$("<span>每次攻击间隔（毫秒）：</span>").appendTo(J),r(J,60,"AFCFightWaitMin",L),$("<span> 到 </span>").appendTo(J),r(J,60,"AFCFightWaitMax",j),i(J,"使用武器：",[0,1,2,3,4,5],["拳头","Q1","Q2","Q3","Q4","Q5"],"AFCFightWeaponQuality",O),t(J,"AFCFightByHitOnlyCheckbox","不使用连击","AFCFightByHitOnly",Q),$("<br/>").appendTo(J),$("<button>",{text:"设置当前战场为重要战场"}).appendTo(J).click(function(){_("AFCTargetBattleID",W=parseInt($('a[href^="battleStatistics.html?id="]').attr("href").replace("battleStatistics.html?id=",""))),V("设置战场 "+W+" 为重要战场")}),$("<button>",{text:"清除重要战场"}).appendTo(J).click(function(){_("AFCTargetBattleID",W=-1),V("已清除记录的重要战场")}),N=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(S),i(J=$("<td>").appendTo(N),"工作飞行使用机票：",[1,2,3,4,5],["Q1","Q2","Q3","Q4","Q5"],"FlightTicketQuality",s),t(J,"BackToRegionCheckbox","双击后飞回原所在地（请确保机票足够）","BackToRegion",d),t(J,"BackToBattleCheckbox","双击后回到原战场","BackToBattle",g),N=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(S),t(J=$("<td>").appendTo(N),"AutoSearchBattleCheckbox","战场页没有输出按钮时自动寻找第一个可输出战场","AutoSearchBattle",k),t(J,"AutoFlyToBattleCheckbox","如果找不到战场则飞向第一个起义战地区","AutoFlyToBattle",F),N=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(S),t(J=$("<td>").appendTo(N),"SearchBattleShuffleCheckbox","打乱战场列表，以避免总是选择第一个可输出战场","SearchBattleShuffle",I),N=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(S),J=$("<td>").appendTo(N),$("<span>",{text:"搜寻战场列表地址："}).appendTo(J),r(J,400,"SearchBattleUrl",b),N=$("<tr>",{style:"background-color:DarkSlateGray;"}).appendTo(S),J=$("<td>").appendTo(N),$("<button>",{text:"测试搜寻战场"}).appendTo(J).click(function(){b=q("SearchBattleUrl"),tt()}),$("<button>",{text:"重置双击设置",title:"如果因双击错误导致无法自动输出，请点击此按钮"}).appendTo(J).click(function(){z("IsWorkingTraining"),z("OriginRegionId"),z("OriginBattleUrl")}),$("<button>",{text:"重置所有设置",title:"插件运行遇到问题？尝试重置插件吧"}).appendTo(J).click(function(){z("IsRunning"),z("EnableWorkTrain"),z("EnableAutoFight"),z("IsWorkingTraining"),z("FlightTicketQuality"),z("ErrorRefreshedCount"),z("BackToRegion"),z("OriginRegionId"),z("BackToBattle"),z("OriginBattleUrl"),z("FightForAlly"),z("Allies"),z("Enemies"),z("EHAllies"),z("EHEnemies"),z("EHCoalition"),z("FightWeaponQuality"),z("FightWaitMin"),z("FightWaitMax"),z("NextRefreshExtendWaitMin"),z("NextRefreshExtendWaitMax"),z("AFCTiggerProbability"),z("AFCRefreshInTimeLeftMax"),z("AFCRefreshInTimeLeftMin"),z("AFCTargetBattleID"),z("AFCFightWeaponQuality"),z("AFCFightByHitOnly"),z("AFCFightWaitMin"),z("AFCFightWaitMax"),z("FightByHitOnly"),z("HitUsingWeapon"),z("MaxHitUsingWeapon"),z("FightDefaultSide"),z("AutoSearchBattle"),z("SearchBattleUrl"),z("AutoFlyToBattle"),z("SearchBattleShuffle"),z("AjaxTimeout")})}();e=J("IsRunning",e),n=J("EnableWorkTrain",n),a=J("EnableAutoFight",a),i=J("IsWorkingTraining",i),s=J("FlightTicketQuality",s),r=J("ErrorRefreshedCount",r),d=J("BackToRegion",d),p=J("OriginRegionId",p),g=J("BackToBattle",g),t=J("OriginBattleUrl",t),h=J("FightForAlly",h),f=X("Allies"),m=X("Enemies"),v=J("EHAllies",v),x=J("EHEnemies",x),T=J("EHCoalition",T),c=J("FightWeaponQuality",c),E=J("FightWaitMin",E),A=J("FightWaitMax",A),C=J("NextRefreshExtendWaitMin",C),B=J("NextRefreshExtendWaitMax",B),R=J("AFCTiggerProbability",R),M=J("AFCRefreshInTimeLeftMax",M),w=J("AFCRefreshInTimeLeftMin",w),W=J("AFCTargetBattleID",W),O=J("AFCFightWeaponQuality",O),Q=J("AFCFightByHitOnly",Q),L=J("AFCFightWaitMin",L),j=J("AFCFightWaitMax",j),D=J("FightByHitOnly",D),N=J("HitUsingWeapon",N),P=J("MaxHitUsingWeapon",P),u=J("FightDefaultSide",u),k=J("AutoSearchBattle",k),b=J("SearchBattleUrl",b),F=J("AutoFlyToBattle",F),I=J("SearchBattleShuffle",I),G=J("AjaxTimeout",G);if(0==e)return void V("xaria插件未启动");if(1==n){if(1==d&&"battle"==Y()){var nt=$('a[href^="region.html?id="][href!="region.html?id="]'),at=parseInt(nt.first().attr("href").split("=")[1]);_("OriginRegionId",at)}1==g&&"battle"==Y()&&_("OriginBattleUrl",location.href),function(){function e(){var e=$("#trainButton");e.length<=0?(n=!1,_("EnableWorkTrain",!1),i=!1,_("IsWorkingTraining",!1),alert("错误：未训练却没有训练按钮，已自动关闭双击功能")):$.ajax({type:"POST",url:"train/ajax",data:null,success:function(e){var r=$("#trainButton",e);r.length<1&&$("#userMenu",e).length<1?function(){if(i=!1,_("IsWorkingTraining","false"),1==d){var e,n=$('a[href^="region.html?id="][href!="region.html?id="]'),r=parseInt(n.first().attr("href").split("=")[1]);-1!=p&&r!=p&&(V("飞回地区："+p),$.ajax({url:"region.html?id="+p,async:!1,success:function(t){e=parseInt($("#countryId",t).val())},error:function(t,e){console.log("地区页抓取错误 (",e,")，重新抓取"),$.ajax(this)}}),$.ajax({url:"travel.html",type:"POST",async:!1,data:{countryId:e,regionId:p,ticketQuality:s},success:function(t){var e=$("div.testDivred",t);1===e.length?V("飞行失败："+e.text().trim()):V("飞行成功！")},error:function(t,e){console.log("飞行错误 (",e,")")}}))}1==g?(V("返回战场："+t),document.location=t):1==a&&1==k?tt():V("双击结束，等待下次双击")}():(n=!1,_("EnableWorkTrain",!1),i=!1,_("IsWorkingTraining",!1),alert("错误：训练失败，已自动关闭双击功能")),$("#trainReload").html(e)}})}function r(t){i=!0,_("IsWorkingTraining","true"),1==t?setTimeout(function(){document.location="/work.html"},3e4):document.location="/work.html"}!function(){if(0==i){if($("#taskButtonWork").length>0||$("#taskButtonTrain").length>0){var t=parseFloat($("#actualHealth").html()),a=50-10*s;1==d?t-2*a>=0?r(!1):(V("可能由于人工操作，你当前的体力不足以飞行两次，程序将于30秒后再自动双击，请尽快补充体力"),r(!0)):t-a>=0?r(!1):(V("可能由于人工操作，你当前的体力不足以飞行到工作地，程序将于30秒后再自动双击，请尽快补充体力"),r(!0))}}else{var o=Y();if("work"==o)!function(){if($("#workButton").length<1)n=!1,_("EnableWorkTrain",!1),i=!1,_("IsWorkingTraining",!1),alert("错误：未工作却没有工作按钮，已自动关闭双击功能");else{var t=$('a[href^="region.html?id="][href!="region.html?id="]'),e=t.first().parent().find("div").attr("class");e=e.substring(e.indexOf("-")+1);var a=t.last().parent().find("div").attr("class");a=a.substring(a.indexOf("-")+1),e==a?$.ajax({type:"POST",url:"work/ajax?action=work",data:null,success:function(t){$("#workReload").html(t);var e=$("#workButton",t);e.length<1&&$("#userMenu",t).length<1?document.location="/train.html":(n=!1,_("EnableWorkTrain",!1),i=!1,_("IsWorkingTraining",!1),alert("错误：工作失败，已自动关闭双击功能"))}}):document.location=t.last().attr("href")}}();else if("train"==o)e();else if("region"==o)$("#ticketQuality").val(s),$(".travel.button.foundation-style")[0].click();else{if("travel"!=o)return void _("IsWorkingTraining",!1);$(".testDivred").length>0?(n=!1,_("EnableWorkTrain",!1),i=!1,_("IsWorkingTraining",!1),alert("飞行出错："+$(".testDivred :last")[0].childNodes[1].nodeValue+"，已自动关闭双击功能")):document.location="/work.html"}}}()}()}if(1==a&&"battle"==Y())return void setTimeout(function(){!function(){var t=0;function e(e,n){var a=function(){{if(P<0){if(_("HitUsingWeapon",++N),c<=0)return 0;var t=parseInt($("#Q"+c+"WeaponStock").text());return t<=0?0:c}if(N>=P)return 0;if(_("HitUsingWeapon",++N),c<=0)return 0;var e=parseInt($("#Q"+c+"WeaponStock").text());return e<=0?0:c}}();a>=0&&a<=5||(a=0),console.log("使用Q"+a+"，side="+e+"，value="+n);var i="weaponQuality="+a+"&battleRoundId="+$("#battleRoundId").val()+"&side="+e+"&value="+n;$.ajax({type:"POST",url:"fight.html",timeout:G,data:i,success:function(e){$("#fightResponse > div").replaceWith(e),$("#showMsg").length>0&&function(t){var e=$("#showMsg");e.text(""),e.show();var n=$("#DamageDone",t);if(n.length>0){for(var a=parseInt(n.text().replace(/,/g,"").replace(/\xA0/g,"")),i=$(".fightsprite",n.parent().parent()),r={bomb:["grey","无暴击(pain dealer)"],tank:["grey","无坦克(tank)"],syringe:["grey","无类固醇(steroid)"],airplane:["grey","无地点加成"],bookmark:["grey","无军令加成"]},o={absorbed:["loved",["lightgreen","闪避(avoid)"]],mu:["bookmark",["lightgreen","有军令加成"]],location:["airplane",["lightgreen","有地点加成"]],STEROIDSplus:["syringe",["lightgreen","有类固醇(steroid)"]],STEROIDSminus:["syringe",["pink","类固醇副作用(steroid)"]],TANKplus:["tank",["lightgreen","有坦克(tank)"]],TANKminus:["tank",["pink","坦克副作用(tank)"]],xp1:["xp",1],xp5:["xp",5],PAIN_DEALER_1_Hplus:["bomb",["lightgreen","1小时暴击(pain dealer)"]],PAIN_DEALER_10_Hplus:["bomb",["lightgreen","10小时暴击(pain dealer)"]],PAIN_DEALER_25_Hplus:["bomb",["lightgreen","25小时暴击(pain dealer)"]]},l=0;l<i.length;++l){var s=i.eq(l).attr("class").split(" ").pop();if(s in o){var c=o[s];r[c[0]]=c[1]}}var u="",d=r.xp;delete r.xp;for(l in r)u='<i style="color:'+r[l][0]+';" class="icon-'+l+'" title="'+r[l][1]+'"></i>'+u;u+='<b title="'+d+'次攻击">x'+d+"</b>";var p=$("#fightHistory"),g=$("div[class^=foundation-style]",p);6===g.length&&$("#ehHistoryExpand").show(),g.slice(0,2).attr("style","opacity:0.6;"),g.slice(2,4).attr("style","opacity:0.3;"),!1===$("#ehHistoryExpand").is(":hidden")&&g.slice(4,6).hide();var h=-1!==$("#fightResult>div").attr("class").split(" ").pop().indexOf("critical");h?p.prepend($("<div>",{class:"foundation-style small-6 columns foundation-text-right",html:u}),$("<div>",{class:"foundation-style small-4 columns foundation-text-right critical",text:n.text()})):p.prepend($("<div>",{class:"foundation-style small-6 columns foundation-text-right",html:u}),$("<div>",{class:"foundation-style small-4 columns foundation-text-right",text:n.text()})),$("#ehHitsNumber").text(parseInt($("#ehHitsNumber").text())+d),$("#ehTotalDamage").text((parseInt($("#ehTotalDamage").text().replace(/,/g,"").replace(/\xA0/g,""))+a).toString().replace(/\B(?=(\d{3})+(?!\d))/g,","))}else e.text($("#fightResponse").text().trim()),e.fadeOut(2e3)}($(e));var n=$("#healthUpdate",e).text();if(""!==n){var a=n.substr(0,n.length-3);a<100&&$("#healthProgress div.ui-corner-right").removeClass("ui-corner-right"),$("#healthProgress .ui-progressbar-value").animate({width:a+"%"},{queue:!1}),$("#healthProgress").attr("title",a+" / 100"),$("#actualHealth").html(a);var i=$("#DamageDone",e);i.length<0?(console.log($("#fightResponse").text().trim()),++t>S&&Z()):(t>0&&(t=0),r>0&&(r=0,_("ErrorRefreshedCount",0)))}else t++,V("攻击出错："+$("#fightResponse").text().trim()+"("+t+")"),t>S&&Z()},error:function(e,n,a){return t++,V("timeout"==n?"攻击出错：超时("+t+")":"攻击出错：错误码"+e.status+"("+t+")"),t>S&&Z(),!1}})}function n(t){if(0!=a){var i,r=parseFloat($("#actualHealth").html());if(r>=10)i=K(E,A),r>=50&&0==D?(e(t,"Berserk"),V(i+"ms后连击"),setTimeout(function(){n(t)},i)):(e(t,"undefined"),V(i+"ms后单击"),setTimeout(function(){n(t)},i));else{_("HitUsingWeapon",0);var o=parseInt($("#minutesLimit").text().split(":")[0]),l=parseInt($("#secondsLimit").text());(o<0||isNaN(o))&&(o=0),(l<0||isNaN(l))&&(l=0),i=K(1e3*(60*o+l+C),1e3*(60*o+l+B)),V("将于 "+function(t){var e=t.getHours(),n=t.getMinutes(),a=t.getSeconds(),i="";e<10&&(i+="0");i+=e+":",n<10&&(i+="0");i+=n+":",a<10&&(i+="0");return i+=a}(new Date(Date.now()+i))+" 刷新",1e6),setTimeout(function(){location.reload()},i)}}else V("打枪功能未启用或已暂停")}function o(){1!=i?"battle"==Y()?(t=0,$(".testDivred").length>0?(V("该战场被冻结"),tt()):$("#fightButton2").length>0?n(function(){function t(t,e){var n,a={},i=0,r=0;return(n=1==e?$("#topDefender"+t):$("#topAttacker"+t)).length>0&&n.children().length>0&&(i=n.children().children('a[href^="profile.html?id="]').attr("href").split("=")[1],r=parseInt(n.children().children(".hitInfl").text().replace(/,/g,""))),a.IsDefender=e,a.Id=i,a.Damage=r,a}function e(t,e){var n,a={},i=0,r=0;return(n=1==e?$("#top10Defenders"+t):$("#top10Attackers"+t)).length>0&&n.children().length>0&&(i=n.children("div").children('a[href^="profile.html?id="]').attr("href").split("=")[1],r=parseInt(n.children("div").children(".hitInfl").text().replace(/,/g,""))),a.IsDefender=e,a.Id=i,a.Damage=r,a}function n(){var t=K(0,2);return 0==t?(V("随机输出在 防守方"),"defender"):(V("随机输出在 进攻方"),"attacker")}function a(t,e){return t[0].Damage>e[0].Damage?(V("防守方第一位伤害较少，选择输出在 防守方"),"defender"):t[0].Damage<e[0].Damage?(V("进攻方第一位伤害较少，选择输出在 进攻方"),"attacker"):(V("双方第一位伤害相同或无人输出"),n())}function i(t,e){return t[2].Damage>e[2].Damage?(V("防守方第三位伤害较少，选择输出在 防守方"),"defender"):t[2].Damage<e[2].Damage?(V("进攻方第三位伤害较少，选择输出在 进攻方"),"attacker"):(V("双方第三位伤害相同或无人输出"),a(t,e))}var r,o;$(".xflagsBig").length>0?(r=(r=$(".xflagsBig:first").attr("class").split(" ").pop()).substring(r.indexOf("-")+1),o=(o=$(".xflagsBig:last").attr("class").split(" ").pop()).substring(o.indexOf("-")+1)):$(".flags-big").length>0?(r=$(".flags-big:first").attr("class").split(" ").pop(),o=$(".flags-big:last").attr("class").split(" ").pop()):$(".muAvatar").length>0?(r=$(".alliesList.leftList.fightFont").text().trim(),o=$(".alliesList.rightList.fightFont").text().trim()):(r="未知",o="未知");{if(V(r+" vs "+o),1==h&&$.inArray(r,m)>=0)return V(r+"是敌人，将为"+o+"输出"),"attacker";if(1==h&&$.inArray(o,m)>=0)return V(o+"是敌人，将为"+r+"输出"),"defender";if(1==h&&$.inArray(r,f)>=0)return V(r+"是盟友，将为"+r+"输出"),"defender";if(1==h&&$.inArray(o,f)>=0)return V(o+"是盟友，将为"+o+"输出"),"attacker";if(u<0)return n();if(0==u)return V("设置输出在 防守方"),"defender";if(1==u)return V("设置输出在 进攻方"),"attacker";if(u>=2){for(var l=$("#userName").attr("href").split("=")[1],s=[],c=[],d=1;d<=3;d++)s.push(t(d,!1)),c.push(t(d,!0));for(var p=4;p<=10;p++)s.push(e(p,!1)),c.push(e(p,!0));for(var g=10,v=10,x=0;x<10;x++)if(l==s[x].Id){v=x;break}for(var T=0;T<10;T++)if(l==c[T].Id){g=T;break}return g<v?(V("你在防守方输出为第"+(g+1)+"位，选择输出在 防守方"),"defender"):g>v?(V("你在进攻方输出为第"+(v+1)+"位，选择输出在 进攻方"),"attacker"):g<10?s[g].Damage<c[g].Damage?(V("你在双方输出均为第"+(g+1)+"位，但在防守方伤害较高，选择输出在 防守方"),"defender"):s[g].Damage>c[g].Damage?(V("你在双方输出均为第"+(g+1)+"位，但在进攻方伤害较高，选择输出在 防守方"),"attacker"):(V("你在双方输出均为第"+(g+1)+"位，且伤害相同"),n()):2==u?a(s,c):3==u?i(s,c):4==u?function(t,e){return t[9].Damage>e[9].Damage?(V("防守方第十位伤害较少，选择输出在 防守方"),"defender"):t[9].Damage<e[9].Damage?(V("进攻方第十位伤害较少，选择输出在 进攻方"),"attacker"):(V("双方第十位伤害相同或无人输出"),i(t,e))}(s,c):n()}return n()}}()):$("#fightButton1").length>0?n("side"):tt()):tt():V("等待跳转到工作页")}{if("battle"==Y()&&W==parseInt($('a[href^="battleStatistics.html?id="]').attr("href").replace("battleStatistics.html?id=",""))){if(R>0){var l=K(0,100);if(R>l){var s=3==(T=$("#roundCountdown").children().text().split(":")).length?3600*parseInt(T[0])+60*parseInt(T[1])+parseInt(T[2]):-1,d=parseInt($("#minutesLimit").text().split(":")[0]),p=parseInt($("#secondsLimit").text());(d<0||isNaN(d))&&(d=0),(p<0||isNaN(p))&&(p=0);var g=s-(60*d+p);if(s>0&&g<0&&s<60*H){c=O,D=Q,E=L,A=j;var v=K(w,M),x=1e3*(s-v);return V("该场为重要战场，将于 S"+v+" 压秒",1e6),void setTimeout(function(){o()},x)}return V("该场为重要战场，程序将在回合最后"+H+"分钟进行判断"),void o()}return V("虽然该场为重要战场，但因为概率设置，本次不进行压秒"),void o()}return V("虽然该场为重要战场，但是压秒概率为0，将忽略压秒设置"),void o()}return void o()}var T}()},2e3)}(),setTimeout(function(){location.reload()},18e5)